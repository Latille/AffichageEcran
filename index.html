<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestion Affichage Publicitaire</title>
    
    <!-- PWA Configuration -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestion Affichage">
    <meta name="theme-color" content="#667eea">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-logo {
            font-size: 20px;
        }

        .header h1 {
            font-size: 18px;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .user-initials {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 70px;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .tab-icon {
            font-size: 16px;
        }

        .tab-text {
            font-size: 10px;
        }

        .tab-content {
            display: none;
            padding: 20px;
            height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        #dashboard {
            padding-top: 0px !important;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: 1fr 80px 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            height: 140px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .stat-card.notification-card {
            grid-row: 1 / -1;
            grid-column: 2;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            padding: 20px 8px;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            min-height: 140px;
        }

        .stat-card.notification-pending {
            background: linear-gradient(135deg, #ff8800 0%, #ff4444 100%) !important;
            color: white !important;
            animation: pulse 2s infinite;
            cursor: pointer !important;
            box-shadow: 0 8px 25px rgba(255, 136, 0, 0.4) !important;
        }

        .stat-card.notification-pending:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 12px 30px rgba(40, 167, 69, 0.6) !important;
        }

        .stat-card.notification-pending:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 12px 30px rgba(255, 71, 87, 0.6) !important;
        }

        .stat-card.notification-hidden {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: white !important;
            cursor: default !important;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4) !important;
        }

        .stat-card.notification-hidden:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .notification-card h3 {
            font-size: 18px;
            margin: 0;
            transform: rotate(90deg);
            white-space: nowrap;
        }

        .notification-card p {
            font-size: 10px;
            margin: 8px 0 0 0;
            transform: rotate(90deg);
            white-space: nowrap;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 12px;
            opacity: 0.9;
        }

        .recent-items {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .recent-items h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            min-height: 30px;
            background: linear-gradient(135deg, #fef7ff 0%, #fdf2f8 100%);
            color: #333;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .item:nth-child(even) {
            background: linear-gradient(135deg, #f8faff 0%, #f1f5f9 100%);
        }

        .item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            color: white;
        }

        .item-info {
            flex: 1;
        }

        .item-info h4 {
            font-size: 14px;
            margin-bottom: 3px;
            color: #333;
        }

        .item-info p {
            font-size: 12px;
            color: #666;
        }

        .item-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .item-actions-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn {
            background: #e3f2fd;
            color: #1976d2;
        }

        .edit-btn:hover {
            background: #1976d2;
            color: white;
            transform: scale(1.1);
        }

        .delete-btn {
            background: #ffebee;
            color: #d32f2f;
        }

        .delete-btn:hover {
            background: #d32f2f;
            color: white;
            transform: scale(1.1);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .status-a-creer {
            background: #fff3cd;
            color: #856404;
        }

        .status-programmee {
            background: #d4edda;
            color: #155724;
        }

        .status-en-diffusion {
            background: #cce5ff;
            color: #004085;
        }

        .status-archivee {
            background: #f8d7da;
            color: #721c24;
        }

        .category-fruits { background: #4CAF50; }
        .category-traiteur { background: #FF9800; }
        .category-boucherie { background: #F44336; }
        .category-cremerie { background: #2196F3; }
        .category-epicerie { background: #9C27B0; }
        .category-boulangerie { background: #FF5722; }
        .category-autre { background: #607D8B; }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
        }

        .search-bar::after {
            content: "üîç";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .filter-section h4 {
            margin-bottom: 12px;
            font-size: 14px;
            color: #333;
        }

        .filter-buttons {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .filter-btn, .filter-btn-affiches {
            padding: 6px 8px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: capitalize;
            white-space: nowrap;
        }

        .filter-btn.active, .filter-btn-affiches.active,
        .filter-btn:hover, .filter-btn-affiches:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .item.hidden {
            display: none;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 16px;
            border-radius: 12px;
            max-width: 90%;
            width: 350px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .form-row .form-group {
            margin-bottom: 12px;
        }

        .form-row .form-group label {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .form-row .form-group input,
        .form-row .form-group select {
            padding: 7px 8px;
            font-size: 13px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .alert-error {
            background: #ffebee;
            border: 1px solid #f8bbd9;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            color: #2e7d2e;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .params-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .params-tab {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            border-right: 1px solid #e9ecef;
        }

        .params-tab:last-child {
            border-right: none;
        }

        .params-tab.active {
            background: #667eea;
            color: white;
        }

        .params-tab-icon {
            font-size: 16px;
        }

        .params-content {
            display: none;
        }

        .params-content.active {
            display: block;
        }

        .param-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }

        .param-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .param-item:last-child {
            margin-bottom: 0;
        }

        .param-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .param-actions {
            display: flex;
            gap: 8px;
        }

        .add-param-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 50%; /* R√©duction de 20% par rapport √† la largeur pleine */
        }

        .users-action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .logout-btn-users {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 50%; /* M√™me largeur que le bouton inviter */
        }

        .add-param-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .logout-btn-users:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .empty-params {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px 20px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        .agenda-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .week-info {
            text-align: center;
        }

        .week-info h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .week-info p {
            margin: 2px 0 0 0;
            font-size: 12px;
            color: #666;
            font-weight: 400;
        }

        .planning-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .planning-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            min-height: 40px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            border-left: 4px solid transparent;
        }

        .planning-item.status-a-creer {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
        }

        .planning-item.status-programmee {
            border-left-color: #fd7e14;
            background: linear-gradient(135deg, #fff8f1 0%, #fef3e2 100%);
        }

        .planning-item.status-en-diffusion {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%);
        }

        .planning-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            color: white;
        }

        .planning-item-info {
            flex: 1;
        }

        .planning-item-info h4 {
            font-size: 14px;
            margin-bottom: 3px;
            color: #333;
        }

        .planning-item-info p {
            font-size: 12px;
            color: #666;
        }

        .planning-item-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .planning-item-actions-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .planning-status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .planning-status-badge.status-a-creer {
            background: #dc3545;
            color: white;
        }

        .planning-status-badge.status-programmee {
            background: #fd7e14;
            color: white;
        }

        .planning-status-badge.status-en-diffusion {
            background: #28a745;
            color: white;
        }

        .nav-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .settings-card h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info h5 {
            margin: 0 0 4px 0;
            font-size: 14px;
            color: #333;
        }

        .setting-info p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .user-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .user-main-info {
            flex: 1;
            margin-left: 15px;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .user-email {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .user-role {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .user-role.admin {
            background: #fff3e0;
            color: #f57c00;
        }

        .user-preferences {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .user-pref-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .notification-prefs {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .pref-option {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .pref-icon {
            font-size: 14px;
        }

        .pref-icon.active {
            color: #28a745;
        }

        .pref-icon.inactive {
            color: #dc3545;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-status {
            margin-top: 8px;
            font-size: 11px;
            color: #666;
        }

        .status-online {
            color: #28a745;
        }

        .status-offline {
            color: #6c757d;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            font-size: 13px;
            color: #333;
            margin: 0;
        }

        .notification-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .notification-type {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .notification-time {
            font-size: 11px;
            color: #666;
        }

        .notification-message {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .notification-status {
            margin-top: 5px;
            font-size: 10px;
            color: #28a745;
        }

        .notification-status.failed {
            color: #dc3545;
        }

        #loginModal {
            z-index: 2000;
        }

        #loginModal .modal-content {
            width: 320px;
        }

        .test-notification-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .test-notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        }

        .notification-group-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        .notification-group-item h6 {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: #333;
        }

        .notification-group-item p {
            margin: 0;
            font-size: 11px;
            color: #666;
        }

        .notification-group-item .time {
            font-size: 10px;
            color: #999;
            float: right;
        }

        @media screen and (max-width: 420px) {
            .container {
                max-width: 100%;
                box-shadow: none;
            }
            
            .modal-content {
                width: 95%;
                max-width: 350px;
            }
            
            .form-row {
                grid-template-columns: 1fr 1fr !important;
                gap: 6px !important;
            }
        }

        /* Forcer l'alignement horizontal pour le bouton √† notifier */
        #notificationCard {
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            transform: none !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            height: 115px !important;
            max-height: 115px !important;
            min-height: 115px !important;
        }

        #notificationCard div {
            transform: none !important;
        }

    </style>
</head>
<body>
    <!-- Modal de connexion -->
    <div id="loginModal" class="modal" style="display:block;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Connexion</h3>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" name="loginEmail" required placeholder="test@exemple.com">
                </div>

                <div class="form-group">
                    <label for="loginPassword">Mot de passe</label>
                    <input type="password" id="loginPassword" name="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <div id="loginError" class="alert-error" style="display:none;"></div>

                <button type="submit" class="btn">üîì Se connecter</button>
                
                <p style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                    Cr√©ez un compte dans la console Firebase ou utilisez un compte de test
                </p>
            </form>
        </div>
    </div>

    <!-- Application principale -->
    <div id="appContainer" class="container" style="display:none;">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">üì∫</div>
                <h1>Gestion Affichage</h1>
            </div>
            <div class="user-info">
                <div id="currentUserInitials" class="user-initials">UP</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('dashboard')">
                <div class="tab-icon">üìä</div>
                <div class="tab-text">Dashboard</div>
            </div>
            <div class="tab" onclick="showTab('planning')">
                <div class="tab-icon">üìÖ</div>
                <div class="tab-text">Planning</div>
            </div>
            <div class="tab" onclick="showTab('affiches')">
                <div class="tab-icon">üìã</div>
                <div class="tab-text">Affiches</div>
            </div>
            <div class="tab" onclick="showTab('parametres')">
                <div class="tab-icon">‚öôÔ∏è</div>
                <div class="tab-text">Param√®tres</div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-stats" style="position: relative !important; width: 330px !important; height: 140px !important; background: #ffffff !important; border-radius: 18px !important; padding: 10px !important; margin: 5px auto 5px auto !important; box-sizing: border-box !important;">
                <div class="stat-card" style="position: absolute !important; left: 4px !important; top: 15px !important; width: 100px !important; height: 50px !important; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important; color: white !important; border-radius: 12px !important; display: flex !important; flex-direction: column !important; justify-content: center !important; align-items: center !important; border: 2px solid rgba(255, 255, 255, 0.3) !important; box-shadow: 0 5px 15px rgba(240, 147, 251, 0.3) !important;">
                    <div style="font-size: 18px !important; font-weight: bold !important; margin: 0 0 2px 0 !important;" id="statEnDiffusion">0</div>
                    <div style="font-size: 13px !important; margin: 0 !important;">En diffusion</div>
                </div>
                
                <div class="stat-card" style="position: absolute !important; left: 110px !important; top: 15px !important; width: 100px !important; height: 50px !important; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important; color: white !important; border-radius: 12px !important; display: flex !important; flex-direction: column !important; justify-content: center !important; align-items: center !important; border: 2px solid rgba(255, 255, 255, 0.3) !important; box-shadow: 0 5px 15px rgba(240, 147, 251, 0.3) !important;">
                    <div style="font-size: 18px !important; font-weight: bold !important; margin: 0 0 2px 0 !important;" id="statACreer">0</div>
                    <div style="font-size: 13px !important; margin: 0 !important;">√Ä cr√©er</div>
                </div>
                
                <div class="stat-card" style="position: absolute !important; left: 4px !important; top: 75px !important; width: 100px !important; height: 50px !important; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important; color: white !important; border-radius: 12px !important; display: flex !important; flex-direction: column !important; justify-content: center !important; align-items: center !important; border: 2px solid rgba(255, 255, 255, 0.3) !important; box-shadow: 0 5px 15px rgba(240, 147, 251, 0.3) !important;">
                    <div style="font-size: 18px !important; font-weight: bold !important; margin: 0 0 2px 0 !important;" id="statProgrammees">0</div>
                    <div style="font-size: 13px !important; margin: 0 !important;">Programm√©es</div>
                </div>
                
                <div class="stat-card" style="position: absolute !important; left: 110px !important; top: 75px !important; width: 100px !important; height: 50px !important; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important; color: white !important; border-radius: 12px !important; display: flex !important; flex-direction: column !important; justify-content: center !important; align-items: center !important; border: 2px solid rgba(255, 255, 255, 0.3) !important; box-shadow: 0 5px 15px rgba(240, 147, 251, 0.3) !important;">
                    <div style="font-size: 18px !important; font-weight: bold !important; margin: 0 0 2px 0 !important;" id="statArchivees">0</div>
                    <div style="font-size: 13px !important; margin: 0 !important;">Archiv√©es</div>
                </div>
                
                <div id="notificationCard" class="stat-card notification-card notification-hidden" onclick="sendPendingNotifications()" style="position: absolute !important; left: 95px !important; top: 4px !important; width: 80px !important; height: 110px !important; background: rgba(248, 249, 250, 0.5) !important; color: rgba(248, 249, 250, 0.5) !important; border-radius: 12px !important; display: flex !important; flex-direction: column !important; justify-content: center !important; align-items: center !important; border: 3px solid rgba(255, 255, 255, 0.8) !important; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2) !important; cursor: pointer !important; font-size: 12px !important;">
                    <div style="font-size: 18px !important; font-weight: bold !important; margin: 0 0 2px 0 !important;" id="notificationCount">0</div>
                    <div style="font-size: 13px !important; margin: 0 !important;">√† notifier</div>
                </div>
            </div>

            <div class="recent-items" style="margin-top: 5px !important;">
                <h3>üì∫ Affiches en diffusion</h3>
                <div class="empty-state">
                    Aucune affiche en diffusion pour le moment
                </div>
            </div>


            <!-- Champ Version temporaire -->
            <div class="version-info" style="
                background: #f8f9fa; 
                border-radius: 12px; 
                padding: 12px 15px; 
                margin-top: 15px; 
                border-left: 4px solid #667eea;
                box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            ">
                <div style="
                    display: flex; 
                    align-items: center; 
                    justify-content: space-between;
                    font-size: 13px;
                    color: #666;
                ">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">üè∑Ô∏è</span>
                        <span style="font-weight: 600; color: #333;">Version :</span>
                        <span style="
                            background: #667eea; 
                            color: white; 
                            padding: 3px 8px; 
                            border-radius: 12px; 
                            font-size: 12px;
                            font-weight: 500;
                        ">GestionAffiches230725_v7v5 Notif</span>
                    </div>
                    <div style="font-size: 11px; color: #999;">
                        üìù Push Notifications
                    </div>
                </div>
            </div>



        </div>

        <!-- Planning -->
        <div id="planning" class="tab-content">
            <div class="agenda-header">
                <button class="nav-btn" onclick="changeWeek(-1)">‚Äπ</button>
                <div class="week-info">
                    <h3 id="currentWeek">8 - 14 Juillet 2025</h3>
                    <p id="weekNumber">Semaine 28</p>
                </div>
                <button class="nav-btn" onclick="changeWeek(1)">‚Ä∫</button>
            </div>
            
            <div id="planningAffiches" class="planning-container">
                <div class="empty-state">
                    Aucune affiche √† planifier pour le moment
                </div>
            </div>
        </div>

        <!-- Affiches -->
        <div id="affiches" class="tab-content">
            <div class="search-bar">
                <input type="text" placeholder="Rechercher une affiche...">
            </div>
            
            <div class="filter-section">
                <h4>üîç Filtrer par √©tat</h4>
                <div class="filter-buttons">
                    <button class="filter-btn-affiches active" data-filter="all">Tous</button>
                    <button class="filter-btn-affiches" data-filter="a-creer">√Ä cr√©er</button>
                    <button class="filter-btn-affiches" data-filter="programmee">Prog.</button>
                    <button class="filter-btn-affiches" data-filter="en-diffusion">Diff.</button>
                    <button class="filter-btn-affiches" data-filter="archivee">Archiv.</button>
                </div>
            </div>
            
            <div class="empty-state">
                Aucune affiche cr√©√©e pour le moment.<br>
                Cliquez sur le bouton + pour cr√©er votre premi√®re affiche !
            </div>
        </div>

        <!-- Param√®tres -->
        <div id="parametres" class="tab-content">
            <div class="params-tabs">
                <div class="params-tab active" onclick="showParamsTab('origines')">
                    <div class="params-tab-icon">üåç</div>
                    <div>Origines</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('unites')">
                    <div class="params-tab-icon">üè∑Ô∏è</div>
                    <div>Unit√©s</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('notifications')">
                    <div class="params-tab-icon">üîî</div>
                    <div>Notifs</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('users')">
                    <div class="params-tab-icon">üë•</div>
                    <div>Users</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('systeme')">
                    <div class="params-tab-icon">‚öôÔ∏è</div>
                    <div>Syst√®me</div>
                </div>
            </div>

            <!-- Gestion des Origines -->
            <div id="origines-params" class="params-content active">
                <button class="add-param-btn" onclick="openAddOriginModal()">
                    ‚ûï Ajouter une origine
                </button>
                
                <div id="originesList" class="param-list">
                    <div class="empty-params">
                        Aucune origine configur√©e.<br>
                        Cliquez sur "Ajouter une origine" pour commencer.
                    </div>
                </div>
            </div>

            <!-- Gestion des Unit√©s -->
            <div id="unites-params" class="params-content">
                <button class="add-param-btn" onclick="openAddUniteModal()">
                    ‚ûï Ajouter une unit√©
                </button>
                
                <div id="unitesList" class="param-list">
                    <div class="empty-params">
                        Aucune unit√© configur√©e.<br>
                        Cliquez sur "Ajouter une unit√©" pour commencer.
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div id="notifications-params" class="params-content">
                <div class="settings-card">
                    <h4>‚öôÔ∏è Mes pr√©f√©rences de notification</h4>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Cr√©ations d'affiches</h5>
                            <p>Notifier √† chaque cr√©ation</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-creation" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Mises en diffusion</h5>
                            <p>Notifier lors du d√©marrage</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-diffusion" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Notifications d'expiration</h5>
                            <p>Alerter 24h avant expiration</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-expiration" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Archivage automatique</h5>
                            <p>Notifier √† la fin de diffusion</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-archivage" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>R√©sum√© quotidien</h5>
                            <p>Envoi √† 08h00 chaque jour</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-resume" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-card">
                    <h4>üìß Canal de notification pr√©f√©r√©</h4>
                    
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="canal-email" checked>
                            <label for="canal-email">üìß Notifications par email</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="canal-push" checked>
                            <label for="canal-push">üîî Notifications push (navigateur)</label>
                        </div>
                    </div>

                    <button class="test-notification-btn" onclick="testNotification()">
                        üß™ Tester les notifications
                    </button>
                </div>

                <div class="settings-card">
                    <h4>üìà Statistiques des notifications</h4>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Notifications envoy√©es aujourd'hui</h5>
                            <p id="todayNotifications">0 notification(s)</p>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Utilisateurs actifs</h5>
                            <p id="activeUsers">0 utilisateur(s) connect√©(s)</p>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h4>üîî √âtat des notifications push</h4>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Permissions navigateur</h5>
                            <p id="pushPermissionStatus">V√©rification...</p>
                        </div>
                        <button class="test-notification-btn" onclick="handleRequestPushPermission()">
                            üîë Demander l'autorisation
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Support du navigateur</h5>
                            <p id="pushSupportStatus">V√©rification...</p>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h4>üìù Historique des notifications</h4>
                    <div id="notificationHistory">
                        <div class="empty-state">
                            Aucune notification envoy√©e r√©cemment
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users -->
            <div id="users-params" class="params-content">
                <div class="users-action-buttons">
                    <button class="add-param-btn" onclick="openInviteUserModal()">
                        ‚úâÔ∏è Inviter un utilisateur
                    </button>
                    <button class="logout-btn-users" onclick="logoutUser()">
                        üö™ D√©connexion
                    </button>
                </div>

                <div class="settings-card">
                    <h4>üë• Utilisateurs de l'application (Max 6)</h4>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Utilisateurs enregistr√©s</h5>
                            <p id="totalUsers">0 utilisateur(s)</p>
                        </div>
                    </div>
                </div>
                
                <div id="usersList">
                    <div class="empty-state">
                        Aucun utilisateur suppl√©mentaire.<br>
                        Invitez des coll√®gues pour collaborer !
                    </div>
                </div>
            </div>

            <!-- Syst√®me -->
            <div id="systeme-params" class="params-content">
                <div class="settings-card">
                    <h4>üìß Configuration EmailJS</h4>
                    <div class="form-group">
                        <label>Service ID</label>
                        <input type="text" id="emailjs-service" value="service_ec05ih4" readonly>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Template Cr√©ation</label>
                            <input type="text" id="emailjs-template-creation" value="template_nrfn4mh" readonly>
                        </div>
                        <div class="form-group">
                            <label>Template R√©sum√©</label>
                            <input type="text" id="emailjs-template-resume" value="template_j3uluqp" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Public Key *</label>
                        <input type="text" id="emailjs-public-key" placeholder="pk_xxxxxxxx, user_xxxxxxxx ou format alphanum√©rique">
                        <small style="color: #666; font-size: 11px; margin-top: 4px; display: block;">
                            üìç Trouvez votre cl√© sur: <a href="https://dashboard.emailjs.com/admin/account" target="_blank">dashboard.emailjs.com/admin/account</a><br>
                            Formats accept√©s: pk_xxxxx (nouveau), user_xxxxx (ancien), ou format personnalis√© comme "7_WIO6MUc0Lhwi335"
                        </small>
                    </div>
                    <button class="btn" onclick="saveEmailJSConfig()">üíæ Sauvegarder la configuration</button>
                    <button class="test-notification-btn" onclick="testEmailJS()">
                        üîó Tester EmailJS
                    </button>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #17a2b8;">
                        <strong>üí° Aide Configuration:</strong><br>
                        <small style="color: #666;">
                            1. Cr√©ez un compte sur <a href="https://www.emailjs.com" target="_blank">emailjs.com</a><br>
                            2. Ajoutez un service email (Gmail recommand√©)<br>
                            3. Cr√©ez les templates avec les IDs ci-dessus<br>
                            4. Copiez votre Public Key depuis Account ‚Üí General
                        </small>
                    </div>
                </div>

                <div class="settings-card">
                    <h4>üîß Param√®tres syst√®me</h4>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Archivage automatique</h5>
                            <p>Archiver les affiches expir√©es automatiquement</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="auto-archive" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Notifications push</h5>
                            <p>Activer les notifications push pour tous</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="push-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Groupement notifications</h5>
                            <p>Grouper les cr√©ations d'affiches</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="group-notifications" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <button class="fab" onclick="openModal()">+</button>
    </div>

    <!-- Modal de cr√©ation d'affiche -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Nouvelle affiche</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <form id="createForm">
                <div class="form-group">
                    <label for="libelle">Libell√© *</label>
                    <input type="text" id="libelle" name="libelle" placeholder="Ex: Pommes Golden" required>
                </div>

                <div class="form-group">
                    <label for="famille">Famille *</label>
                    <select id="famille" name="famille" required>
                        <option value="">Choisir une famille</option>
                        <option value="fruits-legumes">üçé Fruits & l√©gumes</option>
                        <option value="traiteur">ü•ò Traiteur</option>
                        <option value="boucherie">ü•© Boucherie</option>
                        <option value="cremerie">üßÄ Cr√©merie</option>
                        <option value="epicerie">üõí Epicerie</option>
                        <option value="boulangerie">ü•ñ Boulangerie</option>
                        <option value="autre">üì¶ Autre</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dateDebut">D√©but *</label>
                        <input type="date" id="dateDebut" name="dateDebut" required>
                    </div>
                    <div class="form-group">
                        <label for="dateFin">Fin *</label>
                        <input type="date" id="dateFin" name="dateFin" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="prix">Prix *</label>
                        <input type="number" id="prix" name="prix" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="unite">Unit√© *</label>
                        <select id="unite" name="unite" required>
                            <option value="">Choisir une unit√©</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="origine">Origine *</label>
                    <select id="origine" name="origine" required>
                        <option value="">Choisir une origine</option>
                    </select>
                </div>

                <button type="submit" class="btn">‚úÖ Cr√©er l'affiche</button>
            </form>
        </div>
    </div>

    <!-- Modal d'√©dition d'affiche -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'affiche</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            
            <form id="editForm">
                <input type="hidden" id="editAfficheId" name="editAfficheId">
                
                <div class="form-group">
                    <label for="editLibelle">Libell√© *</label>
                    <input type="text" id="editLibelle" name="editLibelle" placeholder="Ex: Pommes Golden" required>
                </div>

                <div class="form-group">
                    <label for="editFamille">Famille *</label>
                    <select id="editFamille" name="editFamille" required>
                        <option value="">Choisir une famille</option>
                        <option value="fruits-legumes">üçé Fruits & l√©gumes</option>
                        <option value="traiteur">ü•ò Traiteur</option>
                        <option value="boucherie">ü•© Boucherie</option>
                        <option value="cremerie">üßÄ Cr√©merie</option>
                        <option value="epicerie">üõí Epicerie</option>
                        <option value="boulangerie">ü•ñ Boulangerie</option>
                        <option value="autre">üì¶ Autre</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editDateDebut">D√©but *</label>
                        <input type="date" id="editDateDebut" name="editDateDebut" required>
                    </div>
                    <div class="form-group">
                        <label for="editDateFin">Fin *</label>
                        <input type="date" id="editDateFin" name="editDateFin" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPrix">Prix *</label>
                        <input type="number" id="editPrix" name="editPrix" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="editUnite">Unit√© *</label>
                        <select id="editUnite" name="editUnite" required>
                            <option value="">Choisir une unit√©</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editOrigine">Origine *</label>
                    <select id="editOrigine" name="editOrigine" required>
                        <option value="">Choisir une origine</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editStatut">Statut *</label>
                    <select id="editStatut" name="editStatut" required>
                        <option value="a-creer">√Ä cr√©er</option>
                        <option value="programmee">Programm√©e</option>
                        <option value="en-diffusion">En diffusion</option>
                        <option value="archivee">Archiv√©e</option>
                    </select>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <!-- Modal d'invitation d'utilisateur -->
    <div id="inviteUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úâÔ∏è Inviter un utilisateur</h3>
                <span class="close" onclick="closeInviteUserModal()">&times;</span>
            </div>
            
            <form id="inviteUserForm">
                <div class="form-group">
                    <label for="inviteEmail">Email *</label>
                    <input type="email" id="inviteEmail" name="inviteEmail" placeholder="collegue@exemple.com" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="inviteFirstName">Pr√©nom *</label>
                        <input type="text" id="inviteFirstName" name="inviteFirstName" placeholder="Jean" required>
                    </div>
                    <div class="form-group">
                        <label for="inviteLastName">Nom *</label>
                        <input type="text" id="inviteLastName" name="inviteLastName" placeholder="Dupont" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="inviteRole">Fonction *</label>
                    <select id="inviteRole" name="inviteRole" required>
                        <option value="">Choisir une fonction</option>
                        <option value="admin">üëë Administrateur</option>
                        <option value="employee">üë§ Employ√©</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Pr√©f√©rences de notification par d√©faut</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="inviteDefaultEmail" checked>
                            <label for="inviteDefaultEmail">üìß Notifications par email</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="inviteDefaultPush" checked>
                            <label for="inviteDefaultPush">üîî Notifications push</label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">‚úâÔ∏è Envoyer l'invitation</button>
            </form>
        </div>
    </div>

    <!-- Modal d'√©dition d'utilisateur -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'utilisateur</h3>
                <span class="close" onclick="closeEditUserModal()">&times;</span>
            </div>
            
            <form id="editUserForm">
                <input type="hidden" id="editUserId" name="editUserId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editUserFirstName">Pr√©nom *</label>
                        <input type="text" id="editUserFirstName" name="editUserFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserLastName">Nom *</label>
                        <input type="text" id="editUserLastName" name="editUserLastName" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editUserEmail">Email *</label>
                    <input type="email" id="editUserEmail" name="editUserEmail" required readonly>
                </div>

                <div class="form-group">
                    <label for="editUserRole">Fonction *</label>
                    <select id="editUserRole" name="editUserRole" required>
                        <option value="admin">üëë Administrateur</option>
                        <option value="employee">üë§ Employ√©</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Pr√©f√©rences de notification</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifCreation">
                            <label for="editUserNotifCreation">Cr√©ations d'affiches</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifDiffusion">
                            <label for="editUserNotifDiffusion">Mises en diffusion</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifExpiration">
                            <label for="editUserNotifExpiration">Alertes d'expiration</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifArchivage">
                            <label for="editUserNotifArchivage">Archivage automatique</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifResume">
                            <label for="editUserNotifResume">R√©sum√© quotidien</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Canal de notification</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserCanalEmail">
                            <label for="editUserCanalEmail">üìß Email</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserCanalPush">
                            <label for="editUserCanalPush">üîî Push</label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <!-- Modals pour origines et unit√©s -->
    <div id="addOriginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üåç Nouvelle origine</h3>
                <span class="close" onclick="closeAddOriginModal()">&times;</span>
            </div>
            
            <form id="addOriginForm">
                <div class="form-group">
                    <label for="origineName">Nom de l'origine *</label>
                    <input type="text" id="origineName" name="origineName" placeholder="Ex: France, Espagne..." required>
                </div>

                <button type="submit" class="btn">‚úÖ Ajouter</button>
            </form>
        </div>
    </div>

    <div id="editOriginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'origine</h3>
                <span class="close" onclick="closeEditOriginModal()">&times;</span>
            </div>
            
            <form id="editOriginForm">
                <input type="hidden" id="editOriginId" name="editOriginId">
                
                <div class="form-group">
                    <label for="editOrigineName">Nom de l'origine *</label>
                    <input type="text" id="editOrigineName" name="editOrigineName" placeholder="Ex: France, Espagne..." required>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <div id="addUniteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üè∑Ô∏è Nouvelle unit√©</h3>
                <span class="close" onclick="closeAddUniteModal()">&times;</span>
            </div>
            
            <form id="addUniteForm">
                <div class="form-group">
                    <label for="uniteName">Nom de l'unit√© *</label>
                    <input type="text" id="uniteName" name="uniteName" placeholder="Ex: Kg, Pi√®ce, Barquette..." required>
                </div>

                <button type="submit" class="btn">‚úÖ Ajouter</button>
            </form>
        </div>
    </div>

    <div id="editUniteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'unit√©</h3>
                <span class="close" onclick="closeEditUniteModal()">&times;</span>
            </div>
            
            <form id="editUniteForm">
                <input type="hidden" id="editUniteId" name="editUniteId">
                
                <div class="form-group">
                    <label for="editUniteName">Nom de l'unit√© *</label>
                    <input type="text" id="editUniteName" name="editUniteName" placeholder="Ex: Kg, Pi√®ce, Barquette..." required>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, serverTimestamp, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAtZUiFPFrqU-PiMpIOrPIwrjJLv_NsKRU",
            authDomain: "gestion-affichage-publicitaire.firebaseapp.com",
            projectId: "gestion-affichage-publicitaire",
            storageBucket: "gestion-affichage-publicitaire.firebasestorage.app",
            messagingSenderId: "715445646165",
            appId: "1:715445646165:web:4da37e196e6a772f0735dc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.currentUser = null;
        window.currentUserData = null;
        window.origines = [];
        window.unites = [];
        window.users = [];
        window.notifications = [];
        window.pendingNotifications = [];
        window.lastLoadedAffiches = [];
        window.emailJSConfig = {
            serviceId: 'service_ec05ih4',
            templateCreation: 'template_nrfn4mh',
            templateResume: 'template_j3uluqp',
            publicKey: ''
        };

        // Initialiser EmailJS
        function initEmailJS() {
            if (window.emailJSConfig.publicKey) {
                try {
                    const cleanKey = window.emailJSConfig.publicKey.trim();
                    
                    if (cleanKey.startsWith('pk_') || 
                        cleanKey.startsWith('user_') || 
                        /^[A-Za-z0-9_]+$/.test(cleanKey) && cleanKey.length >= 10) {
                        
                        emailjs.init({
                            publicKey: cleanKey,
                        });
                        
                        console.log('‚úÖ EmailJS v4 initialis√© avec la cl√©:', cleanKey.substring(0, 8) + '...');
                    } else {
                        console.log('‚ùå Format de cl√© invalide:', cleanKey);
                        showErrorMessage('‚ùå Format de cl√© EmailJS invalide');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur initialisation EmailJS:', error);
                    showErrorMessage('‚ùå Erreur initialisation EmailJS: ' + error.message);
                }
            } else {
                console.log('‚ö†Ô∏è EmailJS - Cl√© publique manquante');
            }
        }

        // Initialiser les notifications push
        async function initPushNotifications() {
            console.log('üîî Initialisation des notifications push...');
            
            // V√©rifier le support du navigateur
            if (!('Notification' in window)) {
                console.log('‚ùå Ce navigateur ne supporte pas les notifications');
                window.pushConfig.supported = false;
                updatePushUI();
                return false;
            }
            
            window.pushConfig.supported = true;
            
            // V√©rifier les permissions actuelles
            let permission = Notification.permission;
            window.pushConfig.permission = permission;
            
            if (permission === 'default') {
                console.log('‚ö†Ô∏è Permissions notifications non demand√©es');
                updatePushUI();
                return false;
            }
            
            if (permission === 'granted') {
                console.log('‚úÖ Notifications push autoris√©es');
                
                // Enregistrer le Service Worker si support√©
                if ('serviceWorker' in navigator) {
                    await registerServiceWorker();
                }
                
                updatePushUI();
                return true;
            } else {
                console.log('‚ùå Notifications push refus√©es');
                
                // D√©sactiver automatiquement les pr√©f√©rences push
                await updateUserPushPreference(false);
                updatePushUI();
                return false;
            }
        }

        // Enregistrer le Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
                    
                    window.pushConfig.registration = registration;
                    return registration;
                } catch (error) {
                    console.error('‚ùå Erreur enregistrement Service Worker:', error);
                    return null;
                }
            }
        }

        // Mettre √† jour les pr√©f√©rences push utilisateur
        async function updateUserPushPreference(enabled) {
            if (window.currentUserData) {
                window.currentUserData.notificationChannels.push = enabled;
                
                await window.updateUser(window.currentUserData.id, {
                    notificationChannels: window.currentUserData.notificationChannels
                });
                
                // Mettre √† jour l'interface
                const pushCheckbox = document.getElementById('canal-push');
                if (pushCheckbox) {
                    pushCheckbox.checked = enabled;
                }
            }
        }

        // D√©tecter les appareils mobiles
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Mettre √† jour l'interface des notifications push
        function updatePushUI() {
            // Statut des permissions
            const statusElement = document.getElementById('pushPermissionStatus');
            if (statusElement) {
                if (!window.pushConfig.supported) {
                    statusElement.textContent = '‚ùå Non support√© par ce navigateur';
                    statusElement.style.color = '#dc3545';
                } else {
                    const permission = window.pushConfig.permission;
                    const statusMap = {
                        'granted': { text: '‚úÖ Autoris√©es', color: '#28a745' },
                        'denied': { text: '‚ùå Refus√©es', color: '#dc3545' },
                        'default': { text: '‚ö†Ô∏è Non demand√©es', color: '#ffc107' }
                    };
                    
                    const status = statusMap[permission];
                    statusElement.textContent = status.text;
                    statusElement.style.color = status.color;
                }
            }
            
            // Support du navigateur
            const supportElement = document.getElementById('pushSupportStatus');
            if (supportElement) {
                const hasNotification = 'Notification' in window;
                const hasServiceWorker = 'serviceWorker' in navigator;
                
                if (hasNotification && hasServiceWorker) {
                    supportElement.textContent = '‚úÖ Enti√®rement support√©';
                    supportElement.style.color = '#28a745';
                } else if (hasNotification) {
                    supportElement.textContent = '‚ö†Ô∏è Support partiel (pas de Service Worker)';
                    supportElement.style.color = '#ffc107';
                } else {
                    supportElement.textContent = '‚ùå Non support√©';
                    supportElement.style.color = '#dc3545';
                }
            }
        }

        // Demander l'autorisation pour les notifications push
        async function requestPushPermission() {
            if (!window.pushConfig.supported) {
                window.showErrorMessage('‚ùå Votre navigateur ne supporte pas les notifications push');
                return false;
            }
            
            try {
                const permission = await Notification.requestPermission();
                window.pushConfig.permission = permission;
                
                if (permission === 'granted') {
                    console.log('‚úÖ Permissions accord√©es');
                    
                    // Enregistrer le Service Worker
                    if ('serviceWorker' in navigator) {
                        await registerServiceWorker();
                    }
                    
                    // Activer automatiquement les notifications push pour l'utilisateur
                    await updateUserPushPreference(true);
                    
                    updatePushUI();
                    window.showSuccessMessage('‚úÖ Notifications push activ√©es');
                    return true;
                } else {
                    console.log('‚ùå Permissions refus√©es');
                    await updateUserPushPreference(false);
                    updatePushUI();
                    window.showErrorMessage('‚ùå Notifications push refus√©es');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erreur demande permissions:', error);
                window.showErrorMessage('‚ùå Erreur lors de la demande d\'autorisation');
                return false;
            }
        }

        // V√©rifier l'√©tat de connexion
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                await loadCurrentUserData();
                updateHeaderUserInfo();
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                await loadAllData();
                initEmailJS();
                
                // NOUVEAU : Initialiser les notifications push
                await initPushNotifications();
                
                // Marquer que l'initialisation est termin√©e
                window.pushInitialized = true;
                console.log('‚úÖ Initialisation push termin√©e');
                setupNotificationListeners();
                startExpirationCheck();
                startDailyResumeScheduler();
            } else {
                window.currentUser = null;
                window.currentUserData = null;
                document.getElementById('loginModal').style.display = 'block';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        // Charger les donn√©es de l'utilisateur actuel
        async function loadCurrentUserData() {
            try {
                console.log('üîç Recherche utilisateur avec UID:', window.currentUser.uid);
                
                const q = query(collection(db, 'users'), where('userId', '==', window.currentUser.uid));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    window.currentUserData = { id: userDoc.id, ...userData };
                    
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        lastLoginAt: serverTimestamp()
                    });
                    
                } else {
                    const emailQuery = query(collection(db, 'users'), where('email', '==', window.currentUser.email));
                    const emailSnapshot = await getDocs(emailQuery);
                    
                    if (!emailSnapshot.empty) {
                        const userDoc = emailSnapshot.docs[0];
                        const userData = userDoc.data();
                        window.currentUserData = { id: userDoc.id, ...userData };
                        
                        await updateDoc(doc(db, 'users', userDoc.id), {
                            userId: window.currentUser.uid,
                            lastLoginAt: serverTimestamp()
                        });
                        
                    } else {
                        console.log('üÜï Cr√©ation du premier profil utilisateur pour:', window.currentUser.email);
                        
                        window.currentUserData = {
                            userId: window.currentUser.uid,
                            email: window.currentUser.email,
                            firstName: window.currentUser.displayName?.split(' ')[0] || 'Utilisateur',
                            lastName: window.currentUser.displayName?.split(' ')[1] || 'Principal',
                            role: 'admin',
                            notificationPreferences: {
                                creation: true,
                                diffusion: true,
                                expiration: true,
                                archivage: true,
                                resume: true
                            },
                            notificationChannels: {
                                email: true,
                                push: true
                            },
                            status: 'active'
                        };
                        
                        const docRef = await addDoc(collection(db, 'users'), {
                            ...window.currentUserData,
                            createdAt: serverTimestamp(),
                            lastLoginAt: serverTimestamp()
                        });
                        
                        window.currentUserData.id = docRef.id;
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement utilisateur:', error);
            }
        }

        // Mettre √† jour les informations utilisateur dans le header
        function updateHeaderUserInfo() {
            if (window.currentUserData) {
                const initials = `${window.currentUserData.firstName?.charAt(0) || ''}${window.currentUserData.lastName?.charAt(0) || ''}`;
                const initialsElement = document.getElementById('currentUserInitials');
                if (initialsElement) {
                    initialsElement.textContent = initials;
                }
            }
        }

        // Connexion utilisateur
        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('loginError').style.display = 'none';
            } catch (error) {
                document.getElementById('loginError').textContent = 'Erreur de connexion : ' + error.message;
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // D√©connexion utilisateur
        async function logoutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
            }
        }

        // Charger toutes les donn√©es
        async function loadAllData() {
            console.log('üîÑ Chargement de toutes les donn√©es...');
            await loadOrigines();
            await loadUnites();
            await loadAffiches();
            await loadUsers();
            await loadNotifications();
            await loadPendingNotifications(); // AJOUTER CETTE LIGNE
            await loadEmailJSConfig();
            
            // AJOUTER CES LIGNES :
            // Corriger les retards d'√©tat
            await fixCurrentStateDelays();
            
            // D√©marrer le syst√®me automatique
            startAutomaticStateChecker();
            
            setTimeout(() => {
                setupSearch();
                setupFilters();
                updateSelectOptions();
                
                if (window.lastLoadedAffiches && window.lastLoadedAffiches.length > 0) {
                    updateDashboardStats(window.lastLoadedAffiches);
                } else {
                    updateDashboardStats([]);
                }
            }, 500);
        }

        // Charger la configuration EmailJS
        async function loadEmailJSConfig() {
            try {
                const q = query(collection(db, 'config'), where('type', '==', 'emailjs'));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const configDoc = querySnapshot.docs[0];
                    const configData = configDoc.data();
                    window.emailJSConfig = { ...window.emailJSConfig, ...configData };
                    
                    document.getElementById('emailjs-service').value = window.emailJSConfig.serviceId || 'service_ec05ih4';
                    document.getElementById('emailjs-template-creation').value = window.emailJSConfig.templateCreation || 'template_nrfn4mh';
                    document.getElementById('emailjs-template-resume').value = window.emailJSConfig.templateResume || 'template_j3uluqp';
                    document.getElementById('emailjs-public-key').value = window.emailJSConfig.publicKey || '';
                    
                    initEmailJS();
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement config EmailJS:', error);
            }
        }

        // Sauvegarder la configuration EmailJS
        async function saveEmailJSConfig() {
            try {
                const config = {
                    type: 'emailjs',
                    serviceId: document.getElementById('emailjs-service').value,
                    templateCreation: document.getElementById('emailjs-template-creation').value,
                    templateResume: document.getElementById('emailjs-template-resume').value,
                    publicKey: document.getElementById('emailjs-public-key').value
                };
                
                window.emailJSConfig = { ...window.emailJSConfig, ...config };
                
                await addDoc(collection(db, 'config'), {
                    ...config,
                    updatedBy: window.currentUser.uid,
                    updatedAt: serverTimestamp()
                });
                
                initEmailJS();
                showSuccessMessage('‚úÖ Configuration EmailJS sauvegard√©e');
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde EmailJS:', error);
                showErrorMessage('‚ùå Erreur lors de la sauvegarde');
            }
        }

        // Tester EmailJS
        async function testEmailJS() {
            const publicKey = document.getElementById('emailjs-public-key').value.trim();
            
            if (!publicKey) {
                showErrorMessage('‚ùå Veuillez d\'abord entrer votre cl√© publique EmailJS');
                return;
            }

            const isValidFormat = publicKey.startsWith('pk_') || 
                                 publicKey.startsWith('user_') || 
                                 /^[A-Za-z0-9_]+$/.test(publicKey);
            
            if (!isValidFormat || publicKey.length < 10) {
                showErrorMessage(`‚ùå Format de cl√© invalide: "${publicKey}"`);
                return;
            }

            try {
                console.log('üîß Test avec cl√©:', publicKey);
                
                emailjs.init({
                    publicKey: publicKey,
                });
                
                const templateParams = {
                    to_email: window.currentUser.email,
                    to_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    subject: 'Test EmailJS - Gestion Affichage',
                    message: 'Ceci est un message de test pour v√©rifier la configuration EmailJS.',
                    affiches_list: 'Test d\'affiche - Pommes Golden - 2.50‚Ç¨/Kg',
                    user_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    date: new Date().toLocaleDateString('fr-FR')
                };

                await emailjs.send(
                    window.emailJSConfig.serviceId,
                    window.emailJSConfig.templateCreation,
                    templateParams
                );

                showSuccessMessage('‚úÖ Test EmailJS r√©ussi - Email envoy√© !');
                await saveEmailJSConfig();
                
            } catch (error) {
                console.error('‚ùå Erreur test EmailJS compl√®te:', error);
                
                let errorMessage = 'Erreur inconnue';
                if (error.status === 400) {
                    errorMessage = `Erreur 400: Configuration invalide.`;
                } else if (error.status === 401) {
                    errorMessage = `Erreur 401: Cl√© publique "${publicKey}" non autoris√©e.`;
                } else if (error.status === 404) {
                    errorMessage = `Erreur 404: Service ou Template introuvable.`;
                } else if (error.text) {
                    errorMessage = `Erreur: ${error.text}`;
                } else {
                    errorMessage = `Erreur: ${error.message || 'Inconnue'}`;
                }
                
                showErrorMessage(`‚ùå Test EmailJS √©chou√©: ${errorMessage}`);
            }
        }

        // Ajouter une affiche aux notifications en attente (AVEC PERSISTANCE)
        async function addToPendingNotifications(affiche) {
            try {
                // Ajouter √† la collection Firebase
                await addDoc(collection(db, 'pendingNotifications'), {
                    afficheId: affiche.id,
                    libelle: affiche.libelle,
                    prix: affiche.prix,
                    unite: affiche.unite,
                    origine: affiche.origine,
                    dateCreation: serverTimestamp(),
                    createdBy: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    userId: window.currentUser.uid
                });
                
                console.log('üìß Affiche ajout√©e aux notifications en attente (persistante):', affiche.libelle);
                
                // Recharger les notifications en attente
                await loadPendingNotifications();
                
            } catch (error) {
                console.error('‚ùå Erreur ajout notification en attente:', error);
            }
        }

        // Mettre √† jour la carte de notification
        function updateNotificationCard() {
            const notificationCard = document.getElementById('notificationCard');
            const notificationCount = document.getElementById('notificationCount');
            const pendingCount = window.pendingNotifications ? window.pendingNotifications.length : 0;
            
            if (pendingCount > 0) {
                notificationCard.className = 'stat-card notification-card notification-pending';
                notificationCard.onclick = sendPendingNotifications;
                
                // ORANGE D√âGRAD√â ROUGE quand il y a des notifications
                notificationCard.style.background = 'linear-gradient(135deg, #ff8800 0%, #ff4444 100%)';
                notificationCard.style.color = 'white';
                notificationCard.style.boxShadow = '0 8px 25px rgba(255, 136, 0, 0.4)';
                notificationCard.style.cursor = 'pointer';
                
                notificationCount.textContent = pendingCount;
                console.log('üîî Carte notification activ√©e:', pendingCount, 'affiches en attente');
            } else {
                notificationCard.className = 'stat-card notification-card notification-hidden';
                notificationCard.onclick = null;
                
                // VERT D√âGRAD√â quand il n'y a pas de notifications
                notificationCard.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                notificationCard.style.color = 'white';
                notificationCard.style.boxShadow = '0 8px 25px rgba(40, 167, 69, 0.4)';
                notificationCard.style.cursor = 'default';
                
                notificationCount.textContent = '0';
                console.log('üëª Carte notification verte (aucune notification)');
            }
        }

        // Mettre √† jour l'affichage des notifications en attente
        function updatePendingNotificationsDisplay() {
            // Ne fait plus rien - on utilise seulement le bouton
            console.log('üìß Notifications en attente:', window.pendingNotifications.length);
        }

        // Envoyer les notifications en attente (AVEC SUPPRESSION)
        async function sendPendingNotifications() {
            if (window.pendingNotifications.length === 0) {
                console.log('üìß Aucune notification en attente');
                showErrorMessage('üìß Aucune notification en attente');
                return;
            }

            if (!window.emailJSConfig.publicKey) {
                showErrorMessage('‚ùå EmailJS non configur√©. Configurez-le dans Param√®tres > Syst√®me');
                return;
            }

            try {
                console.log('üìß Envoi des notifications group√©es...');
                
                emailjs.init({
                    publicKey: window.emailJSConfig.publicKey.trim(),
                });
                
                const affichesText = window.pendingNotifications.map(notif => 
                    `‚Ä¢ ${notif.libelle} - ${notif.prix}‚Ç¨/${notif.unite} (${notif.origine})`
                ).join('\n');

                const templateParams = {
                    to_email: window.currentUser.email,
                    to_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    subject: `Nouvelles affiches cr√©√©es (${window.pendingNotifications.length})`,
                    message: `${window.pendingNotifications.length} nouvelle(s) affiche(s) cr√©√©e(s) :`,
                    affiches_list: affichesText,
                    user_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    date: new Date().toLocaleDateString('fr-FR')
                };

                await emailjs.send(
                    window.emailJSConfig.serviceId,
                    window.emailJSConfig.templateCreation,
                    templateParams
                );

                // Enregistrer dans l'historique
                await addNotification({
                    type: 'creation_grouped',
                    message: `Notification group√©e envoy√©e : ${window.pendingNotifications.length} affiche(s)`,
                    userId: window.currentUser.uid,
                    status: 'sent',
                    details: {
                        count: window.pendingNotifications.length,
                        affiches: window.pendingNotifications.map(n => n.libelle)
                    }
                });

                // NOUVEAU : Push notification pour les cr√©ations group√©es
                if (window.currentUserData?.notificationChannels?.push) {
                    const title = `üìù ${window.pendingNotifications.length} nouvelle(s) affiche(s)`;
                    const body = window.pendingNotifications.map(n => n.libelle).join(', ');
                    const truncatedBody = body.length > 100 ? body.substring(0, 97) + '...' : body;
                    
                    const pushSent = await safeSendPushNotification(title, {
                        body: truncatedBody,
                        data: {
                            targetTab: 'affiches',
                            count: window.pendingNotifications.length
                        }
                    });
                    
                    if (pushSent) {
                        console.log('üì± Push notification cr√©ations group√©es envoy√©e');
                    }
                }

                showSuccessMessage(`‚úÖ Notification envoy√©e pour ${window.pendingNotifications.length} affiche(s)`);
                
                // Vider les notifications en attente en m√©moire
                window.pendingNotifications = [];
                updateNotificationCard();
                updatePendingNotificationsDisplay();
                
                await loadNotifications();
                
            } catch (error) {
                console.error('‚ùå Erreur envoi notifications group√©es:', error);
                
                let errorMessage = 'Erreur inconnue';
                if (error.status === 400) {
                    errorMessage = 'Configuration EmailJS invalide';
                } else if (error.status === 401) {
                    errorMessage = 'Cl√© publique non autoris√©e';
                } else if (error.text) {
                    errorMessage = error.text;
                } else {
                    errorMessage = error.message || 'Erreur inconnue';
                }
                
                showErrorMessage(`‚ùå Erreur lors de l'envoi des notifications: ${errorMessage}`);
            }
        }

        // Planificateur de r√©sum√© quotidien
        function startDailyResumeScheduler() {
            console.log('‚è∞ D√©marrage du planificateur de r√©sum√© quotidien');
            
            setInterval(checkDailyResumeTime, 60000);
            setTimeout(checkDailyResumeTime, 5000);
        }

        async function checkDailyResumeTime() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            if (hour === 8 && minute === 0) {
                console.log('‚è∞ Heure du r√©sum√© quotidien - 08h00');
                await sendDailyResume();
            }
        }

        async function sendDailyResume() {
            if (!window.emailJSConfig.publicKey) {
                console.log('‚ùå EmailJS non configur√© pour le r√©sum√© quotidien');
                return;
            }

            try {
                console.log('üìä Pr√©paration du r√©sum√© quotidien...');
                
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                
                const affiches = window.lastLoadedAffiches || [];
                
                const stats = {
                    nouvelles: affiches.filter(a => {
                        const dateCreation = new Date(a.dateCreation);
                        return dateCreation >= yesterday && dateCreation < today;
                    }).length,
                    enDiffusion: affiches.filter(a => a.statut === 'en-diffusion').length,
                    expirantBientot: affiches.filter(a => {
                        const dateFin = new Date(a.dateFin);
                        const demain = new Date(today);
                        demain.setDate(today.getDate() + 1);
                        return a.statut === 'en-diffusion' && dateFin <= demain;
                    }).length,
                    archivees: affiches.filter(a => {
                        const dateModification = new Date(a.dateModification || a.dateCreation);
                        return a.statut === 'archivee' && dateModification >= yesterday && dateModification < today;
                    }).length
                };

                const resumeText = `
üìä R√©sum√© quotidien - ${today.toLocaleDateString('fr-FR')}

‚Ä¢ ${stats.nouvelles} nouvelle(s) affiche(s) cr√©√©e(s) hier
‚Ä¢ ${stats.enDiffusion} affiche(s) actuellement en diffusion
‚Ä¢ ${stats.expirantBientot} affiche(s) expirant demain
‚Ä¢ ${stats.archivees} affiche(s) archiv√©e(s) hier

Excellente journ√©e !
                `.trim();

                const templateParams = {
                    to_email: window.currentUser.email,
                    to_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    subject: 'R√©sum√© quotidien - Gestion Affichage',
                    message: resumeText,
                    stats_nouvelles: stats.nouvelles,
                    stats_diffusion: stats.enDiffusion,
                    stats_expiration: stats.expirantBientot,
                    stats_archivees: stats.archivees,
                    user_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    date: today.toLocaleDateString('fr-FR')
                };

                await emailjs.send(
                    window.emailJSConfig.serviceId,
                    window.emailJSConfig.templateResume,
                    templateParams
                );

                await addNotification({
                    type: 'daily_resume',
                    message: 'R√©sum√© quotidien envoy√©',
                    userId: window.currentUser.uid,
                    status: 'sent',
                    details: stats
                });

                console.log('‚úÖ R√©sum√© quotidien envoy√© avec succ√®s');
                
            } catch (error) {
                console.error('‚ùå Erreur envoi r√©sum√© quotidien:', error);
                
                await addNotification({
                    type: 'daily_resume',
                    message: '√âchec envoi r√©sum√© quotidien',
                    userId: window.currentUser.uid,
                    status: 'failed',
                    error: error.message
                });
            }
        }

        // Gestion des origines
        async function loadOrigines() {
            try {
                const q = query(collection(db, 'origines'), orderBy('nom', 'asc'));
                const querySnapshot = await getDocs(q);
                const origines = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.utilisateurId === window.currentUser.uid) {
                        origines.push({ id: doc.id, ...data });
                    }
                });
                
                window.origines = origines;
                displayOrigines(origines);
                
                if (origines.length === 0) {
                    await createDefaultOrigines();
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement origines:', error);
            }
        }

        async function createDefaultOrigines() {
            const defaultOrigines = ['France', 'Espagne', 'Italie', 'Pays-Bas', 'Belgique', 'Maroc'];
            
            for (const origine of defaultOrigines) {
                try {
                    await addDoc(collection(db, 'origines'), {
                        nom: origine,
                        dateCreation: serverTimestamp(),
                        utilisateurId: window.currentUser.uid
                    });
                } catch (error) {
                    console.error('‚ùå Erreur cr√©ation origine par d√©faut:', error);
                }
            }
            
            await loadOrigines();
        }

        function displayOrigines(origines) {
            const container = document.getElementById('originesList');
            
            if (origines.length === 0) {
                container.innerHTML = `
                    <div class="empty-params">
                        Aucune origine configur√©e.<br>
                        Cliquez sur "Ajouter une origine" pour commencer.
                    </div>
                `;
                return;
            }
            
            const originesHtml = origines.map(origine => `
                <div class="param-item">
                    <span class="param-name">${origine.nom}</span>
                    <div class="param-actions">
                        <button class="action-btn edit-btn" onclick="editOrigine('${origine.id}')">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="confirmDeleteOrigine('${origine.id}', '${origine.nom}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = originesHtml;
        }

        async function saveOrigine(origine) {
            try {
                const docRef = await addDoc(collection(db, 'origines'), {
                    ...origine,
                    dateCreation: serverTimestamp(),
                    utilisateurId: window.currentUser.uid
                });
                await loadOrigines();
                updateSelectOptions();
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde origine:', error);
                throw error;
            }
        }

        async function updateOrigine(id, data) {
            try {
                const docRef = doc(db, 'origines', id);
                await updateDoc(docRef, {
                    ...data,
                    dateModification: serverTimestamp()
                });
                showSuccessMessage('‚úÖ Origine mise √† jour avec succ√®s');
                await loadOrigines();
                updateSelectOptions();
                return true;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour origine:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        async function deleteOrigine(id) {
            try {
                await deleteDoc(doc(db, 'origines', id));
                showSuccessMessage('üóëÔ∏è Origine supprim√©e avec succ√®s');
                await loadOrigines();
                updateSelectOptions();
            } catch (error) {
                console.error('‚ùå Erreur suppression origine:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        async function loadOrigineForEdit(id) {
            try {
                const docRef = doc(db, 'origines', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    return { id: docSnap.id, ...docSnap.data() };
                } else {
                    showErrorMessage('‚ùå Origine non trouv√©e');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement origine:', error);
                return null;
            }
        }

        // Gestion des unit√©s
        async function loadUnites() {
            try {
                const q = query(collection(db, 'unites'), orderBy('nom', 'asc'));
                const querySnapshot = await getDocs(q);
                const unites = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.utilisateurId === window.currentUser.uid) {
                        unites.push({ id: doc.id, ...data });
                    }
                });
                
                window.unites = unites;
                displayUnites(unites);
                
                if (unites.length === 0) {
                    await createDefaultUnites();
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement unit√©s:', error);
            }
        }

        async function createDefaultUnites() {
            const defaultUnites = ['Kg', 'g', 'L', 'mL', 'Unit√©', 'Pi√®ce', 'Barquette', 'Sachet', 'Botte', 'Bouquet'];
            
            for (const unite of defaultUnites) {
                try {
                    await addDoc(collection(db, 'unites'), {
                        nom: unite,
                        dateCreation: serverTimestamp(),
                        utilisateurId: window.currentUser.uid
                    });
                } catch (error) {
                    console.error('‚ùå Erreur cr√©ation unit√© par d√©faut:', error);
                }
            }
            
            await loadUnites();
        }

        function displayUnites(unites) {
            const container = document.getElementById('unitesList');
            
            if (unites.length === 0) {
                container.innerHTML = `
                    <div class="empty-params">
                        Aucune unit√© configur√©e.<br>
                        Cliquez sur "Ajouter une unit√©" pour commencer.
                    </div>
                `;
                return;
            }
            
            const unitesHtml = unites.map(unite => `
                <div class="param-item">
                    <span class="param-name">${unite.nom}</span>
                    <div class="param-actions">
                        <button class="action-btn edit-btn" onclick="editUnite('${unite.id}')">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="confirmDeleteUnite('${unite.id}', '${unite.nom}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = unitesHtml;
        }

        async function saveUnite(unite) {
            try {
                const docRef = await addDoc(collection(db, 'unites'), {
                    ...unite,
                    dateCreation: serverTimestamp(),
                    utilisateurId: window.currentUser.uid
                });
                await loadUnites();
                updateSelectOptions();
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde unit√©:', error);
                throw error;
            }
        }

        async function updateUnite(id, data) {
            try {
                const docRef = doc(db, 'unites', id);
                await updateDoc(docRef, {
                    ...data,
                    dateModification: serverTimestamp()
                });
                showSuccessMessage('‚úÖ Unit√© mise √† jour avec succ√®s');
                await loadUnites();
                updateSelectOptions();
                return true;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour unit√©:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        async function deleteUnite(id) {
            try {
                await deleteDoc(doc(db, 'unites', id));
                showSuccessMessage('üóëÔ∏è Unit√© supprim√©e avec succ√®s');
                await loadUnites();
                updateSelectOptions();
            } catch (error) {
                console.error('‚ùå Erreur suppression unit√©:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        async function loadUniteForEdit(id) {
            try {
                const docRef = doc(db, 'unites', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    return { id: docSnap.id, ...docSnap.data() };
                } else {
                    showErrorMessage('‚ùå Unit√© non trouv√©e');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement unit√©:', error);
                return null;
            }
        }

        // Gestion des affiches
        async function loadAffiches() {
            try {
                const q = query(collection(db, 'affiches'), orderBy('dateCreation', 'desc'));
                const querySnapshot = await getDocs(q);
                const affiches = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.dateCreation && data.dateCreation.toDate) {
                        data.dateCreation = data.dateCreation.toDate();
                    }
                    affiches.push({ id: doc.id, ...data });
                });
                
                displayAffiches(affiches);
                window.lastLoadedAffiches = affiches;
            } catch (error) {
                console.error('‚ùå Erreur chargement affiches:', error);
                displayAffiches([]);
            }
        }

        async function saveAffiche(affiche) {
            try {
                const docRef = await addDoc(collection(db, 'affiches'), {
                    ...affiche,
                    dateCreation: serverTimestamp(),
                    utilisateurId: window.currentUser.uid,
                    createdBy: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    notificationSent: false
                });
                
            const groupNotifications = document.getElementById('group-notifications')?.checked !== false;
            if (groupNotifications) {
                await addToPendingNotifications({ id: docRef.id, ...affiche });
            } else {
                await sendImmediateNotification(affiche);
            }
                
                await loadAffiches();
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde affiche:', error);
                throw error;
            }
        }

        async function sendImmediateNotification(affiche) {
            if (!window.emailJSConfig.publicKey) {
                console.log('‚ö†Ô∏è EmailJS non configur√© - notification ignor√©e');
                return;
            }

            try {
                emailjs.init({
                    publicKey: window.emailJSConfig.publicKey.trim(),
                });
                
                const templateParams = {
                    to_email: window.currentUser.email,
                    to_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    subject: 'Nouvelle affiche cr√©√©e',
                    message: 'Nouvelle affiche cr√©√©e :',
                    affiches_list: `‚Ä¢ ${affiche.libelle} - ${affiche.prix}‚Ç¨/${affiche.unite} (${affiche.origine})`,
                    user_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                    date: new Date().toLocaleDateString('fr-FR')
                };

                await emailjs.send(
                    window.emailJSConfig.serviceId,
                    window.emailJSConfig.templateCreation,
                    templateParams
                );

                await addNotification({
                    type: 'creation',
                    message: `Notification imm√©diate envoy√©e : ${affiche.libelle}`,
                    userId: window.currentUser.uid,
                    status: 'sent'
                });

            } catch (error) {
                console.error('‚ùå Erreur notification imm√©diate:', error);
            }
        }

        async function updateAffiche(id, data) {
            try {
                const docRef = doc(db, 'affiches', id);
                await updateDoc(docRef, {
                    ...data,
                    dateModification: serverTimestamp(),
                    modifiedBy: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`
                });
                showSuccessMessage('‚úÖ Affiche mise √† jour avec succ√®s');
                await loadAffiches();
                return true;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour affiche:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        async function deleteAffiche(id) {
            try {
                await deleteDoc(doc(db, 'affiches', id));
                showSuccessMessage('üóëÔ∏è Affiche supprim√©e avec succ√®s');
                await loadAffiches();
            } catch (error) {
                console.error('‚ùå Erreur suppression affiche:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        async function loadAfficheForEdit(id) {
            try {
                const docRef = doc(db, 'affiches', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    return { id: docSnap.id, ...docSnap.data() };
                } else {
                    showErrorMessage('‚ùå Affiche non trouv√©e');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement affiche:', error);
                return null;
            }
        }

        // Gestion des utilisateurs
        async function loadUsers() {
            try {
                const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                const users = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    if (data.lastLoginAt && data.lastLoginAt.toDate) {
                        data.lastLoginAt = data.lastLoginAt.toDate();
                    }
                    users.push({ id: doc.id, ...data });
                });
                
                window.users = users;
                displayUsers(users);
                updateUserStats(users);
            } catch (error) {
                console.error('‚ùå Erreur chargement utilisateurs:', error);
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersList');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        Aucun utilisateur enregistr√©.<br>
                        Invitez des coll√®gues pour collaborer !
                    </div>
                `;
                return;
            }
            
            const usersHtml = users.map(user => {
                const initials = `${user.firstName?.charAt(0) || ''}${user.lastName?.charAt(0) || ''}`;
                const isOnline = user.lastLoginAt && (new Date() - user.lastLoginAt) < 300000;
                const isCurrentUser = user.userId === window.currentUser.uid;
                
                return `
                    <div class="user-card">
                        <div class="user-header">
                            <div style="display: flex; align-items: center;">
                                <div class="user-avatar">${initials}</div>
                                <div class="user-main-info">
                                    <div class="user-name">${user.firstName} ${user.lastName} ${isCurrentUser ? '(Vous)' : ''}</div>
                                    <div class="user-email">${user.email}</div>
                                    <span class="user-role ${user.role === 'admin' ? 'admin' : ''}">${user.role === 'admin' ? 'üëë Administrateur' : 'üë§ Employ√©'}</span>
                                </div>
                            </div>
                            <div class="user-actions">
                                <button class="action-btn edit-btn" onclick="editUser('${user.id}')" title="Modifier">‚úèÔ∏è</button>
                                ${!isCurrentUser ? `
                                    <button class="action-btn delete-btn" onclick="confirmDeleteUser('${user.id}', '${user.firstName} ${user.lastName}')" title="Supprimer">üóëÔ∏è</button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="user-preferences">
                            <div class="user-pref-title">Pr√©f√©rences de notification :</div>
                            <div class="notification-prefs">
                                <div class="pref-option">
                                    <span class="pref-icon ${user.notificationChannels?.email ? 'active' : 'inactive'}">${user.notificationChannels?.email ? '‚úÖ' : '‚ùå'}</span>
                                    <span>Email</span>
                                </div>
                                <div class="pref-option">
                                    <span class="pref-icon ${user.notificationChannels?.push ? 'active' : 'inactive'}">${user.notificationChannels?.push ? '‚úÖ' : '‚ùå'}</span>
                                    <span>Push</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="user-status ${isOnline ? 'status-online' : 'status-offline'}">
                            ${isOnline ? 'üü¢ En ligne' : '‚ö´ Hors ligne'} - Derni√®re connexion: ${formatDateTime(user.lastLoginAt)}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = usersHtml;
        }

        async function inviteUser(userData) {
            try {
                if (window.users.length >= 6) {
                    showErrorMessage('‚ùå Limite de 6 utilisateurs atteinte');
                    return;
                }
                
                const existingUser = window.users.find(u => u.email === userData.email);
                if (existingUser) {
                    showErrorMessage('‚ùå Cet email est d√©j√† utilis√©');
                    return;
                }
                
                const newUser = {
                    email: userData.email,
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    role: userData.role,
                    notificationPreferences: {
                        creation: true,
                        diffusion: true,
                        expiration: true,
                        archivage: true,
                        resume: true
                    },
                    notificationChannels: {
                        email: userData.defaultEmail || true,
                        push: userData.defaultPush || true
                    },
                    status: 'invited',
                    invitedBy: window.currentUser.uid,
                    invitedAt: serverTimestamp(),
                    createdAt: serverTimestamp()
                };
                
                const docRef = await addDoc(collection(db, 'users'), newUser);
                
                await addNotification({
                    type: 'user_invited',
                    message: `Utilisateur ${userData.firstName} ${userData.lastName} invit√©`,
                    userId: window.currentUser.uid,
                    status: 'sent'
                });
                
                showSuccessMessage(`‚úâÔ∏è Invitation envoy√©e √† ${userData.firstName} ${userData.lastName}`);
                await loadUsers();
                
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Erreur invitation utilisateur:', error);
                showErrorMessage('‚ùå Erreur lors de l\'invitation');
                throw error;
            }
        }

        async function updateUser(id, userData) {
            try {
                const docRef = doc(db, 'users', id);
                await updateDoc(docRef, {
                    ...userData,
                    updatedAt: serverTimestamp()
                });
                
                if (window.currentUserData && window.currentUserData.id === id) {
                    window.currentUserData = { ...window.currentUserData, ...userData };
                    updateHeaderUserInfo();
                }
                
                showSuccessMessage('‚úÖ Utilisateur mis √† jour avec succ√®s');
                await loadUsers();
                return true;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour utilisateur:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        async function deleteUser(id) {
            try {
                await deleteDoc(doc(db, 'users', id));
                showSuccessMessage('üóëÔ∏è Utilisateur supprim√© avec succ√®s');
                await loadUsers();
            } catch (error) {
                console.error('‚ùå Erreur suppression utilisateur:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        async function loadUserForEdit(id) {
            try {
                const userInList = window.users.find(u => u.id === id);
                if (userInList) {
                    return userInList;
                }
                
                const userDoc = await getDoc(doc(db, 'users', id));
                if (userDoc.exists()) {
                    return { id: userDoc.id, ...userDoc.data() };
                } else {
                    showErrorMessage('‚ùå Utilisateur non trouv√©');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement utilisateur:', error);
                return null;
            }
        }

        function updateUserStats(users) {
            document.getElementById('totalUsers').textContent = `${users.length} utilisateur(s)`;
            
            const activeUsers = users.filter(u => {
                if (!u.lastLoginAt) return false;
                const lastLogin = u.lastLoginAt instanceof Date ? u.lastLoginAt : u.lastLoginAt.toDate();
                return (new Date() - lastLogin) < 300000;
            }).length;
            
            document.getElementById('activeUsers').textContent = `${activeUsers} utilisateur(s) connect√©(s)`;
        }

        // Gestion des notifications
        async function loadNotifications() {
            try {
                const q = query(
                    collection(db, 'notifications'), 
                    where('userId', '==', window.currentUser.uid)
                );
                const querySnapshot = await getDocs(q);
                const notifications = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    notifications.push({ id: doc.id, ...data });
                });
                
                notifications.sort((a, b) => {
                    const dateA = a.createdAt instanceof Date ? a.createdAt : new Date(a.createdAt);
                    const dateB = b.createdAt instanceof Date ? b.createdAt : new Date(b.createdAt);
                    return dateB - dateA;
                });
                
                window.notifications = notifications;
                displayNotificationHistory(notifications);
                updateNotificationStats(notifications);
            } catch (error) {
                console.error('‚ùå Erreur chargement notifications:', error);
                window.notifications = [];
                displayNotificationHistory([]);
                updateNotificationStats([]);
            }
        }

        // √Ä ajouter apr√®s la fonction loadNotifications()
        async function checkAndUpdateAfficheStates() {
            try {
                console.log('üîÑ V√©rification automatique des √©tats d\'affiches...');
                
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                // R√©cup√©rer toutes les affiches depuis Firebase
                const q = query(collection(db, 'affiches'), orderBy('dateCreation', 'desc'));
                const querySnapshot = await getDocs(q);
                const affiches = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    affiches.push({ id: doc.id, ...data });
                });
                
                let changementsEffectues = 0;
                
                for (const affiche of affiches) {
                    const dateDebut = new Date(affiche.dateDebut);
                    const dateFin = new Date(affiche.dateFin);
                    
                    // Normaliser les dates (ignorer l'heure)
                    const debutNormalized = new Date(dateDebut.getFullYear(), dateDebut.getMonth(), dateDebut.getDate());
                    const finNormalized = new Date(dateFin.getFullYear(), dateFin.getMonth(), dateFin.getDate());
                    
                    let nouvelEtat = null;
                    let motif = '';
                    
                    // R√àGLE 1: Programm√©e ‚Üí En diffusion (si date d√©but = aujourd'hui ou pass√©e)
                    if (affiche.statut === 'programmee' && today >= debutNormalized) {
                        nouvelEtat = 'en-diffusion';
                        motif = `Date d√©but atteinte (${dateDebut.toLocaleDateString('fr-FR')})`;
                    }
                    
                    // R√àGLE 2: En diffusion ‚Üí Archiv√©e (si date fin = hier ou avant)
                    else if (affiche.statut === 'en-diffusion' && today > finNormalized) {
                        nouvelEtat = 'archivee';
                        motif = `Date fin d√©pass√©e (${dateFin.toLocaleDateString('fr-FR')})`;
                    }
                    
                    // Effectuer la mise √† jour si n√©cessaire
                    if (nouvelEtat && nouvelEtat !== affiche.statut) {
                        await updateAffiche(affiche.id, { 
                            statut: nouvelEtat,
                            changementAutomatique: true,
                            dateChangementAuto: serverTimestamp(),
                            motifChangement: motif
                        });
                        
                        console.log(`‚úÖ Affiche "${affiche.libelle}" pass√©e de "${affiche.statut}" √† "${nouvelEtat}" - ${motif}`);
                        changementsEffectues++;
                        
                        // Envoyer notification de changement d'√©tat
                        await sendStatusChangeNotification(nouvelEtat, affiche);
                    }
                }
                
                if (changementsEffectues > 0) {
                    console.log(`üéØ ${changementsEffectues} affiche(s) mise(s) √† jour automatiquement`);
                    // Recharger les donn√©es pour mettre √† jour l'interface
                    await loadAffiches();
                } else {
                    console.log('‚úÖ Toutes les affiches sont √† jour');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la v√©rification automatique:', error);
            }
        }

        // √Ä ajouter apr√®s checkAndUpdateAfficheStates()
        function startAutomaticStateChecker() {
            console.log('‚è∞ D√©marrage du planificateur automatique des √©tats d\'affiches');
            
            // V√©rification imm√©diate au d√©marrage (apr√®s 10 secondes)
            setTimeout(() => {
                console.log('üöÄ V√©rification initiale des √©tats');
                checkAndUpdateAfficheStates();
            }, 10000);
            
            // V√©rification toutes les heures
            setInterval(() => {
                console.log('‚è∞ V√©rification horaire automatique des √©tats');
                checkAndUpdateAfficheStates();
            }, 3600000); // 3600000 ms = 1 heure
            
            // V√©rification sp√©cifique aux heures critiques
            setInterval(() => {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                // √Ä 00h01 : v√©rifier sp√©cifiquement les passages en diffusion
                if (hour === 0 && minute === 1) {
                    console.log('üåÖ V√©rification 00h01 - Passages en diffusion');
                    checkAndUpdateAfficheStates();
                }
                
                // √Ä 23h59 : v√©rifier sp√©cifiquement les archivages
                if (hour === 23 && minute === 59) {
                    console.log('üåô V√©rification 23h59 - Archivages');
                    checkAndUpdateAfficheStates();
                }
                
            }, 60000); // V√©rifier chaque minute pour d√©tecter les heures critiques
        }

        // √Ä ajouter apr√®s startAutomaticStateChecker()
        async function fixCurrentStateDelays() {
            try {
                console.log('üîß Correction des retards d\'√©tat actuels...');
                
                // Date actuelle : 18/07/2025 05h00
                const aujourdhui = new Date(2025, 6, 18); // Mois 6 = juillet (0-index√©)
                const hier = new Date(2025, 6, 17);
                
                const q = query(collection(db, 'affiches'));
                const querySnapshot = await getDocs(q);
                const affiches = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    affiches.push({ id: doc.id, ...data });
                });
                
                let correctionsEffectuees = 0;
                
                for (const affiche of affiches) {
                    const dateDebut = new Date(affiche.dateDebut);
                    const dateFin = new Date(affiche.dateFin);
                    
                    // CORRECTION 1: Affiches "Programm√©e" avec d√©but = 18/07/2025 ‚Üí "En diffusion"
                    if (affiche.statut === 'programmee' && 
                        dateDebut.getFullYear() === 2025 && 
                        dateDebut.getMonth() === 6 && 
                        dateDebut.getDate() === 18) {
                        
                        await updateAffiche(affiche.id, { 
                            statut: 'en-diffusion',
                            changementAutomatique: true,
                            correctionRetard: true,
                            dateChangementAuto: serverTimestamp()
                        });
                        
                        console.log(`‚úÖ CORRECTION: ${affiche.libelle} ‚Üí En diffusion (d√©but 18/07)`);
                        correctionsEffectuees++;
                    }
                    
                    // CORRECTION 2: Affiches "En diffusion" avec fin = 17/07/2025 ‚Üí "Archiv√©e"
                    else if (affiche.statut === 'en-diffusion' && 
                            dateFin.getFullYear() === 2025 && 
                            dateFin.getMonth() === 6 && 
                            dateFin.getDate() === 17) {
                        
                        await updateAffiche(affiche.id, { 
                            statut: 'archivee',
                            changementAutomatique: true,
                            correctionRetard: true,
                            dateChangementAuto: serverTimestamp()
                        });
                        
                        console.log(`‚úÖ CORRECTION: ${affiche.libelle} ‚Üí Archiv√©e (fin 17/07)`);
                        correctionsEffectuees++;
                    }
                }
                
                if (correctionsEffectuees > 0) {
                    console.log(`üéØ ${correctionsEffectuees} correction(s) de retard effectu√©e(s)`);
                    showSuccessMessage(`üîß ${correctionsEffectuees} affiche(s) corrig√©e(s) automatiquement`);
                    // Recharger les affiches apr√®s correction
                    await loadAffiches();
                } else {
                    console.log('‚úÖ Aucune correction de retard n√©cessaire');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la correction des retards:', error);
                showErrorMessage('‚ùå Erreur lors de la correction automatique');
            }
        }

        // Charger les notifications en attente depuis Firebase
        async function loadPendingNotifications() {
            try {
                const q = query(
                    collection(db, 'pendingNotifications'), 
                    where('userId', '==', window.currentUser.uid),
                    orderBy('dateCreation', 'desc')
                );
                const querySnapshot = await getDocs(q);
                
                window.pendingNotifications = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.dateCreation && data.dateCreation.toDate) {
                        data.dateCreation = data.dateCreation.toDate();
                    }
                    window.pendingNotifications.push({ 
                        docId: doc.id, // ID du document Firebase
                        ...data 
                    });
                });
                
                console.log('üìß Notifications en attente charg√©es:', window.pendingNotifications.length);
                updateNotificationCard();
                updatePendingNotificationsDisplay();

                // Debug: forcer la mise √† jour apr√®s un d√©lai
                setTimeout(() => {
                    console.log('üîÑ Force update notification card');
                    updateNotificationCard();
                }, 500);

            } catch (error) {
                console.error('‚ùå Erreur chargement notifications en attente:', error);
                window.pendingNotifications = [];
                updateNotificationCard();
                updatePendingNotificationsDisplay();
            }
        }

        function displayNotificationHistory(notifications) {
            const container = document.getElementById('notificationHistory');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        Aucune notification envoy√©e r√©cemment
                    </div>
                `;
                return;
            }
            
            const recentNotifications = notifications.slice(0, 10);
            const notificationsHtml = recentNotifications.map(notif => `
                <div class="notification-item">
                    <div class="notification-header">
                        <span class="notification-type">${getNotificationTypeLabel(notif.type)}</span>
                        <span class="notification-time">${formatDateTime(notif.createdAt)}</span>
                    </div>
                    <div class="notification-message">${notif.message}</div>
                    <div class="notification-status ${notif.status === 'failed' ? 'failed' : ''}">${notif.status === 'sent' ? '‚úÖ Envoy√©e' : '‚ùå √âchec'}</div>
                </div>
            `).join('');
            
            container.innerHTML = notificationsHtml;
        }

        async function addNotification(notificationData) {
            try {
                await addDoc(collection(db, 'notifications'), {
                    ...notificationData,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error('‚ùå Erreur ajout notification:', error);
            }
        }

        function updateNotificationStats(notifications) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayNotifications = notifications.filter(n => {
                const notifDate = n.createdAt instanceof Date ? n.createdAt : n.createdAt.toDate();
                return notifDate >= today;
            }).length;
            
            document.getElementById('todayNotifications').textContent = `${todayNotifications} notification(s)`;
        }

        async function testNotification() {
            const user = window.currentUserData;
            let emailSuccess = false;
            let pushSuccess = false;
            
            // Test Email (existant)
            if (user?.notificationChannels?.email && window.emailJSConfig.publicKey) {
                try {
                    const templateParams = {
                        to_email: window.currentUser.email,
                        to_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                        subject: 'Test EmailJS - Gestion Affichage',
                        message: 'Ceci est un message de test pour v√©rifier la configuration EmailJS.',
                        affiches_list: 'Test d\'affiche - Pommes Golden - 2.50‚Ç¨/Kg',
                        user_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                        date: new Date().toLocaleDateString('fr-FR')
                    };

                    await emailjs.send(
                        window.emailJSConfig.serviceId,
                        window.emailJSConfig.templateCreation,
                        templateParams
                    );

                    emailSuccess = true;
                } catch (error) {
                    console.error('‚ùå Erreur test email:', error);
                }
            }
            
            // NOUVEAU : Test Push
            if (user?.notificationChannels?.push) {
                if (Notification.permission === 'granted') {
                    const pushSent = await safeSendPushNotification('üß™ Test - Gestion Affichage', {
                        body: 'Ceci est un test de notification push.',
                        data: {
                            targetTab: 'parametres'
                        }
                    });
                    
                    if (pushSent) {
                        pushSuccess = true;
                    }
                }
            }
            
            // Messages de r√©sultat
            if (emailSuccess && pushSuccess) {
                showSuccessMessage('‚úÖ Tests r√©ussis - Email et Push envoy√©s !');
            } else if (emailSuccess) {
                showSuccessMessage('‚úÖ Test email r√©ussi - Push non configur√©');
            } else if (pushSuccess) {
                showSuccessMessage('‚úÖ Test push r√©ussi - Email non configur√©');
            } else if (!user?.notificationChannels?.email && !user?.notificationChannels?.push) {
                showErrorMessage('‚ùå Aucun canal de notification activ√©');
            } else {
                showErrorMessage('‚ùå √âchec des tests de notification');
            }
        }

        function setupNotificationListeners() {
            console.log('üîß Configuration des listeners de notifications...');
            
            const affichesQuery = query(collection(db, 'affiches'), orderBy('dateCreation', 'desc'));
            let isFirstLoad = true;
            let initialLoadComplete = false;
            
            onSnapshot(affichesQuery, (snapshot) => {
                if (isFirstLoad) {
                    isFirstLoad = false;
                    setTimeout(() => {
                        initialLoadComplete = true;
                        console.log('‚úÖ Listeners de notifications activ√©s');
                    }, 3000);
                    return;
                }
                
                if (!initialLoadComplete) return;
                
                snapshot.docChanges().forEach((change) => {
                    const affiche = change.doc.data();
                    
                    if (change.type === 'modified') {
                        if (affiche.statut === 'en-diffusion') {
                            sendStatusChangeNotification('diffusion', affiche);
                        } else if (affiche.statut === 'archivee') {
                            sendStatusChangeNotification('archivage', affiche);
                        }
                    }
                });
            });
        }

        async function sendStatusChangeNotification(type, affiche) {
            const user = window.currentUserData;
            
            // Email (existant)
            if (user?.notificationChannels?.email && window.emailJSConfig.publicKey) {
                try {
                    const templateParams = {
                        to_email: window.currentUser.email,
                        to_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                        subject: `Affiche ${type === 'diffusion' ? 'mise en diffusion' : 'archiv√©e'}`,
                        message: `Affiche ${type === 'diffusion' ? 'mise en diffusion' : 'archiv√©e'} :`,
                        affiches_list: `‚Ä¢ ${affiche.libelle} - ${affiche.prix}‚Ç¨/${affiche.unite} (${affiche.origine})`,
                        user_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                        date: new Date().toLocaleDateString('fr-FR')
                    };

                    await emailjs.send(
                        window.emailJSConfig.serviceId,
                        window.emailJSConfig.templateCreation,
                        templateParams
                    );

                    await addNotification({
                        type: type,
                        message: `Email envoy√© - Affiche ${type === 'diffusion' ? 'mise en diffusion' : 'archiv√©e'}: ${affiche.libelle}`,
                        userId: window.currentUser.uid,
                        status: 'sent'
                    });

                } catch (error) {
                    console.error(`‚ùå Erreur notification email ${type}:`, error);
                }
            }
            
            // NOUVEAU : Push notification
            if (user?.notificationChannels?.push && Notification.permission === 'granted') {
                const titles = {
                    'diffusion': 'üì∫ Affiche en diffusion',
                    'archivage': 'üì¶ Affiche archiv√©e'
                };
                
                const title = titles[type] || 'Notification';
                const body = `${affiche.libelle} - ${affiche.prix}‚Ç¨/${affiche.unite}`;
                
                const pushSent = await safeSendPushNotification(title, {
                    body: body,
                    data: {
                        targetTab: 'dashboard',
                        afficheId: affiche.id
                    }
                });
                
                if (pushSent) {
                    await addNotification({
                        type: `${type}_push`,
                        message: `Push envoy√© - Affiche ${type === 'diffusion' ? 'mise en diffusion' : 'archiv√©e'}: ${affiche.libelle}`,
                        userId: window.currentUser.uid,
                        status: 'sent'
                    });
                }
            }
        }

        async function checkExpiringAffiches() {
            try {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const affiches = window.lastLoadedAffiches || [];
                const expiringAffiches = affiches.filter(a => {
                    if (a.statut !== 'en-diffusion') return false;
                    const dateFin = new Date(a.dateFin);
                    dateFin.setHours(0, 0, 0, 0);
                    return dateFin.getTime() === tomorrow.getTime();
                });

                if (expiringAffiches.length > 0 && window.emailJSConfig.publicKey) {
                    const affichesText = expiringAffiches.map(a => 
                        `‚Ä¢ ${a.libelle} - ${a.prix}‚Ç¨/${a.unite} (${a.origine})`
                    ).join('\n');

                    const templateParams = {
                        to_email: window.currentUser.email,
                        to_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                        subject: `Affiches expirant demain (${expiringAffiches.length})`,
                        message: `${expiringAffiches.length} affiche(s) expire(nt) demain :`,
                        affiches_list: affichesText,
                        user_name: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`,
                        date: new Date().toLocaleDateString('fr-FR')
                    };

                    await emailjs.send(
                        window.emailJSConfig.serviceId,
                        window.emailJSConfig.templateCreation,
                        templateParams
                    );

                    for (const affiche of expiringAffiches) {
                        await addNotification({
                            type: 'expiration',
                            message: `Affiche expire demain: ${affiche.libelle}`,
                            userId: window.currentUser.uid,
                            status: 'sent'
                        });
                    }

                    // NOUVEAU : Push notification pour les expirations
                    if (window.currentUserData?.notificationChannels?.push) {
                        const title = `‚ö†Ô∏è ${expiringAffiches.length} affiche(s) expire(nt) demain`;
                        const body = expiringAffiches.map(a => a.libelle).join(', ');
                        const truncatedBody = body.length > 100 ? body.substring(0, 97) + '...' : body;
                        
                        const pushSent = await safeSendPushNotification(title, {
                            body: truncatedBody,
                            requireInteraction: true, // Important pour les expirations
                            data: {
                                targetTab: 'planning'
                            }
                        });
                        
                        if (pushSent) {
                            console.log('üì± Push notification expirations envoy√©e');
                        }
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erreur v√©rification expirations:', error);
            }
        }

        function startExpirationCheck() {
            setTimeout(checkExpiringAffiches, 60000);
            setInterval(checkExpiringAffiches, 3600000);
        }

        // Mise √† jour des select
        function updateSelectOptions() {
            const origineSelects = ['origine', 'editOrigine'];
            origineSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Choisir une origine</option>';
                    
                    window.origines.forEach(origine => {
                        const option = document.createElement('option');
                        option.value = origine.nom;
                        option.textContent = origine.nom;
                        select.appendChild(option);
                    });
                    
                    const autreOption = document.createElement('option');
                    autreOption.value = 'autre';
                    autreOption.textContent = '‚ûï Autre...';
                    select.appendChild(autreOption);
                    
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            });
            
            const uniteSelects = ['unite', 'editUnite'];
            uniteSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Choisir une unit√©</option>';
                    
                    window.unites.forEach(unite => {
                        const option = document.createElement('option');
                        option.value = unite.nom;
                        option.textContent = unite.nom;
                        select.appendChild(option);
                    });
                    
                    const autreOption = document.createElement('option');
                    autreOption.value = 'autre';
                    autreOption.textContent = '‚ûï Autre...';
                    select.appendChild(autreOption);
                    
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // Fonctions d'affichage
        function displayAffiches(affiches) {
            console.log('üéØ displayAffiches appel√©e avec:', affiches.length, 'affiches');
            
            window.lastLoadedAffiches = affiches;
            
            updateDashboardStats(affiches);
            updateDashboardAffiches(affiches);
            updateAffichesTab(affiches);
            updatePlanningTab(affiches);
        }

        function updateDashboardStats(affiches) {
            const stats = {
                enDiffusion: affiches.filter(a => a.statut === 'en-diffusion').length,
                aCreer: affiches.filter(a => a.statut === 'a-creer').length,
                programmees: affiches.filter(a => a.statut === 'programmee').length,
                archivees: affiches.filter(a => a.statut === 'archivee').length
            };
            
            document.getElementById('statEnDiffusion').textContent = stats.enDiffusion;
            document.getElementById('statACreer').textContent = stats.aCreer;
            document.getElementById('statProgrammees').textContent = stats.programmees;
            document.getElementById('statArchivees').textContent = stats.archivees;
            
            updateNotificationCard();
        }

        function updateDashboardAffiches(affiches) {
            const affichesEnDiffusion = affiches.filter(a => a.statut === 'en-diffusion').slice(0, 5);
            const container = document.querySelector('.recent-items');
            
            if (container) {
                if (affichesEnDiffusion.length === 0) {
                    container.innerHTML = `
                        <h3>üì∫ Affiches en diffusion</h3>
                        <div class="empty-state">
                            Aucune affiche en diffusion pour le moment
                        </div>
                    `;
                    return;
                }

                const itemsHtml = affichesEnDiffusion.map(affiche => {
                    const iconClass = getFamilleIconClass(affiche.famille);
                    const icon = getFamilleIcon(affiche.famille);
                    const dateExpiration = formatDate(affiche.dateFin);
                    
                    return `
                        <div class="item">
                            <div class="item-icon ${iconClass}">${icon}</div>
                            <div class="item-info">
                                <h4>${affiche.libelle}</h4>
                                <p>${affiche.prix}‚Ç¨/${affiche.unite} ‚Ä¢ ${affiche.origine} ‚Ä¢ Expire le ${dateExpiration}</p>
                            </div>
                            <span class="status-badge status-en-diffusion">En diffusion</span>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <h3>üì∫ Affiches en diffusion</h3>
                    ${itemsHtml}
                `;
            }
        }

        function updateAffichesTab(affiches) {
            const container = document.querySelector('#affiches');
            if (!container) return;
            
            const searchBar = container.querySelector('.search-bar');
            const filterSection = container.querySelector('.filter-section');
            
            if (affiches.length === 0) {
                container.innerHTML = '';
                if (searchBar) container.appendChild(searchBar);
                if (filterSection) container.appendChild(filterSection);
                container.insertAdjacentHTML('beforeend', `
                    <div class="empty-state">
                        Aucune affiche cr√©√©e pour le moment.<br>
                        Cliquez sur le bouton + pour cr√©er votre premi√®re affiche !
                    </div>
                `);
                return;
            }
            
            const affichesHtml = affiches.map(affiche => {
                const iconClass = getFamilleIconClass(affiche.famille);
                const icon = getFamilleIcon(affiche.famille);
                const statusClass = getStatusClass(affiche.statut);
                const statusText = getStatusText(affiche.statut);
                const dateDebut = formatDate(affiche.dateDebut);
                const dateFin = formatDate(affiche.dateFin);
                
                return `
                    <div class="item" data-status="${affiche.statut}">
                        <div class="item-icon ${iconClass}">${icon}</div>
                        <div class="item-info">
                            <h4>${affiche.libelle}</h4>
                            <p>${affiche.prix}‚Ç¨/${affiche.unite} ‚Ä¢ ${affiche.origine}</p>
                            <p class="item-dates">${dateDebut} ‚Üí ${dateFin}</p>
                        </div>
                        <div class="item-actions">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <div class="item-actions-buttons">
                                <button class="action-btn edit-btn" onclick="editAffiche('${affiche.id}')">‚úèÔ∏è</button>
                                <button class="action-btn delete-btn" onclick="confirmDeleteAffiche('${affiche.id}', '${affiche.libelle}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = '';
            if (searchBar) container.appendChild(searchBar);
            if (filterSection) container.appendChild(filterSection);
            container.insertAdjacentHTML('beforeend', affichesHtml);
            
            setTimeout(() => {
                setupFilters();
                setupSearch();
            }, 50);
        }

        function updatePlanningTab(affiches) {
            const container = document.querySelector('#planningAffiches');
            if (!container) return;
            
            const affichesPlanning = affiches.filter(a => {
                if (a.statut === 'archivee') return false;
                return isAfficheActiveInWeek(a, currentWeekStart);
            });
            
            if (affichesPlanning.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        Aucune affiche active pour cette semaine
                    </div>
                `;
                return;
            }
            
            const planningHtml = affichesPlanning.map(affiche => {
                const iconClass = getFamilleIconClass(affiche.famille);
                const icon = getFamilleIcon(affiche.famille);
                const statusClass = `status-${affiche.statut}`;
                const statusText = getStatusText(affiche.statut);
                const dateDebut = formatDate(affiche.dateDebut);
                const dateFin = formatDate(affiche.dateFin);
                
                return `
                    <div class="planning-item ${statusClass}">
                        <div class="planning-item-icon ${iconClass}">${icon}</div>
                        <div class="planning-item-info">
                            <h4>${affiche.libelle}</h4>
                            <p>${affiche.prix}‚Ç¨/${affiche.unite} ‚Ä¢ ${affiche.origine}</p>
                            <p class="item-dates">${dateDebut} ‚Üí ${dateFin}</p>
                        </div>
                        <div class="planning-item-actions">
                            <span class="planning-status-badge ${statusClass}">${statusText}</span>
                            <div class="planning-item-actions-buttons">
                                <button class="action-btn edit-btn" onclick="editAffiche('${affiche.id}')">‚úèÔ∏è</button>
                                <button class="action-btn delete-btn" onclick="confirmDeleteAffiche('${affiche.id}', '${affiche.libelle}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = planningHtml;
        }

        // Fonctions utilitaires
        function getFamilleIconClass(famille) {
            const mapping = {
                'fruits-legumes': 'category-fruits',
                'traiteur': 'category-traiteur',
                'boucherie': 'category-boucherie',
                'cremerie': 'category-cremerie',
                'epicerie': 'category-epicerie',
                'boulangerie': 'category-boulangerie',
                'autre': 'category-autre'
            };
            return mapping[famille] || 'category-autre';
        }

        function getFamilleIcon(famille) {
            const mapping = {
                'fruits-legumes': 'üçé',
                'traiteur': 'ü•ò',
                'boucherie': 'ü•©',
                'cremerie': 'üßÄ',
                'epicerie': 'üõí',
                'boulangerie': 'ü•ñ',
                'autre': 'üì¶'
            };
            return mapping[famille] || 'üì¶';
        }

        function getStatusClass(statut) {
            return `status-${statut}`;
        }

        function getStatusText(statut) {
            const mapping = {
                'a-creer': '√Ä cr√©er',
                'programmee': 'Programm√©e',
                'en-diffusion': 'En diffusion',
                'archivee': 'Archiv√©e'
            };
            return mapping[statut] || 'Inconnu';
        }

        function getNotificationTypeLabel(type) {
            const mapping = {
                'creation': 'Cr√©ation d\'affiche',
                'creation_grouped': 'Cr√©ations group√©es',
                'diffusion': 'Mise en diffusion',
                'expiration': 'Alerte expiration',
                'archivage': 'Archivage',
                'daily_resume': 'R√©sum√© quotidien',
                'user_invited': 'Invitation utilisateur',
                'test': 'Test'
            };
            return mapping[type] || 'Notification';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit'
            });
        }

        function formatDateTime(date) {
            if (!date) return 'Jamais';
            const d = date instanceof Date ? date : date.toDate();
            return d.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Messages toast
        function showErrorMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ff4444;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Exposer les fonctions globalement
        window.loginUser = loginUser;
        window.logoutUser = logoutUser;
        window.saveAffiche = saveAffiche;
        window.updateAffiche = updateAffiche;
        window.deleteAffiche = deleteAffiche;
        window.loadAfficheForEdit = loadAfficheForEdit;
        window.saveOrigine = saveOrigine;
        window.updateOrigine = updateOrigine;
        window.deleteOrigine = deleteOrigine;
        window.loadOrigineForEdit = loadOrigineForEdit;
        window.saveUnite = saveUnite;
        window.updateUnite = updateUnite;
        window.deleteUnite = deleteUnite;
        window.loadUniteForEdit = loadUniteForEdit;
        window.inviteUser = inviteUser;
        window.updateUser = updateUser;
        window.deleteUser = deleteUser;
        window.loadUserForEdit = loadUserForEdit;
        window.testNotification = testNotification;
        window.saveEmailJSConfig = saveEmailJSConfig;
        window.testEmailJS = testEmailJS;
        window.sendPendingNotifications = sendPendingNotifications;
        window.loadPendingNotifications = loadPendingNotifications;
        window.checkAndUpdateAfficheStates = checkAndUpdateAfficheStates;
        window.fixCurrentStateDelays = fixCurrentStateDelays;
        window.startAutomaticStateChecker = startAutomaticStateChecker;
        window.showErrorMessage = showErrorMessage;
        window.showSuccessMessage = showSuccessMessage;
        window.getFamilleIconClass = getFamilleIconClass;
        window.getFamilleIcon = getFamilleIcon;
        window.getStatusClass = getStatusClass;
        window.getStatusText = getStatusText;
        window.formatDate = formatDate;
        window.formatDateTime = formatDateTime;
        window.updatePlanningTab = updatePlanningTab;
        // Exposer les fonctions push globalement
        window.initPushNotifications = initPushNotifications;
        window.registerServiceWorker = registerServiceWorker;
        window.updatePushUI = updatePushUI;
        window.isMobileDevice = isMobileDevice;

        // Marquer que les fonctions push sont charg√©es
        window.pushFunctionsLoaded = true;
        console.log('‚úÖ Fonctions push expos√©es globalement');
    </script>

    <script>
        // Variables globales pour le planning
        let currentWeekStart = new Date(2025, 6, 8);

        // Fonctions de l'interface
        function showTab(tabName) {
            console.log('üîÑ Changement vers onglet:', tabName);
            
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.tab').classList.add('active');
            
            if (tabName === 'planning') {
                console.log('üìÖ Initialisation onglet Planning...');
                setTimeout(updateWeekHeader, 50);
                
                if (window.lastLoadedAffiches && window.lastLoadedAffiches.length > 0) {
                    console.log('üîÑ Forcer mise √† jour planning avec donn√©es existantes:', window.lastLoadedAffiches.length, 'affiches');
                    window.updatePlanningTab(window.lastLoadedAffiches);
                }
            }
        }

        function showParamsTab(tabName) {
            const contents = document.querySelectorAll('.params-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.params-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + '-params').classList.add('active');
            event.target.closest('.params-tab').classList.add('active');
        }

        // Modals affiches
        function openModal() {
            document.getElementById('createModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        async function editAffiche(id) {
            const affiche = await window.loadAfficheForEdit(id);
            if (!affiche) return;
            
            document.getElementById('editAfficheId').value = affiche.id;
            document.getElementById('editLibelle').value = affiche.libelle || '';
            document.getElementById('editFamille').value = affiche.famille || '';
            document.getElementById('editPrix').value = affiche.prix || '';
            document.getElementById('editUnite').value = affiche.unite || '';
            document.getElementById('editOrigine').value = affiche.origine || '';
            document.getElementById('editStatut').value = affiche.statut || 'a-creer';
            
            if (affiche.dateDebut) {
                const dateDebut = new Date(affiche.dateDebut);
                document.getElementById('editDateDebut').value = dateDebut.toISOString().split('T')[0];
            }
            if (affiche.dateFin) {
                const dateFin = new Date(affiche.dateFin);
                document.getElementById('editDateFin').value = dateFin.toISOString().split('T')[0];
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function confirmDeleteAffiche(id, libelle) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'affiche :\n"${libelle}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteAffiche(id);
            }
        }

        // Modals utilisateurs
        function openInviteUserModal() {
            document.getElementById('inviteUserModal').style.display = 'block';
        }

        function closeInviteUserModal() {
            document.getElementById('inviteUserModal').style.display = 'none';
        }

        async function editUser(id) {
            const user = await window.loadUserForEdit(id);
            if (!user) return;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserFirstName').value = user.firstName || '';
            document.getElementById('editUserLastName').value = user.lastName || '';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserRole').value = user.role || 'employee';
            
            document.getElementById('editUserNotifCreation').checked = user.notificationPreferences?.creation || false;
            document.getElementById('editUserNotifDiffusion').checked = user.notificationPreferences?.diffusion || false;
            document.getElementById('editUserNotifExpiration').checked = user.notificationPreferences?.expiration || false;
            document.getElementById('editUserNotifArchivage').checked = user.notificationPreferences?.archivage || false;
            document.getElementById('editUserNotifResume').checked = user.notificationPreferences?.resume || false;
            
            document.getElementById('editUserCanalEmail').checked = user.notificationChannels?.email || false;
            document.getElementById('editUserCanalPush').checked = user.notificationChannels?.push || false;
            
            document.getElementById('editUserModal').style.display = 'block';
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        function confirmDeleteUser(id, name) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'utilisateur :\n"${name}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteUser(id);
            }
        }

        // Modals origines
        function openAddOriginModal() {
            document.getElementById('addOriginModal').style.display = 'block';
        }

        function closeAddOriginModal() {
            document.getElementById('addOriginModal').style.display = 'none';
        }

        async function editOrigine(id) {
            const origine = await window.loadOrigineForEdit(id);
            if (!origine) return;
            
            document.getElementById('editOriginId').value = origine.id;
            document.getElementById('editOrigineName').value = origine.nom || '';
            
            document.getElementById('editOriginModal').style.display = 'block';
        }

        function closeEditOriginModal() {
            document.getElementById('editOriginModal').style.display = 'none';
        }

        function confirmDeleteOrigine(id, nom) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'origine :\n"${nom}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteOrigine(id);
            }
        }

        // Modals unit√©s
        function openAddUniteModal() {
            document.getElementById('addUniteModal').style.display = 'block';
        }

        function closeAddUniteModal() {
            document.getElementById('addUniteModal').style.display = 'none';
        }

        async function editUnite(id) {
            const unite = await window.loadUniteForEdit(id);
            if (!unite) return;
            
            document.getElementById('editUniteId').value = unite.id;
            document.getElementById('editUniteName').value = unite.nom || '';
            
            document.getElementById('editUniteModal').style.display = 'block';
        }

        function closeEditUniteModal() {
            document.getElementById('editUniteModal').style.display = 'none';
        }

        function confirmDeleteUnite(id, nom) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'unit√© :\n"${nom}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteUnite(id);
            }
        }

        // Planning
        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            updateWeekHeader();
            
            if (window.lastLoadedAffiches && window.lastLoadedAffiches.length > 0) {
                console.log('üîÑ Mise √† jour planning apr√®s changement de semaine');
                window.updatePlanningTab(window.lastLoadedAffiches);
            }
        }

        function updateWeekHeader() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const months = [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ];
            
            const startDay = currentWeekStart.getDate();
            const endDay = weekEnd.getDate();
            const month = months[currentWeekStart.getMonth()];
            const year = currentWeekStart.getFullYear();
            
            const weekNumber = getWeekNumber(currentWeekStart);
            const weekRange = `${startDay} - ${endDay} ${month} ${year}`;
            
            const currentWeekElement = document.getElementById('currentWeek');
            const weekNumberElement = document.getElementById('weekNumber');
            
            if (currentWeekElement) {
                currentWeekElement.textContent = weekRange;
            }
            
            if (weekNumberElement) {
                weekNumberElement.textContent = `Semaine ${weekNumber}`;
            }
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function isAfficheActiveInWeek(affiche, weekStart) {
            if (!affiche.dateDebut || !affiche.dateFin) return false;
            
            const afficheDebut = new Date(affiche.dateDebut);
            const afficheFin = new Date(affiche.dateFin);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            afficheDebut.setHours(0, 0, 0, 0);
            afficheFin.setHours(23, 59, 59, 999);
            weekStart.setHours(0, 0, 0, 0);
            weekEnd.setHours(23, 59, 59, 999);
            
            return afficheDebut <= weekEnd && afficheFin >= weekStart;
        }

        // Recherche et filtres
        function setupSearch() {
            const affichesSearch = document.querySelector('#affiches .search-bar input');
            if (affichesSearch) {
                affichesSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const items = document.querySelectorAll('#affiches .item');
                    
                    items.forEach(item => {
                        const title = item.querySelector('h4').textContent.toLowerCase();
                        const description = item.querySelector('p').textContent.toLowerCase();
                        
                        if (title.includes(searchTerm) || description.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn-affiches').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filterValue = this.dataset.filter;
                    filterAffiches(filterValue);
                });
            });
        }

        function filterAffiches(status) {
            const items = document.querySelectorAll('#affiches .item');
            const filterBtns = document.querySelectorAll('.filter-btn-affiches');
            
            filterBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-btn-affiches[data-filter="${status}"]`).classList.add('active');
            
            items.forEach(item => {
                if (status === 'all' || item.dataset.status === status) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // Fermer modals en cliquant dehors
        window.onclick = function(event) {
            const modals = [
                'createModal', 'editModal', 'inviteUserModal', 'editUserModal',
                'addOriginModal', 'editOriginModal', 'addUniteModal', 'editUniteModal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // D√©finir les dates par d√©faut
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            const dateDebutInput = document.getElementById('dateDebut');
            const dateFinInput = document.getElementById('dateFin');
            
            if (dateDebutInput) dateDebutInput.valueAsDate = today;
            if (dateFinInput) dateFinInput.valueAsDate = nextWeek;

            // Event listener pour la connexion
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                window.loginUser();
            });

            // Event listener pour cr√©ation d'affiche
            document.getElementById('createForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                let origine = formData.get('origine');
                let unite = formData.get('unite');
                
                if (origine === 'autre') {
                    origine = prompt('Entrez le nom de la nouvelle origine:');
                    if (!origine) return;
                    
                    try {
                        await window.saveOrigine({ nom: origine });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'origine');
                        return;
                    }
                }
                
                if (unite === 'autre') {
                    unite = prompt('Entrez le nom de la nouvelle unit√©:');
                    if (!unite) return;
                    
                    try {
                        await window.saveUnite({ nom: unite });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'unit√©');
                        return;
                    }
                }
                
                const affiche = {
                    libelle: formData.get('libelle'),
                    famille: formData.get('famille'),
                    dateDebut: formData.get('dateDebut'),
                    dateFin: formData.get('dateFin'),
                    prix: parseFloat(formData.get('prix')),
                    unite: unite,
                    origine: origine,
                    statut: 'a-creer'
                };
                
                try {
                    await window.saveAffiche(affiche);
                    window.showSuccessMessage('üéâ Affiche cr√©√©e avec succ√®s!');
                    closeModal();
                    this.reset();
                    
                    const today = new Date();
                    const nextWeek = new Date();
                    nextWeek.setDate(today.getDate() + 7);
                    document.getElementById('dateDebut').valueAsDate = today;
                    document.getElementById('dateFin').valueAsDate = nextWeek;
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la cr√©ation: ' + error.message);
                }
            });

            // Event listener pour modification d'affiche
            document.getElementById('editForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const afficheId = formData.get('editAfficheId');
                
                let origine = formData.get('editOrigine');
                let unite = formData.get('editUnite');
                
                if (origine === 'autre') {
                    origine = prompt('Entrez le nom de la nouvelle origine:');
                    if (!origine) return;
                    
                    try {
                        await window.saveOrigine({ nom: origine });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'origine');
                        return;
                    }
                }
                
                if (unite === 'autre') {
                    unite = prompt('Entrez le nom de la nouvelle unit√©:');
                    if (!unite) return;
                    
                    try {
                        await window.saveUnite({ nom: unite });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'unit√©');
                        return;
                    }
                }
                
                const updatedData = {
                    libelle: formData.get('editLibelle'),
                    famille: formData.get('editFamille'),
                    dateDebut: formData.get('editDateDebut'),
                    dateFin: formData.get('editDateFin'),
                    prix: parseFloat(formData.get('editPrix')),
                    unite: unite,
                    origine: origine,
                    statut: formData.get('editStatut')
                };
                
                try {
                    await window.updateAffiche(afficheId, updatedData);
                    closeEditModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listener pour invitation d'utilisateur
            document.getElementById('inviteUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const userData = {
                    email: formData.get('inviteEmail'),
                    firstName: formData.get('inviteFirstName'),
                    lastName: formData.get('inviteLastName'),
                    role: formData.get('inviteRole'),
                    defaultEmail: document.getElementById('inviteDefaultEmail').checked,
                    defaultPush: document.getElementById('inviteDefaultPush').checked
                };
                
                try {
                    await window.inviteUser(userData);
                    closeInviteUserModal();
                    this.reset();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de l\'invitation: ' + error.message);
                }
            });

            // Event listener pour modification d'utilisateur
            document.getElementById('editUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const userId = formData.get('editUserId');
                
                const updatedData = {
                    firstName: formData.get('editUserFirstName'),
                    lastName: formData.get('editUserLastName'),
                    role: formData.get('editUserRole'),
                    notificationPreferences: {
                        creation: document.getElementById('editUserNotifCreation').checked,
                        diffusion: document.getElementById('editUserNotifDiffusion').checked,
                        expiration: document.getElementById('editUserNotifExpiration').checked,
                        archivage: document.getElementById('editUserNotifArchivage').checked,
                        resume: document.getElementById('editUserNotifResume').checked
                    },
                    notificationChannels: {
                        email: document.getElementById('editUserCanalEmail').checked,
                        push: document.getElementById('editUserCanalPush').checked
                    }
                };
                
                try {
                    await window.updateUser(userId, updatedData);
                    closeEditUserModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listener pour ajout d'origine
            document.getElementById('addOriginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const origine = {
                    nom: formData.get('origineName').trim()
                };
                
                if (window.origines.some(o => o.nom.toLowerCase() === origine.nom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette origine existe d√©j√†');
                    return;
                }
                
                try {
                    await window.saveOrigine(origine);
                    window.showSuccessMessage(`üéâ Origine "${origine.nom}" ajout√©e avec succ√®s!`);
                    closeAddOriginModal();
                    this.reset();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de l\'ajout: ' + error.message);
                }
            });

            // Event listener pour modification d'origine
            document.getElementById('editOriginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const origineId = formData.get('editOriginId');
                const nouveauNom = formData.get('editOrigineName').trim();
                
                if (window.origines.some(o => o.id !== origineId && o.nom.toLowerCase() === nouveauNom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette origine existe d√©j√†');
                    return;
                }
                
                const updatedData = {
                    nom: nouveauNom
                };
                
                try {
                    await window.updateOrigine(origineId, updatedData);
                    closeEditOriginModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listener pour ajout d'unit√©
            document.getElementById('addUniteForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const unite = {
                    nom: formData.get('uniteName').trim()
                };
                
                if (window.unites.some(u => u.nom.toLowerCase() === unite.nom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette unit√© existe d√©j√†');
                    return;
                }
                
                try {
                    await window.saveUnite(unite);
                    window.showSuccessMessage(`üéâ Unit√© "${unite.nom}" ajout√©e avec succ√®s!`);
                    closeAddUniteModal();
                    this.reset();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de l\'ajout: ' + error.message);
                }
            });

            // Event listener pour modification d'unit√©
            document.getElementById('editUniteForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const uniteId = formData.get('editUniteId');
                const nouveauNom = formData.get('editUniteName').trim();
                
                if (window.unites.some(u => u.id !== uniteId && u.nom.toLowerCase() === nouveauNom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette unit√© existe d√©j√†');
                    return;
                }
                
                const updatedData = {
                    nom: nouveauNom
                };
                
                try {
                    await window.updateUnite(uniteId, updatedData);
                    closeEditUniteModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listeners pour les pr√©f√©rences de notification
            document.querySelectorAll('#notifications-params input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    if (window.currentUserData) {
                        const prefType = this.id.replace('notif-', '').replace('canal-', '');
                        
                        try {
                            if (this.id.startsWith('notif-')) {
                                window.currentUserData.notificationPreferences[prefType] = this.checked;
                            } else if (this.id.startsWith('canal-')) {
                                window.currentUserData.notificationChannels[prefType] = this.checked;
                            }
                            
                            await window.updateUser(window.currentUserData.id, {
                                notificationPreferences: window.currentUserData.notificationPreferences,
                                notificationChannels: window.currentUserData.notificationChannels
                            });
                            
                            window.showSuccessMessage('‚úÖ Pr√©f√©rences mises √† jour');
                        } catch (error) {
                            window.showErrorMessage('‚ùå Erreur lors de la sauvegarde');
                            this.checked = !this.checked;
                        }
                    }
                });
            });
        });

        // Fonction wrapper pour demander les permissions push
        async function handleRequestPushPermission() {
            try {
                console.log('üîë Demande permissions push...');
                
                // Attendre que les fonctions Firebase soient charg√©es
                let retries = 0;
                const maxRetries = 10;
                
                while (retries < maxRetries && typeof window.requestPushPermission !== 'function') {
                    console.log('‚è≥ Attente chargement fonctions push...', retries + 1);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retries++;
                }
                
                if (typeof window.requestPushPermission === 'function') {
                    await window.requestPushPermission();
                } else {
                    throw new Error('Fonctions push non disponibles apr√®s attente');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur demande permissions push:', error);
                
                // Fallback : demander directement les permissions navigateur
                if ('Notification' in window) {
                    try {
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            window.showSuccessMessage('‚úÖ Permissions accord√©es ! Rechargez la page pour finaliser.');
                            
                            // Mettre √† jour l'interface
                            if (typeof window.updatePushUI === 'function') {
                                window.updatePushUI();
                            }
                        } else {
                            window.showErrorMessage('‚ùå Permissions refus√©es');
                        }
                    } catch (fallbackError) {
                        console.error('‚ùå Erreur fallback:', fallbackError);
                        window.showErrorMessage('‚ùå Impossible de demander les permissions');
                    }
                } else {
                    window.showErrorMessage('‚ùå Notifications non support√©es par ce navigateur');
                }
            }
        }

        // Exposer les fonctions n√©cessaires globalement
        window.showTab = showTab;
        window.showParamsTab = showParamsTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.editAffiche = editAffiche;
        window.closeEditModal = closeEditModal;
        window.confirmDeleteAffiche = confirmDeleteAffiche;
        window.openInviteUserModal = openInviteUserModal;
        window.closeInviteUserModal = closeInviteUserModal;
        window.editUser = editUser;
        window.closeEditUserModal = closeEditUserModal;
        window.confirmDeleteUser = confirmDeleteUser;
        window.openAddOriginModal = openAddOriginModal;
        window.closeAddOriginModal = closeAddOriginModal;
        window.editOrigine = editOrigine;
        window.closeEditOriginModal = closeEditOriginModal;
        window.confirmDeleteOrigine = confirmDeleteOrigine;
        window.openAddUniteModal = openAddUniteModal;
        window.closeAddUniteModal = closeAddUniteModal;
        window.editUnite = editUnite;
        window.closeEditUniteModal = closeEditUniteModal;
        window.confirmDeleteUnite = confirmDeleteUnite;
        window.changeWeek = changeWeek;
        window.updateWeekHeader = updateWeekHeader;
        window.handleRequestPushPermission = handleRequestPushPermission;
    </script>
</body>
</html>
