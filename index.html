<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestion Affichage Publicitaire</title>
    
    <!-- PWA Configuration -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestion Affichage">
    <meta name="theme-color" content="#667eea">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-logo {
            font-size: 20px;
        }

        .header h1 {
            font-size: 18px;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .user-initials {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 70px;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .tab-icon {
            font-size: 16px;
        }

        .tab-text {
            font-size: 10px;
        }

        .tab-content {
            display: none;
            padding: 20px;
            height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 12px;
            min-height: 60px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 12px;
            opacity: 0.9;
        }

        .recent-items {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .recent-items h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            min-height: 30px;
            background: linear-gradient(135deg, #fef7ff 0%, #fdf2f8 100%);
            color: #333;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .item:nth-child(even) {
            background: linear-gradient(135deg, #f8faff 0%, #f1f5f9 100%);
        }

        .item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            color: white;
        }

        .item-info {
            flex: 1;
        }

        .item-info h4 {
            font-size: 14px;
            margin-bottom: 3px;
            color: #333;
        }

        .item-info p {
            font-size: 12px;
            color: #666;
        }

        .item-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .item-actions-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn {
            background: #e3f2fd;
            color: #1976d2;
        }

        .edit-btn:hover {
            background: #1976d2;
            color: white;
            transform: scale(1.1);
        }

        .delete-btn {
            background: #ffebee;
            color: #d32f2f;
        }

        .delete-btn:hover {
            background: #d32f2f;
            color: white;
            transform: scale(1.1);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .status-a-creer {
            background: #fff3cd;
            color: #856404;
        }

        .status-programmee {
            background: #d4edda;
            color: #155724;
        }

        .status-en-diffusion {
            background: #cce5ff;
            color: #004085;
        }

        .status-archivee {
            background: #f8d7da;
            color: #721c24;
        }

        .category-fruits { background: #4CAF50; }
        .category-traiteur { background: #FF9800; }
        .category-boucherie { background: #F44336; }
        .category-cremerie { background: #2196F3; }
        .category-epicerie { background: #9C27B0; }
        .category-boulangerie { background: #FF5722; }
        .category-autre { background: #607D8B; }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
        }

        .search-bar::after {
            content: "üîç";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .filter-section h4 {
            margin-bottom: 12px;
            font-size: 14px;
            color: #333;
        }

        .filter-buttons {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .filter-btn, .filter-btn-affiches {
            padding: 6px 8px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: capitalize;
            white-space: nowrap;
        }

        .filter-btn.active, .filter-btn-affiches.active,
        .filter-btn:hover, .filter-btn-affiches:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .item.hidden {
            display: none;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 16px;
            border-radius: 12px;
            max-width: 90%;
            width: 350px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .form-row .form-group {
            margin-bottom: 12px;
        }

        .form-row .form-group label {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .form-row .form-group input,
        .form-row .form-group select {
            padding: 7px 8px;
            font-size: 13px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .alert-error {
            background: #ffebee;
            border: 1px solid #f8bbd9;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            color: #2e7d2e;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* Param√®tres sous-onglets */
        .params-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .params-tab {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            border-right: 1px solid #e9ecef;
        }

        .params-tab:last-child {
            border-right: none;
        }

        .params-tab.active {
            background: #667eea;
            color: white;
        }

        .params-tab-icon {
            font-size: 16px;
        }

        .params-content {
            display: none;
        }

        .params-content.active {
            display: block;
        }

        .param-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }

        .param-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .param-item:last-child {
            margin-bottom: 0;
        }

        .param-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .param-actions {
            display: flex;
            gap: 8px;
        }

        .add-param-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-param-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .empty-params {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px 20px;
        }

        /* Planning styles */
        .agenda-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .week-info {
            text-align: center;
        }

        .week-info h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .week-info p {
            margin: 2px 0 0 0;
            font-size: 12px;
            color: #666;
            font-weight: 400;
        }

        .planning-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .planning-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            min-height: 40px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            border-left: 4px solid transparent;
        }

        .planning-item.status-a-creer {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
        }

        .planning-item.status-programmee {
            border-left-color: #fd7e14;
            background: linear-gradient(135deg, #fff8f1 0%, #fef3e2 100%);
        }

        .planning-item.status-en-diffusion {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%);
        }

        .planning-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            color: white;
        }

        .planning-item-info {
            flex: 1;
        }

        .planning-item-info h4 {
            font-size: 14px;
            margin-bottom: 3px;
            color: #333;
        }

        .planning-item-info p {
            font-size: 12px;
            color: #666;
        }

        .planning-item-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .planning-item-actions-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .planning-status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .planning-status-badge.status-a-creer {
            background: #dc3545;
            color: white;
        }

        .planning-status-badge.status-programmee {
            background: #fd7e14;
            color: white;
        }

        .planning-status-badge.status-en-diffusion {
            background: #28a745;
            color: white;
        }

        .nav-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        /* Notifications & Users styles */
        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .settings-card h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info h5 {
            margin: 0 0 4px 0;
            font-size: 14px;
            color: #333;
        }

        .setting-info p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        /* User card styles */
        .user-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .user-main-info {
            flex: 1;
            margin-left: 15px;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .user-email {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .user-role {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .user-role.admin {
            background: #fff3e0;
            color: #f57c00;
        }

        .user-preferences {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .user-pref-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .notification-prefs {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .pref-option {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .pref-icon {
            font-size: 14px;
        }

        .pref-icon.active {
            color: #28a745;
        }

        .pref-icon.inactive {
            color: #dc3545;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-status {
            margin-top: 8px;
            font-size: 11px;
            color: #666;
        }

        .status-online {
            color: #28a745;
        }

        .status-offline {
            color: #6c757d;
        }

        /* Checkbox styles */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            font-size: 13px;
            color: #333;
            margin: 0;
        }

        /* Notification history */
        .notification-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .notification-type {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .notification-time {
            font-size: 11px;
            color: #666;
        }

        .notification-message {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .notification-status {
            margin-top: 5px;
            font-size: 10px;
            color: #28a745;
        }

        .notification-status.failed {
            color: #dc3545;
        }

        #loginModal {
            z-index: 2000;
        }

        #loginModal .modal-content {
            width: 320px;
        }

        /* Test notification button */
        .test-notification-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .test-notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        }

        /* Responsive */
        @media screen and (max-width: 420px) {
            .container {
                max-width: 100%;
                box-shadow: none;
            }
            
            .modal-content {
                width: 95%;
                max-width: 350px;
            }
            
            .form-row {
                grid-template-columns: 1fr 1fr !important;
                gap: 6px !important;
            }
        }

    </style>
</head>
<body>
    <!-- Modal de connexion -->
    <div id="loginModal" class="modal" style="display:block;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Connexion</h3>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" name="loginEmail" required placeholder="test@exemple.com">
                </div>

                <div class="form-group">
                    <label for="loginPassword">Mot de passe</label>
                    <input type="password" id="loginPassword" name="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <div id="loginError" class="alert-error" style="display:none;"></div>

                <button type="submit" class="btn">üîì Se connecter</button>
                
                <p style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                    Cr√©ez un compte dans la console Firebase ou utilisez un compte de test
                </p>
            </form>
        </div>
    </div>

    <!-- Application principale -->
    <div id="appContainer" class="container" style="display:none;">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">üì∫</div>
                <h1>Gestion Affichage</h1>
            </div>
            <div class="user-info">
                <div id="currentUserInitials" class="user-initials">UP</div>
                <button onclick="logoutUser()" class="logout-btn">üö™ D√©connexion</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('dashboard')">
                <div class="tab-icon">üìä</div>
                <div class="tab-text">Dashboard</div>
            </div>
            <div class="tab" onclick="showTab('planning')">
                <div class="tab-icon">üìÖ</div>
                <div class="tab-text">Planning</div>
            </div>
            <div class="tab" onclick="showTab('affiches')">
                <div class="tab-icon">üìã</div>
                <div class="tab-text">Affiches</div>
            </div>
            <div class="tab" onclick="showTab('parametres')">
                <div class="tab-icon">‚öôÔ∏è</div>
                <div class="tab-text">Param√®tres</div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>0</h3>
                    <p>En diffusion</p>
                </div>
                <div class="stat-card">
                    <h3>0</h3>
                    <p>√Ä cr√©er</p>
                </div>
                <div class="stat-card">
                    <h3>0</h3>
                    <p>Programm√©es</p>
                </div>
                <div class="stat-card">
                    <h3>0</h3>
                    <p>Archiv√©es</p>
                </div>
            </div>

            <div class="recent-items">
                <h3>üì∫ Affiches en diffusion</h3>
                <div class="empty-state">
                    Aucune affiche en diffusion pour le moment
                </div>
            </div>

            <div class="settings-card">
                <h4>üìà Statistiques des notifications</h4>
                <div class="setting-item">
                    <div class="setting-info">
                        <h5>Notifications envoy√©es aujourd'hui</h5>
                        <p id="todayNotifications">0 notification(s)</p>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h5>Utilisateurs actifs</h5>
                        <p id="activeUsers">0 utilisateur(s) connect√©(s)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Planning -->
        <div id="planning" class="tab-content">
            <div class="agenda-header">
                <button class="nav-btn" onclick="changeWeek(-1)">‚Äπ</button>
                <div class="week-info">
                    <h3 id="currentWeek">8 - 14 Juillet 2025</h3>
                    <p id="weekNumber">Semaine 28</p>
                </div>
                <button class="nav-btn" onclick="changeWeek(1)">‚Ä∫</button>
            </div>
            
            <div id="planningAffiches" class="planning-container">
                <div class="empty-state">
                    Aucune affiche √† planifier pour le moment
                </div>
            </div>
        </div>

        <!-- Affiches -->
        <div id="affiches" class="tab-content">
            <div class="search-bar">
                <input type="text" placeholder="Rechercher une affiche...">
            </div>
            
            <div class="filter-section">
                <h4>üîç Filtrer par √©tat</h4>
                <div class="filter-buttons">
                    <button class="filter-btn-affiches active" data-filter="all">Tous</button>
                    <button class="filter-btn-affiches" data-filter="a-creer">√Ä cr√©er</button>
                    <button class="filter-btn-affiches" data-filter="programmee">Prog.</button>
                    <button class="filter-btn-affiches" data-filter="en-diffusion">Diff.</button>
                    <button class="filter-btn-affiches" data-filter="archivee">Archiv.</button>
                </div>
            </div>
            
            <div class="empty-state">
                Aucune affiche cr√©√©e pour le moment.<br>
                Cliquez sur le bouton + pour cr√©er votre premi√®re affiche !
            </div>
        </div>

        <!-- Users (supprim√© car int√©gr√© dans Param√®tres) -->

        <!-- Param√®tres -->
        <div id="parametres" class="tab-content">
            <div class="params-tabs">
                <div class="params-tab active" onclick="showParamsTab('origines')">
                    <div class="params-tab-icon">üåç</div>
                    <div>Origines</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('unites')">
                    <div class="params-tab-icon">üè∑Ô∏è</div>
                    <div>Unit√©s</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('notifications')">
                    <div class="params-tab-icon">üîî</div>
                    <div>Notifs</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('users')">
                    <div class="params-tab-icon">üë•</div>
                    <div>Users</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('systeme')">
                    <div class="params-tab-icon">‚öôÔ∏è</div>
                    <div>Syst√®me</div>
                </div>
            </div>

            <!-- Gestion des Origines -->
            <div id="origines-params" class="params-content active">
                <button class="add-param-btn" onclick="openAddOriginModal()">
                    ‚ûï Ajouter une origine
                </button>
                
                <div id="originesList" class="param-list">
                    <div class="empty-params">
                        Aucune origine configur√©e.<br>
                        Cliquez sur "Ajouter une origine" pour commencer.
                    </div>
                </div>
            </div>

            <!-- Gestion des Unit√©s -->
            <div id="unites-params" class="params-content">
                <button class="add-param-btn" onclick="openAddUniteModal()">
                    ‚ûï Ajouter une unit√©
                </button>
                
                <div id="unitesList" class="param-list">
                    <div class="empty-params">
                        Aucune unit√© configur√©e.<br>
                        Cliquez sur "Ajouter une unit√©" pour commencer.
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div id="notifications-params" class="params-content">
                <div class="settings-card">
                    <h4>‚öôÔ∏è Mes pr√©f√©rences de notification</h4>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Cr√©ations d'affiches</h5>
                            <p>Notifier √† chaque cr√©ation</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-creation" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Mises en diffusion</h5>
                            <p>Notifier lors du d√©marrage</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-diffusion" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Notifications d'expiration</h5>
                            <p>Alerter 24h avant expiration</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-expiration" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Archivage automatique</h5>
                            <p>Notifier √† la fin de diffusion</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-archivage" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>R√©sum√© quotidien</h5>
                            <p>Envoi √† 08h00 chaque jour</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notif-resume" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-card">
                    <h4>üìß Canal de notification pr√©f√©r√©</h4>
                    
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="canal-email" checked>
                            <label for="canal-email">üìß Notifications par email</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="canal-push" checked>
                            <label for="canal-push">üîî Notifications push (navigateur)</label>
                        </div>
                    </div>

                    <button class="test-notification-btn" onclick="testNotification()">
                        üß™ Tester les notifications
                    </button>
                </div>

                <div class="settings-card">
                    <h4>üìù Historique des notifications</h4>
                    <div id="notificationHistory">
                        <div class="empty-state">
                            Aucune notification envoy√©e r√©cemment
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users -->
            <div id="users-params" class="params-content">
                <button class="add-param-btn" onclick="openInviteUserModal()">
                    ‚úâÔ∏è Inviter un utilisateur
                </button>

                <div class="settings-card">
                    <h4>üë• Utilisateurs de l'application (Max 6)</h4>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Utilisateurs enregistr√©s</h5>
                            <p id="totalUsers">0 utilisateur(s)</p>
                        </div>
                    </div>
                </div>
                
                <div id="usersList">
                    <div class="empty-state">
                        Aucun utilisateur suppl√©mentaire.<br>
                        Invitez des coll√®gues pour collaborer !
                    </div>
                </div>
            </div>
            <div id="systeme-params" class="params-content">
                <div class="settings-card">
                    <h4>üìß Configuration SMTP</h4>
                    <div class="form-group">
                        <label>Serveur SMTP</label>
                        <input type="text" id="smtp-server" value="smtp.gmail.com" placeholder="smtp.exemple.com">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" id="smtp-port" value="587" placeholder="587">
                        </div>
                        <div class="form-group">
                            <label>S√©curit√©</label>
                            <select id="smtp-security">
                                <option value="tls" selected>TLS</option>
                                <option value="ssl">SSL</option>
                                <option value="none">Aucune</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email exp√©diteur</label>
                        <input type="email" id="smtp-sender" value="latilledistribution@gmail.com" placeholder="votre@email.com">
                    </div>
                    <div class="form-group">
                        <label>Mot de passe application</label>
                        <input type="password" id="smtp-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn" onclick="saveSmtpConfig()">üíæ Sauvegarder la configuration</button>
                    <button class="test-notification-btn" onclick="testSmtpConnection()">
                        üîó Tester la connexion SMTP
                    </button>
                </div>

                <div class="settings-card">
                    <h4>üîß Param√®tres syst√®me</h4>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Archivage automatique</h5>
                            <p>Archiver les affiches expir√©es automatiquement</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="auto-archive" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Notifications push</h5>
                            <p>Activer les notifications push pour tous</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="push-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <button class="fab" onclick="openModal()">+</button>
    </div>

    <!-- Modal de cr√©ation d'affiche -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Nouvelle affiche</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <form id="createForm">
                <div class="form-group">
                    <label for="libelle">Libell√© *</label>
                    <input type="text" id="libelle" name="libelle" placeholder="Ex: Pommes Golden" required>
                </div>

                <div class="form-group">
                    <label for="famille">Famille *</label>
                    <select id="famille" name="famille" required>
                        <option value="">Choisir une famille</option>
                        <option value="fruits-legumes">üçé Fruits & l√©gumes</option>
                        <option value="traiteur">ü•ò Traiteur</option>
                        <option value="boucherie">ü•© Boucherie</option>
                        <option value="cremerie">üßÄ Cr√©merie</option>
                        <option value="epicerie">üõí Epicerie</option>
                        <option value="boulangerie">ü•ñ Boulangerie</option>
                        <option value="autre">üì¶ Autre</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dateDebut">D√©but *</label>
                        <input type="date" id="dateDebut" name="dateDebut" required>
                    </div>
                    <div class="form-group">
                        <label for="dateFin">Fin *</label>
                        <input type="date" id="dateFin" name="dateFin" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="prix">Prix *</label>
                        <input type="number" id="prix" name="prix" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="unite">Unit√© *</label>
                        <select id="unite" name="unite" required>
                            <option value="">Choisir une unit√©</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="origine">Origine *</label>
                    <select id="origine" name="origine" required>
                        <option value="">Choisir une origine</option>
                    </select>
                </div>

                <button type="submit" class="btn">‚úÖ Cr√©er l'affiche</button>
            </form>
        </div>
    </div>

    <!-- Modal d'√©dition d'affiche -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'affiche</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            
            <form id="editForm">
                <input type="hidden" id="editAfficheId" name="editAfficheId">
                
                <div class="form-group">
                    <label for="editLibelle">Libell√© *</label>
                    <input type="text" id="editLibelle" name="editLibelle" placeholder="Ex: Pommes Golden" required>
                </div>

                <div class="form-group">
                    <label for="editFamille">Famille *</label>
                    <select id="editFamille" name="editFamille" required>
                        <option value="">Choisir une famille</option>
                        <option value="fruits-legumes">üçé Fruits & l√©gumes</option>
                        <option value="traiteur">ü•ò Traiteur</option>
                        <option value="boucherie">ü•© Boucherie</option>
                        <option value="cremerie">üßÄ Cr√©merie</option>
                        <option value="epicerie">üõí Epicerie</option>
                        <option value="boulangerie">ü•ñ Boulangerie</option>
                        <option value="autre">üì¶ Autre</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editDateDebut">D√©but *</label>
                        <input type="date" id="editDateDebut" name="editDateDebut" required>
                    </div>
                    <div class="form-group">
                        <label for="editDateFin">Fin *</label>
                        <input type="date" id="editDateFin" name="editDateFin" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPrix">Prix *</label>
                        <input type="number" id="editPrix" name="editPrix" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="editUnite">Unit√© *</label>
                        <select id="editUnite" name="editUnite" required>
                            <option value="">Choisir une unit√©</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editOrigine">Origine *</label>
                    <select id="editOrigine" name="editOrigine" required>
                        <option value="">Choisir une origine</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editStatut">Statut *</label>
                    <select id="editStatut" name="editStatut" required>
                        <option value="a-creer">√Ä cr√©er</option>
                        <option value="programmee">Programm√©e</option>
                        <option value="en-diffusion">En diffusion</option>
                        <option value="archivee">Archiv√©e</option>
                    </select>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <!-- Modal d'invitation d'utilisateur -->
    <div id="inviteUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úâÔ∏è Inviter un utilisateur</h3>
                <span class="close" onclick="closeInviteUserModal()">&times;</span>
            </div>
            
            <form id="inviteUserForm">
                <div class="form-group">
                    <label for="inviteEmail">Email *</label>
                    <input type="email" id="inviteEmail" name="inviteEmail" placeholder="collegue@exemple.com" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="inviteFirstName">Pr√©nom *</label>
                        <input type="text" id="inviteFirstName" name="inviteFirstName" placeholder="Jean" required>
                    </div>
                    <div class="form-group">
                        <label for="inviteLastName">Nom *</label>
                        <input type="text" id="inviteLastName" name="inviteLastName" placeholder="Dupont" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="inviteRole">Fonction *</label>
                    <select id="inviteRole" name="inviteRole" required>
                        <option value="">Choisir une fonction</option>
                        <option value="admin">üëë Administrateur</option>
                        <option value="employee">üë§ Employ√©</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Pr√©f√©rences de notification par d√©faut</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="inviteDefaultEmail" checked>
                            <label for="inviteDefaultEmail">üìß Notifications par email</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="inviteDefaultPush" checked>
                            <label for="inviteDefaultPush">üîî Notifications push</label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">‚úâÔ∏è Envoyer l'invitation</button>
            </form>
        </div>
    </div>

    <!-- Modal d'√©dition d'utilisateur -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'utilisateur</h3>
                <span class="close" onclick="closeEditUserModal()">&times;</span>
            </div>
            
            <form id="editUserForm">
                <input type="hidden" id="editUserId" name="editUserId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editUserFirstName">Pr√©nom *</label>
                        <input type="text" id="editUserFirstName" name="editUserFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserLastName">Nom *</label>
                        <input type="text" id="editUserLastName" name="editUserLastName" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editUserEmail">Email *</label>
                    <input type="email" id="editUserEmail" name="editUserEmail" required readonly>
                </div>

                <div class="form-group">
                    <label for="editUserRole">Fonction *</label>
                    <select id="editUserRole" name="editUserRole" required>
                        <option value="admin">üëë Administrateur</option>
                        <option value="employee">üë§ Employ√©</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Pr√©f√©rences de notification</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifCreation">
                            <label for="editUserNotifCreation">Cr√©ations d'affiches</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifDiffusion">
                            <label for="editUserNotifDiffusion">Mises en diffusion</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifExpiration">
                            <label for="editUserNotifExpiration">Alertes d'expiration</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifArchivage">
                            <label for="editUserNotifArchivage">Archivage automatique</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserNotifResume">
                            <label for="editUserNotifResume">R√©sum√© quotidien</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Canal de notification</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserCanalEmail">
                            <label for="editUserCanalEmail">üìß Email</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="editUserCanalPush">
                            <label for="editUserCanalPush">üîî Push</label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <!-- Modals pour origines et unit√©s (inchang√©s) -->
    <div id="addOriginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üåç Nouvelle origine</h3>
                <span class="close" onclick="closeAddOriginModal()">&times;</span>
            </div>
            
            <form id="addOriginForm">
                <div class="form-group">
                    <label for="origineName">Nom de l'origine *</label>
                    <input type="text" id="origineName" name="origineName" placeholder="Ex: France, Espagne..." required>
                </div>

                <button type="submit" class="btn">‚úÖ Ajouter</button>
            </form>
        </div>
    </div>

    <div id="editOriginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'origine</h3>
                <span class="close" onclick="closeEditOriginModal()">&times;</span>
            </div>
            
            <form id="editOriginForm">
                <input type="hidden" id="editOriginId" name="editOriginId">
                
                <div class="form-group">
                    <label for="editOrigineName">Nom de l'origine *</label>
                    <input type="text" id="editOrigineName" name="editOrigineName" placeholder="Ex: France, Espagne..." required>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <div id="addUniteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üè∑Ô∏è Nouvelle unit√©</h3>
                <span class="close" onclick="closeAddUniteModal()">&times;</span>
            </div>
            
            <form id="addUniteForm">
                <div class="form-group">
                    <label for="uniteName">Nom de l'unit√© *</label>
                    <input type="text" id="uniteName" name="uniteName" placeholder="Ex: Kg, Pi√®ce, Barquette..." required>
                </div>

                <button type="submit" class="btn">‚úÖ Ajouter</button>
            </form>
        </div>
    </div>

    <div id="editUniteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'unit√©</h3>
                <span class="close" onclick="closeEditUniteModal()">&times;</span>
            </div>
            
            <form id="editUniteForm">
                <input type="hidden" id="editUniteId" name="editUniteId">
                
                <div class="form-group">
                    <label for="editUniteName">Nom de l'unit√© *</label>
                    <input type="text" id="editUniteName" name="editUniteName" placeholder="Ex: Kg, Pi√®ce, Barquette..." required>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, serverTimestamp, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAtZUiFPFrqU-PiMpIOrPIwrjJLv_NsKRU",
            authDomain: "gestion-affichage-publicitaire.firebaseapp.com",
            projectId: "gestion-affichage-publicitaire",
            storageBucket: "gestion-affichage-publicitaire.firebasestorage.app",
            messagingSenderId: "715445646165",
            appId: "1:715445646165:web:4da37e196e6a772f0735dc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.currentUser = null;
        window.currentUserData = null;
        window.origines = [];
        window.unites = [];
        window.users = [];
        window.notifications = [];

        // Variables globales pour les notifications
        window.swRegistration = null;

        // Initialiser les notifications push
        async function initPushNotifications() {
            console.log('üîî Initialisation des notifications push...');
            
            if ('Notification' in window) {
                console.log('‚úÖ Support notifications d√©tect√©');
                
                try {
                    // Demander permission d'abord
                    let permission = Notification.permission;
                    console.log('üìã Permission initiale:', permission);
                    
                    if (permission === 'default') {
                        permission = await Notification.requestPermission();
                        console.log('üìã Permission apr√®s demande:', permission);
                    }
                    
                    if (permission === 'granted') {
                        console.log('‚úÖ Notifications push activ√©es');
                        
                        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                        console.log('üì± Appareil mobile d√©tect√©:', isMobile);
                        
                        // Pour mobile : Service Worker obligatoire
                        if (isMobile && 'serviceWorker' in navigator) {
                            try {
                                console.log('üì± Configuration Service Worker pour mobile...');
                                
                                // Service Worker sp√©cialement con√ßu pour mobile
                                const registration = await navigator.serviceWorker.register(
                                    'data:application/javascript;base64,' + btoa(`
                                        console.log('üì± Service Worker mobile d√©marr√©');
                                        
                                        self.addEventListener('push', function(event) {
                                            console.log('üì± Push re√ßu dans SW mobile');
                                            const options = {
                                                body: event.data ? event.data.text() : 'Nouvelle notification',
                                                icon: '/android-chrome-192x192.png',
                                                badge: '/android-chrome-192x192.png',
                                                tag: 'gestion-affichage-mobile',
                                                requireInteraction: true,
                                                vibrate: [200, 100, 200],
                                                data: { timestamp: Date.now() }
                                            };
                                            
                                            event.waitUntil(
                                                self.registration.showNotification('Gestion Affichage', options)
                                            );
                                        });
                                        
                                        self.addEventListener('notificationclick', function(event) {
                                            console.log('üì± Notification mobile cliqu√©e');
                                            event.notification.close();
                                            
                                            event.waitUntil(
                                                clients.matchAll({ type: 'window', includeUncontrolled: true }).then(function(clientList) {
                                                    if (clientList.length > 0) {
                                                        return clientList[0].focus();
                                                    }
                                                    return clients.openWindow('/');
                                                })
                                            );
                                        });
                                        
                                        self.addEventListener('activate', function(event) {
                                            console.log('üì± Service Worker mobile activ√©');
                                            event.waitUntil(self.clients.claim());
                                        });
                                    `)
                                );
                                
                                // Attendre que le SW soit vraiment pr√™t
                                await registration.update();
                                
                                if (registration.active) {
                                    window.swRegistration = registration;
                                    console.log('‚úÖ Service Worker mobile pr√™t et actif');
                                    
                                    // Test mobile apr√®s d√©lai
                                    setTimeout(async () => {
                                        console.log('üì± Test automatique mobile...');
                                        const success = await showNotificationSafe('üì± Mobile Ready', 'Notifications activ√©es sur mobile !', true);
                                        if (success) {
                                            console.log('‚úÖ Test mobile automatique r√©ussi');
                                        } else {
                                            console.log('‚ùå Test mobile automatique √©chou√©');
                                        }
                                    }, 4000);
                                    
                                } else {
                                    console.log('‚ö†Ô∏è Service Worker mobile en attente d\'activation');
                                    window.swRegistration = registration;
                                }
                                
                            } catch (swError) {
                                console.log('‚ö†Ô∏è Service Worker mobile √©chou√©:', swError.message);
                                window.swRegistration = null;
                            }
                        }
                        
                        // Pour desktop : Pas de SW n√©cessaire
                        else if (!isMobile) {
                            console.log('üñ•Ô∏è Configuration desktop (sans Service Worker)');
                            window.swRegistration = null;
                            
                            // Test desktop apr√®s d√©lai
                            setTimeout(async () => {
                                console.log('üñ•Ô∏è Test automatique desktop...');
                                const success = await showNotificationSafe('üñ•Ô∏è Desktop Ready', 'Notifications activ√©es sur desktop !', true);
                                if (success) {
                                    console.log('‚úÖ Test desktop automatique r√©ussi');
                                }
                            }, 2000);
                        }
                        
                    } else {
                        console.log('‚ùå Notifications push refus√©es:', permission);
                    }
                } catch (error) {
                    console.error('‚ùå Erreur init notifications:', error);
                }
            } else {
                console.log('‚ùå Notifications non support√©es par ce navigateur');
            }
        }

        // Fonction universelle pour afficher les notifications
        async function showNotificationSafe(title, body, isDiscrete = false) {
            console.log('üì§ Tentative affichage notification:', title);
            console.log('üì± User Agent:', navigator.userAgent);
            console.log('üåê Is Mobile:', /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
            
            if (!('Notification' in window)) {
                console.log('‚ùå API Notification non support√©e');
                return false;
            }
            
            const permission = Notification.permission;
            console.log('üìã Permission actuelle:', permission);
            
            if (permission !== 'granted') {
                console.log('‚ùå Permission non accord√©e:', permission);
                return false;
            }
            
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // MOBILE : Service Worker obligatoire
            if (isMobile) {
                console.log('üì± Appareil mobile d√©tect√© - Mode Service Worker');
                
                if (!window.swRegistration) {
                    console.log('‚ùå Service Worker requis pour mobile mais non disponible');
                    return false;
                }
                
                try {
                    console.log('üì± Envoi notification via Service Worker...');
                    await window.swRegistration.showNotification(title, {
                        body: body,
                        icon: '/favicon.ico',
                        badge: '/favicon.ico',
                        tag: `mobile-notif-${Date.now()}`,
                        requireInteraction: !isDiscrete,
                        silent: isDiscrete,
                        vibrate: isDiscrete ? [] : [200, 100, 200],
                        data: { 
                            timestamp: Date.now(),
                            source: 'mobile' 
                        },
                        actions: !isDiscrete ? [
                            {
                                action: 'view',
                                title: 'Voir',
                                icon: '/favicon.ico'
                            }
                        ] : []
                    });
                    console.log('‚úÖ Service Worker notification envoy√©e (mobile)');
                    return true;
                } catch (mobileError) {
                    console.error('‚ùå Erreur Service Worker mobile:', mobileError);
                    console.log('üîß D√©tails erreur mobile:', mobileError.message);
                    return false;
                }
            }
            
            // DESKTOP : API Notification directe
            else {
                console.log('üñ•Ô∏è Appareil desktop d√©tect√© - Mode API directe');
                
                try {
                    console.log('üñ•Ô∏è Cr√©ation notification desktop...');
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üì∫</text></svg>',
                        tag: `desktop-notif-${Date.now()}`,
                        requireInteraction: !isDiscrete,
                        silent: isDiscrete
                    });
                    
                    notification.onclick = function() {
                        console.log('üëÜ Notification desktop cliqu√©e');
                        window.focus();
                        this.close();
                    };
                    
                    notification.onshow = function() {
                        console.log('‚úÖ Notification desktop affich√©e');
                    };
                    
                    notification.onerror = function(error) {
                        console.error('‚ùå Erreur notification desktop:', error);
                    };
                    
                    if (!isDiscrete) {
                        setTimeout(() => {
                            try {
                                notification.close();
                                console.log('üîí Notification desktop ferm√©e automatiquement');
                            } catch (e) {
                                console.log('‚ÑπÔ∏è Notification desktop d√©j√† ferm√©e');
                            }
                        }, 8000);
                    }
                    
                    console.log('‚úÖ Notification desktop cr√©√©e');
                    return true;
                    
                } catch (desktopError) {
                    console.error('‚ùå Erreur API Notification desktop:', desktopError);
                    console.log('üîß D√©tails erreur desktop:', desktopError.message);
                    return false;
                }
            }
        }

        // V√©rifier l'√©tat de connexion
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                await loadCurrentUserData();
                updateHeaderUserInfo();
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                await loadAllData();
                await initPushNotifications();
                setupNotificationListeners();
                startExpirationCheck();
            } else {
                window.currentUser = null;
                window.currentUserData = null;
                document.getElementById('loginModal').style.display = 'block';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        // Charger les donn√©es de l'utilisateur actuel
        async function loadCurrentUserData() {
            try {
                console.log('üîç Recherche utilisateur avec UID:', window.currentUser.uid);
                
                // Chercher l'utilisateur par son UID Firebase
                const q = query(collection(db, 'users'), where('userId', '==', window.currentUser.uid));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    // L'utilisateur existe d√©j√†
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    window.currentUserData = { id: userDoc.id, ...userData };
                    
                    console.log('‚úÖ Utilisateur existant trouv√©:', window.currentUserData.firstName, window.currentUserData.lastName);
                    
                    // Mettre √† jour seulement la derni√®re connexion
                    await updateDoc(doc(db, 'users', userDoc.id), {
                        lastLoginAt: serverTimestamp()
                    });
                    
                } else {
                    // V√©rifier √©galement si un utilisateur avec le m√™me email existe
                    const emailQuery = query(collection(db, 'users'), where('email', '==', window.currentUser.email));
                    const emailSnapshot = await getDocs(emailQuery);
                    
                    if (!emailSnapshot.empty) {
                        // Utilisateur trouv√© par email, mettre √† jour le userId
                        const userDoc = emailSnapshot.docs[0];
                        const userData = userDoc.data();
                        window.currentUserData = { id: userDoc.id, ...userData };
                        
                        console.log('‚úÖ Utilisateur trouv√© par email, mise √† jour userId');
                        
                        // Mettre √† jour le userId et la derni√®re connexion
                        await updateDoc(doc(db, 'users', userDoc.id), {
                            userId: window.currentUser.uid,
                            lastLoginAt: serverTimestamp()
                        });
                        
                    } else {
                        // Vraiment nouveau utilisateur - premi√®re connexion
                        console.log('üÜï Cr√©ation du premier profil utilisateur pour:', window.currentUser.email);
                        
                        window.currentUserData = {
                            userId: window.currentUser.uid,
                            email: window.currentUser.email,
                            firstName: window.currentUser.displayName?.split(' ')[0] || 'Utilisateur',
                            lastName: window.currentUser.displayName?.split(' ')[1] || 'Principal',
                            role: 'admin', // Premier utilisateur = admin
                            notificationPreferences: {
                                creation: true,
                                diffusion: true,
                                expiration: true,
                                archivage: true,
                                resume: true
                            },
                            notificationChannels: {
                                email: true,
                                push: true
                            },
                            status: 'active'
                        };
                        
                        const docRef = await addDoc(collection(db, 'users'), {
                            ...window.currentUserData,
                            createdAt: serverTimestamp(),
                            lastLoginAt: serverTimestamp()
                        });
                        
                        window.currentUserData.id = docRef.id;
                        console.log('‚úÖ Nouveau profil utilisateur cr√©√© avec ID:', docRef.id);
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement utilisateur:', error);
            }
        }

        // Mettre √† jour les informations utilisateur dans le header
        function updateHeaderUserInfo() {
            if (window.currentUserData) {
                const initials = `${window.currentUserData.firstName?.charAt(0) || ''}${window.currentUserData.lastName?.charAt(0) || ''}`;
                const initialsElement = document.getElementById('currentUserInitials');
                if (initialsElement) {
                    initialsElement.textContent = initials;
                }
                console.log('üé≠ Initiales mises √† jour:', initials);
            }
        }

        // Connexion utilisateur
        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('loginError').style.display = 'none';
            } catch (error) {
                document.getElementById('loginError').textContent = 'Erreur de connexion : ' + error.message;
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // D√©connexion utilisateur
        async function logoutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
            }
        }

        // Charger toutes les donn√©es
        async function loadAllData() {
            console.log('üîÑ Chargement de toutes les donn√©es...');
            await loadOrigines();
            await loadUnites();
            await loadAffiches();
            await loadUsers();
            await loadNotifications();
            
            // Forcer la mise √† jour des statistiques apr√®s un court d√©lai
            setTimeout(() => {
                console.log('üîÑ Mise √† jour forc√©e des composants UI...');
                setupSearch();
                setupFilters();
                updateSelectOptions();
                
                // Re-calculer les stats avec les donn√©es charg√©es
                if (window.lastLoadedAffiches && window.lastLoadedAffiches.length > 0) {
                    console.log('üìä Recalcul forc√© des statistiques dashboard');
                    updateDashboardStats(window.lastLoadedAffiches);
                } else {
                    console.log('üìä Initialisation des statistiques √† z√©ro');
                    updateDashboardStats([]);
                }
            }, 500);
        }

        // ========= GESTION DES UTILISATEURS =========
        
        // Charger les utilisateurs
        async function loadUsers() {
            try {
                const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                const users = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    if (data.lastLoginAt && data.lastLoginAt.toDate) {
                        data.lastLoginAt = data.lastLoginAt.toDate();
                    }
                    users.push({ id: doc.id, ...data });
                });
                
                window.users = users;
                displayUsers(users);
                updateUserStats(users);
                
                console.log('Utilisateurs charg√©s:', users.length);
                console.log('Liste des utilisateurs:', users.map(u => `${u.firstName} ${u.lastName} (${u.email})`));
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
                showErrorMessage('Erreur lors du chargement des utilisateurs');
            }
        }

        // Afficher les utilisateurs
        function displayUsers(users) {
            const container = document.getElementById('usersList');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        Aucun utilisateur enregistr√©.<br>
                        Invitez des coll√®gues pour collaborer !
                    </div>
                `;
                return;
            }
            
            const usersHtml = users.map(user => {
                const initials = `${user.firstName?.charAt(0) || ''}${user.lastName?.charAt(0) || ''}`;
                const isOnline = user.lastLoginAt && (new Date() - user.lastLoginAt) < 300000; // 5 minutes
                const isCurrentUser = user.userId === window.currentUser.uid;
                
                // Pour l'utilisateur connect√©, toujours utiliser l'ID du document Firestore
                const editId = user.id; // Toujours l'ID Firestore
                
                console.log('üë§ Utilisateur:', user.firstName, user.lastName, 'ID Firestore:', user.id, 'UID Firebase:', user.userId, 'Est connect√©:', isCurrentUser);
                
                return `
                    <div class="user-card">
                        <div class="user-header">
                            <div style="display: flex; align-items: center;">
                                <div class="user-avatar">${initials}</div>
                                <div class="user-main-info">
                                    <div class="user-name">${user.firstName} ${user.lastName} ${isCurrentUser ? '(Vous)' : ''}</div>
                                    <div class="user-email">${user.email}</div>
                                    <span class="user-role ${user.role === 'admin' ? 'admin' : ''}">${user.role === 'admin' ? 'üëë Administrateur' : 'üë§ Employ√©'}</span>
                                </div>
                            </div>
                            <div class="user-actions">
                                <button class="action-btn edit-btn" onclick="editUser('${editId}')" title="Modifier">‚úèÔ∏è</button>
                                ${!isCurrentUser ? `
                                    <button class="action-btn delete-btn" onclick="confirmDeleteUser('${user.id}', '${user.firstName} ${user.lastName}')" title="Supprimer">üóëÔ∏è</button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="user-preferences">
                            <div class="user-pref-title">Pr√©f√©rences de notification :</div>
                            <div class="notification-prefs">
                                <div class="pref-option">
                                    <span class="pref-icon ${user.notificationChannels?.email ? 'active' : 'inactive'}">${user.notificationChannels?.email ? '‚úÖ' : '‚ùå'}</span>
                                    <span>Email</span>
                                </div>
                                <div class="pref-option">
                                    <span class="pref-icon ${user.notificationChannels?.push ? 'active' : 'inactive'}">${user.notificationChannels?.push ? '‚úÖ' : '‚ùå'}</span>
                                    <span>Push</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="user-status ${isOnline ? 'status-online' : 'status-offline'}">
                            ${isOnline ? 'üü¢ En ligne' : '‚ö´ Hors ligne'} - Derni√®re connexion: ${formatDateTime(user.lastLoginAt)}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = usersHtml;
        }

        // Inviter un utilisateur
        async function inviteUser(userData) {
            try {
                // V√©rifier la limite de 6 utilisateurs
                if (window.users.length >= 6) {
                    showErrorMessage('‚ùå Limite de 6 utilisateurs atteinte');
                    return;
                }
                
                // V√©rifier si l'email existe d√©j√†
                const existingUser = window.users.find(u => u.email === userData.email);
                if (existingUser) {
                    showErrorMessage('‚ùå Cet email est d√©j√† utilis√©');
                    return;
                }
                
                // Cr√©er l'utilisateur dans Firestore
                const newUser = {
                    email: userData.email,
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    role: userData.role,
                    notificationPreferences: {
                        creation: true,
                        diffusion: true,
                        expiration: true,
                        archivage: true,
                        resume: true
                    },
                    notificationChannels: {
                        email: userData.defaultEmail || true,
                        push: userData.defaultPush || true
                    },
                    status: 'invited',
                    invitedBy: window.currentUser.uid,
                    invitedAt: serverTimestamp(),
                    createdAt: serverTimestamp()
                };
                
                const docRef = await addDoc(collection(db, 'users'), newUser);
                
                // Envoyer email d'invitation (simulation)
                await sendInvitationEmail(userData);
                
                // Enregistrer notification
                await addNotification({
                    type: 'user_invited',
                    message: `Utilisateur ${userData.firstName} ${userData.lastName} invit√©`,
                    userId: window.currentUser.uid,
                    status: 'sent'
                });
                
                showSuccessMessage(`‚úâÔ∏è Invitation envoy√©e √† ${userData.firstName} ${userData.lastName}`);
                await loadUsers();
                
                return docRef.id;
            } catch (error) {
                console.error('Erreur invitation utilisateur:', error);
                showErrorMessage('‚ùå Erreur lors de l\'invitation');
                throw error;
            }
        }

        // Envoyer email d'invitation (simulation)
        async function sendInvitationEmail(userData) {
            // Simulation d'envoi d'email
            console.log(`üìß Email d'invitation envoy√© √† ${userData.email}`);
            
            // Dans une vraie application, vous utiliseriez:
            // - Firebase Cloud Functions
            // - Service d'email comme SendGrid, Mailgun, etc.
            // - Template d'email personnalis√©
            
            return new Promise(resolve => setTimeout(resolve, 1000));
        }

        // Mettre √† jour un utilisateur
        async function updateUser(id, userData) {
            try {
                console.log('üîÑ Mise √† jour utilisateur ID:', id);
                console.log('üìù Donn√©es √† mettre √† jour:', userData);
                
                const docRef = doc(db, 'users', id);
                await updateDoc(docRef, {
                    ...userData,
                    updatedAt: serverTimestamp()
                });
                
                // Si c'est l'utilisateur connect√©, mettre √† jour aussi les donn√©es locales
                if (window.currentUserData && window.currentUserData.id === id) {
                    console.log('üë§ Mise √† jour des donn√©es utilisateur connect√©');
                    window.currentUserData = { ...window.currentUserData, ...userData };
                    updateHeaderUserInfo();
                }
                
                showSuccessMessage('‚úÖ Utilisateur mis √† jour avec succ√®s');
                await loadUsers();
                return true;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour utilisateur:', error);
                console.error('üîç ID utilis√©:', id);
                console.error('üîç Donn√©es envoy√©es:', userData);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour: ' + error.message);
                return false;
            }
        }

        // Supprimer un utilisateur
        async function deleteUser(id) {
            try {
                await deleteDoc(doc(db, 'users', id));
                showSuccessMessage('üóëÔ∏è Utilisateur supprim√© avec succ√®s');
                await loadUsers();
            } catch (error) {
                console.error('Erreur suppression utilisateur:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        // Charger un utilisateur pour √©dition
        async function loadUserForEdit(id) {
            try {
                console.log('üîç Chargement utilisateur pour √©dition, ID:', id);
                
                // Chercher d'abord dans les donn√©es d√©j√† charg√©es
                const userInList = window.users.find(u => u.id === id);
                if (userInList) {
                    console.log('‚úÖ Utilisateur trouv√© dans la liste:', userInList.firstName, userInList.lastName);
                    return userInList;
                }
                
                // Si pas trouv√©, chercher dans Firestore
                console.log('üîç Recherche dans Firestore...');
                const userDoc = await getDoc(doc(db, 'users', id));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    console.log('‚úÖ Utilisateur trouv√© dans Firestore:', userData.firstName, userData.lastName);
                    return { id: userDoc.id, ...userData };
                } else {
                    console.log('‚ùå Utilisateur non trouv√© avec ID:', id);
                    showErrorMessage('‚ùå Utilisateur non trouv√©');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement utilisateur:', error);
                showErrorMessage('‚ùå Erreur lors du chargement: ' + error.message);
                return null;
            }
        }

        // Mettre √† jour les statistiques utilisateurs
        function updateUserStats(users) {
            document.getElementById('totalUsers').textContent = `${users.length} utilisateur(s)`;
            
            const activeUsers = users.filter(u => {
                if (!u.lastLoginAt) return false;
                const lastLogin = u.lastLoginAt instanceof Date ? u.lastLoginAt : u.lastLoginAt.toDate();
                return (new Date() - lastLogin) < 300000; // 5 minutes
            }).length;
            
            document.getElementById('activeUsers').textContent = `${activeUsers} utilisateur(s) connect√©(s)`;
        }

        // ========= GESTION DES NOTIFICATIONS =========
        
        // Charger les notifications
        async function loadNotifications() {
            try {
                // Requ√™te simplifi√©e sans index complexe
                const q = query(
                    collection(db, 'notifications'), 
                    where('userId', '==', window.currentUser.uid)
                    // Retirer le orderBy pour √©viter l'erreur d'index
                );
                const querySnapshot = await getDocs(q);
                const notifications = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    notifications.push({ id: doc.id, ...data });
                });
                
                // Trier c√¥t√© client
                notifications.sort((a, b) => {
                    const dateA = a.createdAt instanceof Date ? a.createdAt : new Date(a.createdAt);
                    const dateB = b.createdAt instanceof Date ? b.createdAt : new Date(b.createdAt);
                    return dateB - dateA; // Plus r√©cent en premier
                });
                
                window.notifications = notifications;
                displayNotificationHistory(notifications);
                updateNotificationStats(notifications);
                
                console.log('‚úÖ Notifications charg√©es:', notifications.length);
            } catch (error) {
                console.error('‚ùå Erreur chargement notifications:', error);
                
                // En cas d'erreur, initialiser avec un tableau vide
                window.notifications = [];
                displayNotificationHistory([]);
                updateNotificationStats([]);
            }
        }

        // Afficher l'historique des notifications
        function displayNotificationHistory(notifications) {
            const container = document.getElementById('notificationHistory');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        Aucune notification envoy√©e r√©cemment
                    </div>
                `;
                return;
            }
            
            const recentNotifications = notifications.slice(0, 10);
            const notificationsHtml = recentNotifications.map(notif => `
                <div class="notification-item">
                    <div class="notification-header">
                        <span class="notification-type">${getNotificationTypeLabel(notif.type)}</span>
                        <span class="notification-time">${formatDateTime(notif.createdAt)}</span>
                    </div>
                    <div class="notification-message">${notif.message}</div>
                    <div class="notification-status ${notif.status === 'failed' ? 'failed' : ''}">${notif.status === 'sent' ? '‚úÖ Envoy√©e' : '‚ùå √âchec'}</div>
                </div>
            `).join('');
            
            container.innerHTML = notificationsHtml;
        }

        // Ajouter une notification
        async function addNotification(notificationData) {
            try {
                await addDoc(collection(db, 'notifications'), {
                    ...notificationData,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error('Erreur ajout notification:', error);
            }
        }

        // Envoyer une notification
        async function sendNotification(type, message, recipients = null) {
            try {
                const targetUsers = recipients || window.users.filter(u => 
                    u.notificationPreferences?.[type] && 
                    (u.notificationChannels?.email || u.notificationChannels?.push)
                );
                
                for (const user of targetUsers) {
                    // Envoyer email si activ√©
                    if (user.notificationChannels?.email) {
                        await sendEmailNotification(user, type, message);
                    }
                    
                    // Envoyer notification push si activ√©
                    if (user.notificationChannels?.push) {
                        await sendPushNotification(user, type, message);
                    }
                    
                    // Enregistrer dans l'historique
                    await addNotification({
                        type: type,
                        message: message,
                        userId: user.userId || user.id,
                        status: 'sent'
                    });
                }
                
                await loadNotifications();
                return true;
            } catch (error) {
                console.error('Erreur envoi notification:', error);
                return false;
            }
        }

        // Envoyer notification email
        async function sendEmailNotification(user, type, message) {
            // Simulation d'envoi d'email
            console.log(`üìß Email envoy√© √† ${user.email}: ${message}`);
            return new Promise(resolve => setTimeout(resolve, 500));
        }

        // Envoyer notification push
        async function sendPushNotification(user, type, message) {
            console.log('üì§ Envoi notification push pour:', user.firstName, user.lastName);
            
            const title = `üì∫ Gestion Affichage - ${getNotificationTypeLabel(type)}`;
            const success = await showNotificationSafe(title, message, false);
            
            if (success) {
                console.log('‚úÖ Notification envoy√©e avec succ√®s');
            } else {
                console.log('‚ùå √âchec envoi notification');
            }
            
            return Promise.resolve();
        }

        // Tester les notifications
        async function testNotification() {
            console.log('üß™ Test de notification d√©marr√©...');
            
            try {
                // V√©rifier le support de base
                if (!('Notification' in window)) {
                    console.log('‚ùå API Notification non support√©e');
                    showErrorMessage('‚ùå Ce navigateur ne supporte pas les notifications');
                    return;
                }
                
                // V√©rifier/demander permission
                let permission = Notification.permission;
                console.log('üìã Permission initiale:', permission);
                
                if (permission === 'default') {
                    console.log('üîí Demande de permission...');
                    permission = await Notification.requestPermission();
                    console.log('üìã Permission obtenue:', permission);
                }
                
                if (permission === 'denied') {
                    console.log('‚ùå Permission refus√©e d√©finitivement');
                    showErrorMessage('‚ùå Notifications bloqu√©es. Pour les r√©activer :\n1. Cliquez sur l\'ic√¥ne üîí ou ‚öôÔ∏è dans la barre d\'adresse\n2. Autorisez les notifications\n3. Rechargez la page');
                    return;
                }
                
                if (permission === 'granted') {
                    console.log('‚úÖ Permission accord√©e, test des m√©thodes...');
                    
                    // Test direct simple d'abord
                    console.log('üéØ Test 1: Notification directe simple...');
                    try {
                        const simpleNotif = new Notification('üß™ Test Simple', {
                            body: 'Si vous voyez ceci, les notifications marchent !',
                            tag: 'test-simple-' + Date.now()
                        });
                        
                        simpleNotif.onshow = function() {
                            console.log('‚úÖ Test simple r√©ussi !');
                        };
                        
                        simpleNotif.onerror = function(error) {
                            console.log('‚ùå Test simple √©chou√©:', error);
                        };
                        
                        setTimeout(() => {
                            try { simpleNotif.close(); } catch(e) {}
                        }, 3000);
                        
                        showSuccessMessage('üß™ Test 1: Notification simple envoy√©e !');
                        
                    } catch (directError) {
                        console.log('‚ùå Test direct √©chou√©:', directError.message);
                    }
                    
                    // Test avec Service Worker si disponible
                    if (window.swRegistration && 'showNotification' in window.swRegistration) {
                        console.log('üéØ Test 2: Service Worker...');
                        try {
                            await window.swRegistration.showNotification('üß™ Test Service Worker', {
                                body: 'Test avec Service Worker pour mobile',
                                tag: 'test-sw-' + Date.now(),
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üì∫</text></svg>'
                            });
                            console.log('‚úÖ Test Service Worker r√©ussi !');
                            showSuccessMessage('üß™ Test 2: Service Worker r√©ussi !');
                        } catch (swTestError) {
                            console.log('‚ùå Test Service Worker √©chou√©:', swTestError.message);
                            showErrorMessage('‚ùå Test Service Worker √©chou√©: ' + swTestError.message);
                        }
                    }
                    
                    // Test avec la fonction universelle
                    console.log('üéØ Test 3: Fonction universelle...');
                    const universalSuccess = await showNotificationSafe(
                        'üß™ Test Final - Gestion Affichage', 
                        'Si vous voyez ceci, tout fonctionne parfaitement ! üéâ',
                        false
                    );
                    
                    if (universalSuccess) {
                        showSuccessMessage('üéâ Tests termin√©s avec succ√®s ! Les notifications fonctionnent.');
                        console.log('‚úÖ Tous les tests r√©ussis');
                        
                        // Test du syst√®me de notification existant
                        if (window.currentUserData) {
                            console.log('üéØ Test du syst√®me complet...');
                            setTimeout(async () => {
                                await sendNotification('test', 'Test syst√®me complet - Notifications op√©rationnelles !', [window.currentUserData]);
                            }, 2000);
                        }
                        
                    } else {
                        showErrorMessage('‚ùå Tous les tests ont √©chou√©');
                        console.log('‚ùå √âchec complet des tests');
                    }
                    
                } else {
                    console.log('‚ùì √âtat de permission inattendu:', permission);
                    showErrorMessage('‚ùå √âtat de permission non g√©r√©: ' + permission);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur critique lors du test:', error);
                showErrorMessage('‚ùå Erreur critique: ' + error.message);
            }
        }

        // Mettre √† jour les statistiques de notifications
        function updateNotificationStats(notifications) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayNotifications = notifications.filter(n => {
                const notifDate = n.createdAt instanceof Date ? n.createdAt : n.createdAt.toDate();
                return notifDate >= today;
            }).length;
            
            document.getElementById('todayNotifications').textContent = `${todayNotifications} notification(s)`;
        }

        // Configuration des listeners pour notifications automatiques
        function setupNotificationListeners() {
            console.log('üîß Configuration des listeners de notifications...');
            
            // √âcouter SEULEMENT les NOUVEAUX ajouts d'affiches
            const affichesQuery = query(collection(db, 'affiches'), orderBy('dateCreation', 'desc'));
            
            // Variable pour √©viter les notifications au premier chargement
            let isFirstLoad = true;
            let initialLoadComplete = false;
            
            onSnapshot(affichesQuery, (snapshot) => {
                console.log('üìä Snapshot affiches re√ßu, taille:', snapshot.size);
                
                // Au premier chargement, juste marquer comme initialis√©
                if (isFirstLoad) {
                    console.log('üèÅ Premier chargement - pas de notifications envoy√©es');
                    isFirstLoad = false;
                    
                    // Marquer comme compl√©t√© apr√®s un d√©lai
                    setTimeout(() => {
                        initialLoadComplete = true;
                        console.log('‚úÖ Initialisation termin√©e - notifications automatiques activ√©es');
                    }, 3000);
                    
                    return;
                }
                
                // Si l'initialisation n'est pas termin√©e, ignorer
                if (!initialLoadComplete) {
                    console.log('‚è≥ Initialisation en cours - notifications ignor√©es');
                    return;
                }
                
                // Traiter seulement les vrais changements
                snapshot.docChanges().forEach((change) => {
                    const affiche = change.doc.data();
                    const changeType = change.type;
                    
                    console.log('üîÑ Changement d√©tect√©:', changeType, 'pour affiche:', affiche.libelle);
                    
                    // SEULEMENT pour les NOUVEAUX ajouts (pas les chargements initiaux)
                    if (changeType === 'added') {
                        // V√©rifier que c'est vraiment nouveau (cr√©√© dans les derni√®res 10 secondes)
                        const now = new Date();
                        const afficheDate = affiche.dateCreation?.toDate ? affiche.dateCreation.toDate() : new Date(affiche.dateCreation);
                        const timeDiff = now - afficheDate;
                        
                        console.log('‚è∞ Diff√©rence de temps:', timeDiff, 'ms');
                        
                        // Si cr√©√© il y a moins de 10 secondes = vraiment nouveau
                        if (timeDiff < 10000) {
                            console.log('üÜï Nouvelle affiche d√©tect√©e:', affiche.libelle);
                            sendNotification('creation', 
                                `Nouvelle affiche cr√©√©e: ${affiche.libelle} (${affiche.prix}‚Ç¨/${affiche.unite})`
                            );
                        } else {
                            console.log('üìö Affiche existante ignor√©e (cr√©ation:', afficheDate, ')');
                        }
                        
                    } else if (changeType === 'modified') {
                        // Pour les modifications, v√©rifier les changements de statut importants
                        const oldData = change.oldIndex !== -1 ? change.doc.data() : null;
                        
                        if (affiche.statut === 'en-diffusion') {
                            console.log('üì∫ Affiche mise en diffusion:', affiche.libelle);
                            sendNotification('diffusion', 
                                `Affiche mise en diffusion: ${affiche.libelle}`
                            );
                        } else if (affiche.statut === 'archivee') {
                            console.log('üì¶ Affiche archiv√©e:', affiche.libelle);
                            sendNotification('archivage', 
                                `Affiche archiv√©e: ${affiche.libelle}`
                            );
                        }
                    }
                });
            });
        }

        // V√©rifier les affiches expirantes
        async function checkExpiringAffiches() {
            try {
                console.log('‚è∞ V√©rification des affiches expirantes...');
                
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const q = query(
                    collection(db, 'affiches'),
                    where('statut', '==', 'en-diffusion')
                );
                const querySnapshot = await getDocs(q);
                
                let expiringCount = 0;
                
                querySnapshot.forEach((doc) => {
                    const affiche = doc.data();
                    const dateFin = new Date(affiche.dateFin);
                    dateFin.setHours(0, 0, 0, 0);
                    
                    // Si expire demain
                    if (dateFin.getTime() === tomorrow.getTime()) {
                        console.log('‚ö†Ô∏è Affiche expire demain:', affiche.libelle);
                        sendNotification('expiration', 
                            `Affiche expire demain: ${affiche.libelle} (${formatDate(affiche.dateFin)})`
                        );
                        expiringCount++;
                    }
                });
                
                console.log('üìä Affiches expirant demain:', expiringCount);
                
            } catch (error) {
                console.error('‚ùå Erreur v√©rification expirations:', error);
            }
        }

        // D√©marrer la v√©rification des expirations (1 fois par heure)
        function startExpirationCheck() {
            console.log('‚è∞ D√©marrage du syst√®me de v√©rification des expirations');
            
            // Premi√®re v√©rification apr√®s 1 minute
            setTimeout(checkExpiringAffiches, 60000);
            
            // Puis toutes les heures
            setInterval(checkExpiringAffiches, 3600000);
        }

        // ========= GESTION DES ORIGINES (inchang√©) =========
        
        async function loadOrigines() {
            try {
                const q = query(collection(db, 'origines'), orderBy('nom', 'asc'));
                const querySnapshot = await getDocs(q);
                const origines = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.utilisateurId === window.currentUser.uid) {
                        origines.push({ id: doc.id, ...data });
                    }
                });
                
                window.origines = origines;
                displayOrigines(origines);
                
                if (origines.length === 0) {
                    await createDefaultOrigines();
                }
                
                console.log('Origines charg√©es:', origines.length);
            } catch (error) {
                console.error('Erreur chargement origines:', error);
                showErrorMessage('Erreur lors du chargement des origines');
            }
        }

        async function createDefaultOrigines() {
            const defaultOrigines = ['France', 'Espagne', 'Italie', 'Pays-Bas', 'Belgique', 'Maroc'];
            
            for (const origine of defaultOrigines) {
                try {
                    await addDoc(collection(db, 'origines'), {
                        nom: origine,
                        dateCreation: serverTimestamp(),
                        utilisateurId: window.currentUser.uid
                    });
                } catch (error) {
                    console.error('Erreur cr√©ation origine par d√©faut:', error);
                }
            }
            
            await loadOrigines();
        }

        function displayOrigines(origines) {
            const container = document.getElementById('originesList');
            
            if (origines.length === 0) {
                container.innerHTML = `
                    <div class="empty-params">
                        Aucune origine configur√©e.<br>
                        Cliquez sur "Ajouter une origine" pour commencer.
                    </div>
                `;
                return;
            }
            
            const originesHtml = origines.map(origine => `
                <div class="param-item">
                    <span class="param-name">${origine.nom}</span>
                    <div class="param-actions">
                        <button class="action-btn edit-btn" onclick="editOrigine('${origine.id}')">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="confirmDeleteOrigine('${origine.id}', '${origine.nom}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = originesHtml;
        }

        async function saveOrigine(origine) {
            try {
                const docRef = await addDoc(collection(db, 'origines'), {
                    ...origine,
                    dateCreation: serverTimestamp(),
                    utilisateurId: window.currentUser.uid
                });
                console.log('Origine sauv√©e avec ID:', docRef.id);
                await loadOrigines();
                updateSelectOptions();
                return docRef.id;
            } catch (error) {
                console.error('Erreur sauvegarde origine:', error);
                throw error;
            }
        }

        async function updateOrigine(id, data) {
            try {
                const docRef = doc(db, 'origines', id);
                await updateDoc(docRef, {
                    ...data,
                    dateModification: serverTimestamp()
                });
                showSuccessMessage('‚úÖ Origine mise √† jour avec succ√®s');
                await loadOrigines();
                updateSelectOptions();
                return true;
            } catch (error) {
                console.error('Erreur mise √† jour origine:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        async function deleteOrigine(id) {
            try {
                await deleteDoc(doc(db, 'origines', id));
                showSuccessMessage('üóëÔ∏è Origine supprim√©e avec succ√®s');
                await loadOrigines();
                updateSelectOptions();
            } catch (error) {
                console.error('Erreur suppression origine:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        // ========= GESTION DES UNITES (inchang√©) =========
        
        async function loadUnites() {
            try {
                const q = query(collection(db, 'unites'), orderBy('nom', 'asc'));
                const querySnapshot = await getDocs(q);
                const unites = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.utilisateurId === window.currentUser.uid) {
                        unites.push({ id: doc.id, ...data });
                    }
                });
                
                window.unites = unites;
                displayUnites(unites);
                
                if (unites.length === 0) {
                    await createDefaultUnites();
                }
                
                console.log('Unit√©s charg√©es:', unites.length);
            } catch (error) {
                console.error('Erreur chargement unit√©s:', error);
                showErrorMessage('Erreur lors du chargement des unit√©s');
            }
        }

        async function createDefaultUnites() {
            const defaultUnites = ['Kg', 'g', 'L', 'mL', 'Unit√©', 'Pi√®ce', 'Barquette', 'Sachet', 'Botte', 'Bouquet'];
            
            for (const unite of defaultUnites) {
                try {
                    await addDoc(collection(db, 'unites'), {
                        nom: unite,
                        dateCreation: serverTimestamp(),
                        utilisateurId: window.currentUser.uid
                    });
                } catch (error) {
                    console.error('Erreur cr√©ation unit√© par d√©faut:', error);
                }
            }
            
            await loadUnites();
        }

        function displayUnites(unites) {
            const container = document.getElementById('unitesList');
            
            if (unites.length === 0) {
                container.innerHTML = `
                    <div class="empty-params">
                        Aucune unit√© configur√©e.<br>
                        Cliquez sur "Ajouter une unit√©" pour commencer.
                    </div>
                `;
                return;
            }
            
            const unitesHtml = unites.map(unite => `
                <div class="param-item">
                    <span class="param-name">${unite.nom}</span>
                    <div class="param-actions">
                        <button class="action-btn edit-btn" onclick="editUnite('${unite.id}')">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="confirmDeleteUnite('${unite.id}', '${unite.nom}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = unitesHtml;
        }

        async function saveUnite(unite) {
            try {
                const docRef = await addDoc(collection(db, 'unites'), {
                    ...unite,
                    dateCreation: serverTimestamp(),
                    utilisateurId: window.currentUser.uid
                });
                console.log('Unit√© sauv√©e avec ID:', docRef.id);
                await loadUnites();
                updateSelectOptions();
                return docRef.id;
            } catch (error) {
                console.error('Erreur sauvegarde unit√©:', error);
                throw error;
            }
        }

        async function updateUnite(id, data) {
            try {
                const docRef = doc(db, 'unites', id);
                await updateDoc(docRef, {
                    ...data,
                    dateModification: serverTimestamp()
                });
                showSuccessMessage('‚úÖ Unit√© mise √† jour avec succ√®s');
                await loadUnites();
                updateSelectOptions();
                return true;
            } catch (error) {
                console.error('Erreur mise √† jour unit√©:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        async function deleteUnite(id) {
            try {
                await deleteDoc(doc(db, 'unites', id));
                showSuccessMessage('üóëÔ∏è Unit√© supprim√©e avec succ√®s');
                await loadUnites();
                updateSelectOptions();
            } catch (error) {
                console.error('Erreur suppression unit√©:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        // ========= MISE √Ä JOUR DES SELECT =========
        
        function updateSelectOptions() {
            // Mettre √† jour les selects d'origines
            const origineSelects = ['origine', 'editOrigine'];
            origineSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Choisir une origine</option>';
                    
                    window.origines.forEach(origine => {
                        const option = document.createElement('option');
                        option.value = origine.nom;
                        option.textContent = origine.nom;
                        select.appendChild(option);
                    });
                    
                    const autreOption = document.createElement('option');
                    autreOption.value = 'autre';
                    autreOption.textContent = '‚ûï Autre...';
                    select.appendChild(autreOption);
                    
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            });
            
            // Mettre √† jour les selects d'unit√©s
            const uniteSelects = ['unite', 'editUnite'];
            uniteSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Choisir une unit√©</option>';
                    
                    window.unites.forEach(unite => {
                        const option = document.createElement('option');
                        option.value = unite.nom;
                        option.textContent = unite.nom;
                        select.appendChild(option);
                    });
                    
                    const autreOption = document.createElement('option');
                    autreOption.value = 'autre';
                    autreOption.textContent = '‚ûï Autre...';
                    select.appendChild(autreOption);
                    
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // ========= GESTION DES AFFICHES =========
        
        async function loadAffiches() {
            try {
                console.log('üìã Chargement des affiches...');
                const q = query(collection(db, 'affiches'), orderBy('dateCreation', 'desc'));
                const querySnapshot = await getDocs(q);
                const affiches = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.dateCreation && data.dateCreation.toDate) {
                        data.dateCreation = data.dateCreation.toDate();
                    }
                    affiches.push({ id: doc.id, ...data });
                });
                
                console.log('üìã Affiches r√©cup√©r√©es depuis Firebase:', affiches.length);
                console.log('üìã D√©tail des affiches:', affiches.map(a => `${a.libelle} (${a.statut})`));
                
                // Mettre √† jour imm√©diatement
                displayAffiches(affiches);
                
                console.log('‚úÖ Affiches charg√©es et affich√©es:', affiches.length);
            } catch (error) {
                console.error('‚ùå Erreur chargement affiches:', error);
                showErrorMessage('Erreur lors du chargement des affiches');
                
                // En cas d'erreur, afficher avec un tableau vide
                displayAffiches([]);
            }
        }

        async function saveAffiche(affiche) {
            try {
                const docRef = await addDoc(collection(db, 'affiches'), {
                    ...affiche,
                    dateCreation: serverTimestamp(),
                    utilisateurId: window.currentUser.uid,
                    createdBy: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`
                });
                console.log('Affiche sauv√©e avec ID:', docRef.id);
                await loadAffiches();
                return docRef.id;
            } catch (error) {
                console.error('Erreur sauvegarde affiche:', error);
                throw error;
            }
        }

        async function updateAffiche(id, data) {
            try {
                const docRef = doc(db, 'affiches', id);
                await updateDoc(docRef, {
                    ...data,
                    dateModification: serverTimestamp(),
                    modifiedBy: `${window.currentUserData.firstName} ${window.currentUserData.lastName}`
                });
                showSuccessMessage('‚úÖ Affiche mise √† jour avec succ√®s');
                await loadAffiches();
                return true;
            } catch (error) {
                console.error('Erreur mise √† jour affiche:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        async function deleteAffiche(id) {
            try {
                await deleteDoc(doc(db, 'affiches', id));
                showSuccessMessage('üóëÔ∏è Affiche supprim√©e avec succ√®s');
                await loadAffiches();
            } catch (error) {
                console.error('Erreur suppression affiche:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        async function loadAfficheForEdit(id) {
            try {
                const docRef = doc(db, 'affiches', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const affiche = { id: docSnap.id, ...docSnap.data() };
                    window.currentEditingAffiche = affiche;
                    return affiche;
                } else {
                    showErrorMessage('‚ùå Affiche non trouv√©e');
                    return null;
                }
            } catch (error) {
                console.error('Erreur chargement affiche:', error);
                showErrorMessage('‚ùå Erreur lors du chargement');
                return null;
            }
        }

        async function loadOrigineForEdit(id) {
            try {
                const docRef = doc(db, 'origines', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const origine = { id: docSnap.id, ...docSnap.data() };
                    window.currentEditingOrigine = origine;
                    return origine;
                } else {
                    showErrorMessage('‚ùå Origine non trouv√©e');
                    return null;
                }
            } catch (error) {
                console.error('Erreur chargement origine:', error);
                showErrorMessage('‚ùå Erreur lors du chargement');
                return null;
            }
        }

        async function loadUniteForEdit(id) {
            try {
                const docRef = doc(db, 'unites', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const unite = { id: docSnap.id, ...docSnap.data() };
                    window.currentEditingUnite = unite;
                    return unite;
                } else {
                    showErrorMessage('‚ùå Unit√© non trouv√©e');
                    return null;
                }
            } catch (error) {
                console.error('Erreur chargement unit√©:', error);
                showErrorMessage('‚ùå Erreur lors du chargement');
                return null;
            }
        }

        // ========= FONCTIONS UTILITAIRES =========
        
        function getFamilleIconClass(famille) {
            const mapping = {
                'fruits-legumes': 'category-fruits',
                'traiteur': 'category-traiteur',
                'boucherie': 'category-boucherie',
                'cremerie': 'category-cremerie',
                'epicerie': 'category-epicerie',
                'boulangerie': 'category-boulangerie',
                'autre': 'category-autre'
            };
            return mapping[famille] || 'category-autre';
        }

        function getFamilleIcon(famille) {
            const mapping = {
                'fruits-legumes': 'üçé',
                'traiteur': 'ü•ò',
                'boucherie': 'ü•©',
                'cremerie': 'üßÄ',
                'epicerie': 'üõí',
                'boulangerie': 'ü•ñ',
                'autre': 'üì¶'
            };
            return mapping[famille] || 'üì¶';
        }

        function getStatusClass(statut) {
            return `status-${statut}`;
        }

        function getStatusText(statut) {
            const mapping = {
                'a-creer': '√Ä cr√©er',
                'programmee': 'Programm√©e',
                'en-diffusion': 'En diffusion',
                'archivee': 'Archiv√©e'
            };
            return mapping[statut] || 'Inconnu';
        }

        function getNotificationTypeLabel(type) {
            const mapping = {
                'creation': 'Cr√©ation d\'affiche',
                'diffusion': 'Mise en diffusion',
                'expiration': 'Alerte expiration',
                'archivage': 'Archivage',
                'resume': 'R√©sum√© quotidien',
                'user_invited': 'Invitation utilisateur',
                'test': 'Test'
            };
            return mapping[type] || 'Notification';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit'
            });
        }

        function formatDateTime(date) {
            if (!date) return 'Jamais';
            const d = date instanceof Date ? date : date.toDate();
            return d.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Fonctions d'affichage
        function displayAffiches(affiches) {
            console.log('üéØ displayAffiches appel√©e avec:', affiches.length, 'affiches');
            
            window.lastLoadedAffiches = affiches;
            
            updateDashboardStats(affiches);
            updateDashboardAffiches(affiches);
            updateAffichesTab(affiches);
            updatePlanningTab(affiches);
        }

        function updateDashboardStats(affiches) {
            console.log('üìä Mise √† jour des statistiques dashboard avec:', affiches.length, 'affiches');
            
            const stats = {
                enDiffusion: affiches.filter(a => a.statut === 'en-diffusion').length,
                aCreer: affiches.filter(a => a.statut === 'a-creer').length,
                programmees: affiches.filter(a => a.statut === 'programmee').length,
                archivees: affiches.filter(a => a.statut === 'archivee').length
            };
            
            console.log('üìà Statistiques calcul√©es:', stats);
            
            // Mettre √† jour les cartes de statistiques
            const statCards = document.querySelectorAll('.stat-card');
            console.log('üé¥ Cartes trouv√©es:', statCards.length);
            
            if (statCards.length >= 4) {
                // En diffusion
                const enDiffusionCard = statCards[0];
                if (enDiffusionCard) {
                    const h3 = enDiffusionCard.querySelector('h3');
                    if (h3) {
                        h3.textContent = stats.enDiffusion;
                        console.log('üì∫ En diffusion mis √† jour:', stats.enDiffusion);
                    }
                }
                
                // √Ä cr√©er
                const aCreerCard = statCards[1];
                if (aCreerCard) {
                    const h3 = aCreerCard.querySelector('h3');
                    if (h3) {
                        h3.textContent = stats.aCreer;
                        console.log('üÜï √Ä cr√©er mis √† jour:', stats.aCreer);
                    }
                }
                
                // Programm√©es
                const programmeesCard = statCards[2];
                if (programmeesCard) {
                    const h3 = programmeesCard.querySelector('h3');
                    if (h3) {
                        h3.textContent = stats.programmees;
                        console.log('üìÖ Programm√©es mis √† jour:', stats.programmees);
                    }
                }
                
                // Archiv√©es
                const archiveesCard = statCards[3];
                if (archiveesCard) {
                    const h3 = archiveesCard.querySelector('h3');
                    if (h3) {
                        h3.textContent = stats.archivees;
                        console.log('üì¶ Archiv√©es mis √† jour:', stats.archivees);
                    }
                }
                
                console.log('‚úÖ Toutes les statistiques dashboard mises √† jour');
            } else {
                console.error('‚ùå Pas assez de cartes de statistiques trouv√©es');
            }
        }

        function updateDashboardAffiches(affiches) {
            const affichesEnDiffusion = affiches.filter(a => a.statut === 'en-diffusion').slice(0, 5);
            const container = document.querySelector('.recent-items');
            
            if (container) {
                if (affichesEnDiffusion.length === 0) {
                    container.innerHTML = `
                        <h3>üì∫ Affiches en diffusion</h3>
                        <div class="empty-state">
                            Aucune affiche en diffusion pour le moment
                        </div>
                    `;
                    return;
                }

                const itemsHtml = affichesEnDiffusion.map(affiche => {
                    const iconClass = getFamilleIconClass(affiche.famille);
                    const icon = getFamilleIcon(affiche.famille);
                    const dateExpiration = formatDate(affiche.dateFin);
                    
                    return `
                        <div class="item">
                            <div class="item-icon ${iconClass}">${icon}</div>
                            <div class="item-info">
                                <h4>${affiche.libelle}</h4>
                                <p>${affiche.prix}‚Ç¨/${affiche.unite} ‚Ä¢ ${affiche.origine} ‚Ä¢ Expire le ${dateExpiration}</p>
                            </div>
                            <span class="status-badge status-en-diffusion">En diffusion</span>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <h3>üì∫ Affiches en diffusion</h3>
                    ${itemsHtml}
                `;
            }
        }

        function updateAffichesTab(affiches) {
            const container = document.querySelector('#affiches');
            if (!container) return;
            
            const searchBar = container.querySelector('.search-bar');
            const filterSection = container.querySelector('.filter-section');
            
            if (affiches.length === 0) {
                container.innerHTML = '';
                if (searchBar) container.appendChild(searchBar);
                if (filterSection) container.appendChild(filterSection);
                container.insertAdjacentHTML('beforeend', `
                    <div class="empty-state">
                        Aucune affiche cr√©√©e pour le moment.<br>
                        Cliquez sur le bouton + pour cr√©er votre premi√®re affiche !
                    </div>
                `);
                return;
            }
            
            const affichesHtml = affiches.map(affiche => {
                const iconClass = getFamilleIconClass(affiche.famille);
                const icon = getFamilleIcon(affiche.famille);
                const statusClass = getStatusClass(affiche.statut);
                const statusText = getStatusText(affiche.statut);
                const dateDebut = formatDate(affiche.dateDebut);
                const dateFin = formatDate(affiche.dateFin);
                
                return `
                    <div class="item" data-status="${affiche.statut}">
                        <div class="item-icon ${iconClass}">${icon}</div>
                        <div class="item-info">
                            <h4>${affiche.libelle}</h4>
                            <p>${affiche.prix}‚Ç¨/${affiche.unite} ‚Ä¢ ${affiche.origine}</p>
                            <p class="item-dates">${dateDebut} ‚Üí ${dateFin}</p>
                        </div>
                        <div class="item-actions">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <div class="item-actions-buttons">
                                <button class="action-btn edit-btn" onclick="editAffiche('${affiche.id}')">‚úèÔ∏è</button>
                                <button class="action-btn delete-btn" onclick="confirmDeleteAffiche('${affiche.id}', '${affiche.libelle}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = '';
            if (searchBar) container.appendChild(searchBar);
            if (filterSection) container.appendChild(filterSection);
            container.insertAdjacentHTML('beforeend', affichesHtml);
            
            setTimeout(() => {
                setupFilters();
                setupSearch();
            }, 50);
        }

        // Sauvegarde configuration SMTP
        async function saveSmtpConfig() {
            try {
                const config = {
                    server: document.getElementById('smtp-server').value,
                    port: parseInt(document.getElementById('smtp-port').value),
                    security: document.getElementById('smtp-security').value,
                    sender: document.getElementById('smtp-sender').value,
                    password: document.getElementById('smtp-password').value
                };
                
                // Sauvegarder dans Firestore
                await addDoc(collection(db, 'config'), {
                    type: 'smtp',
                    ...config,
                    updatedBy: window.currentUser.uid,
                    updatedAt: serverTimestamp()
                });
                
                showSuccessMessage('‚úÖ Configuration SMTP sauvegard√©e');
            } catch (error) {
                console.error('Erreur sauvegarde SMTP:', error);
                showErrorMessage('‚ùå Erreur lors de la sauvegarde');
            }
        }

        // Test connexion SMTP
        async function testSmtpConnection() {
            try {
                // Simulation du test SMTP
                showSuccessMessage('üîó Test SMTP r√©ussi - Configuration valide');
            } catch (error) {
                showErrorMessage('‚ùå √âchec du test SMTP - V√©rifiez la configuration');
            }
        }

        // Messages toast
        function showErrorMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ff4444;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Exposer les fonctions globalement
        window.loginUser = loginUser;
        window.logoutUser = logoutUser;
        window.saveAffiche = saveAffiche;
        window.updateAffiche = updateAffiche;
        window.deleteAffiche = deleteAffiche;
        window.loadAfficheForEdit = loadAfficheForEdit;
        window.saveOrigine = saveOrigine;
        window.updateOrigine = updateOrigine;
        window.deleteOrigine = deleteOrigine;
        window.loadOrigineForEdit = loadOrigineForEdit;
        window.saveUnite = saveUnite;
        window.updateUnite = updateUnite;
        window.deleteUnite = deleteUnite;
        window.loadUniteForEdit = loadUniteForEdit;
        window.inviteUser = inviteUser;
        window.updateUser = updateUser;
        window.deleteUser = deleteUser;
        window.loadUserForEdit = loadUserForEdit;
        window.sendNotification = sendNotification;
        window.testNotification = testNotification;
        window.saveSmtpConfig = saveSmtpConfig;
        window.testSmtpConnection = testSmtpConnection;
        window.showErrorMessage = showErrorMessage;
        window.showSuccessMessage = showSuccessMessage;
        window.getFamilleIconClass = getFamilleIconClass;
        window.getFamilleIcon = getFamilleIcon;
        window.getStatusClass = getStatusClass;
        window.getStatusText = getStatusText;
        window.formatDate = formatDate;
        window.formatDateTime = formatDateTime;
    </script>

    <script>
        // Variables globales pour le planning
        window.lastLoadedAffiches = [];
        let currentWeekStart = new Date(2025, 6, 8);

        // ========= FONCTIONS DE L'INTERFACE =========
        
        function showTab(tabName) {
            console.log('üîÑ Changement vers onglet:', tabName);
            
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.tab').classList.add('active');
            
            if (tabName === 'planning') {
                console.log('üìÖ Initialisation onglet Planning...');
                setTimeout(updateWeekHeader, 50);
                
                if (window.lastLoadedAffiches && window.lastLoadedAffiches.length > 0) {
                    console.log('üîÑ Forcer mise √† jour planning avec donn√©es existantes:', window.lastLoadedAffiches.length, 'affiches');
                    updatePlanningTab(window.lastLoadedAffiches);
                }
            }
        }

        function showParamsTab(tabName) {
            const contents = document.querySelectorAll('.params-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.params-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + '-params').classList.add('active');
            event.target.closest('.params-tab').classList.add('active');
        }

        // ========= MODALS AFFICHES =========
        
        function openModal() {
            document.getElementById('createModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        async function editAffiche(id) {
            const affiche = await window.loadAfficheForEdit(id);
            if (!affiche) return;
            
            document.getElementById('editAfficheId').value = affiche.id;
            document.getElementById('editLibelle').value = affiche.libelle || '';
            document.getElementById('editFamille').value = affiche.famille || '';
            document.getElementById('editPrix').value = affiche.prix || '';
            document.getElementById('editUnite').value = affiche.unite || '';
            document.getElementById('editOrigine').value = affiche.origine || '';
            document.getElementById('editStatut').value = affiche.statut || 'a-creer';
            
            if (affiche.dateDebut) {
                const dateDebut = new Date(affiche.dateDebut);
                document.getElementById('editDateDebut').value = dateDebut.toISOString().split('T')[0];
            }
            if (affiche.dateFin) {
                const dateFin = new Date(affiche.dateFin);
                document.getElementById('editDateFin').value = dateFin.toISOString().split('T')[0];
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            window.currentEditingAffiche = null;
        }

        function confirmDeleteAffiche(id, libelle) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'affiche :\n"${libelle}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteAffiche(id);
            }
        }

        // ========= MODALS UTILISATEURS =========
        
        function openInviteUserModal() {
            document.getElementById('inviteUserModal').style.display = 'block';
        }

        function closeInviteUserModal() {
            document.getElementById('inviteUserModal').style.display = 'none';
        }

        async function editUser(id) {
            const user = await window.loadUserForEdit(id);
            if (!user) return;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserFirstName').value = user.firstName || '';
            document.getElementById('editUserLastName').value = user.lastName || '';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserRole').value = user.role || 'employee';
            
            // Pr√©f√©rences de notification
            document.getElementById('editUserNotifCreation').checked = user.notificationPreferences?.creation || false;
            document.getElementById('editUserNotifDiffusion').checked = user.notificationPreferences?.diffusion || false;
            document.getElementById('editUserNotifExpiration').checked = user.notificationPreferences?.expiration || false;
            document.getElementById('editUserNotifArchivage').checked = user.notificationPreferences?.archivage || false;
            document.getElementById('editUserNotifResume').checked = user.notificationPreferences?.resume || false;
            
            // Canaux de notification
            document.getElementById('editUserCanalEmail').checked = user.notificationChannels?.email || false;
            document.getElementById('editUserCanalPush').checked = user.notificationChannels?.push || false;
            
            document.getElementById('editUserModal').style.display = 'block';
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        function confirmDeleteUser(id, name) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'utilisateur :\n"${name}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteUser(id);
            }
        }

        // ========= MODALS ORIGINES =========
        
        function openAddOriginModal() {
            document.getElementById('addOriginModal').style.display = 'block';
        }

        function closeAddOriginModal() {
            document.getElementById('addOriginModal').style.display = 'none';
        }

        async function editOrigine(id) {
            const origine = await window.loadOrigineForEdit(id);
            if (!origine) return;
            
            document.getElementById('editOriginId').value = origine.id;
            document.getElementById('editOrigineName').value = origine.nom || '';
            
            document.getElementById('editOriginModal').style.display = 'block';
        }

        function closeEditOriginModal() {
            document.getElementById('editOriginModal').style.display = 'none';
            window.currentEditingOrigine = null;
        }

        function confirmDeleteOrigine(id, nom) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'origine :\n"${nom}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteOrigine(id);
            }
        }

        // ========= MODALS UNITES =========
        
        function openAddUniteModal() {
            document.getElementById('addUniteModal').style.display = 'block';
        }

        function closeAddUniteModal() {
            document.getElementById('addUniteModal').style.display = 'none';
        }

        async function editUnite(id) {
            const unite = await window.loadUniteForEdit(id);
            if (!unite) return;
            
            document.getElementById('editUniteId').value = unite.id;
            document.getElementById('editUniteName').value = unite.nom || '';
            
            document.getElementById('editUniteModal').style.display = 'block';
        }

        function closeEditUniteModal() {
            document.getElementById('editUniteModal').style.display = 'none';
            window.currentEditingUnite = null;
        }

        function confirmDeleteUnite(id, nom) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'unit√© :\n"${nom}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteUnite(id);
            }
        }

        // ========= PLANNING =========
        
        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            updateWeekHeader();
            
            if (window.lastLoadedAffiches && window.lastLoadedAffiches.length > 0) {
                console.log('üîÑ Mise √† jour planning apr√®s changement de semaine');
                updatePlanningTab(window.lastLoadedAffiches);
            }
        }

        function updateWeekHeader() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const months = [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ];
            
            const startDay = currentWeekStart.getDate();
            const endDay = weekEnd.getDate();
            const month = months[currentWeekStart.getMonth()];
            const year = currentWeekStart.getFullYear();
            
            const weekNumber = getWeekNumber(currentWeekStart);
            const weekRange = `${startDay} - ${endDay} ${month} ${year}`;
            
            const currentWeekElement = document.getElementById('currentWeek');
            const weekNumberElement = document.getElementById('weekNumber');
            
            if (currentWeekElement) {
                currentWeekElement.textContent = weekRange;
            }
            
            if (weekNumberElement) {
                weekNumberElement.textContent = `Semaine ${weekNumber}`;
            }
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function updatePlanningTab(affiches) {
            console.log('üìÖ updatePlanningTab appel√©e avec:', affiches);
            
            const container = document.querySelector('#planningAffiches');
            if (!container) {
                console.log('‚ùå Container #planningAffiches non trouv√©');
                return;
            }
            
            const affichesPlanning = affiches.filter(a => {
                if (a.statut === 'archivee') {
                    return false;
                }
                return isAfficheActiveInWeek(a, currentWeekStart);
            });
            
            console.log('üìÖ Planning - Affiches filtr√©es pour cette semaine:', affichesPlanning);
            
            if (affichesPlanning.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        Aucune affiche active pour cette semaine
                    </div>
                `;
                return;
            }
            
            const planningHtml = affichesPlanning.map(affiche => {
                const iconClass = window.getFamilleIconClass(affiche.famille);
                const icon = window.getFamilleIcon(affiche.famille);
                const statusClass = `status-${affiche.statut}`;
                const statusText = window.getStatusText(affiche.statut);
                const dateDebut = window.formatDate(affiche.dateDebut);
                const dateFin = window.formatDate(affiche.dateFin);
                
                return `
                    <div class="planning-item ${statusClass}">
                        <div class="planning-item-icon ${iconClass}">${icon}</div>
                        <div class="planning-item-info">
                            <h4>${affiche.libelle}</h4>
                            <p>${affiche.prix}‚Ç¨/${affiche.unite} ‚Ä¢ ${affiche.origine}</p>
                            <p class="item-dates">${dateDebut} ‚Üí ${dateFin}</p>
                        </div>
                        <div class="planning-item-actions">
                            <span class="planning-status-badge ${statusClass}">${statusText}</span>
                            <div class="planning-item-actions-buttons">
                                <button class="action-btn edit-btn" onclick="editAffiche('${affiche.id}')">‚úèÔ∏è</button>
                                <button class="action-btn delete-btn" onclick="confirmDeleteAffiche('${affiche.id}', '${affiche.libelle}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = planningHtml;
        }

        function isAfficheActiveInWeek(affiche, weekStart) {
            if (!affiche.dateDebut || !affiche.dateFin) {
                return false;
            }
            
            const afficheDebut = new Date(affiche.dateDebut);
            const afficheFin = new Date(affiche.dateFin);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            afficheDebut.setHours(0, 0, 0, 0);
            afficheFin.setHours(23, 59, 59, 999);
            weekStart.setHours(0, 0, 0, 0);
            weekEnd.setHours(23, 59, 59, 999);
            
            return afficheDebut <= weekEnd && afficheFin >= weekStart;
        }

        // ========= RECHERCHE ET FILTRES =========
        
        function setupSearch() {
            const affichesSearch = document.querySelector('#affiches .search-bar input');
            if (affichesSearch) {
                affichesSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const items = document.querySelectorAll('#affiches .item');
                    
                    items.forEach(item => {
                        const title = item.querySelector('h4').textContent.toLowerCase();
                        const description = item.querySelector('p').textContent.toLowerCase();
                        
                        if (title.includes(searchTerm) || description.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn-affiches').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filterValue = this.dataset.filter;
                    filterAffiches(filterValue);
                });
            });
        }

        function filterAffiches(status) {
            const items = document.querySelectorAll('#affiches .item');
            const filterBtns = document.querySelectorAll('.filter-btn-affiches');
            
            filterBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-btn-affiches[data-filter="${status}"]`).classList.add('active');
            
            items.forEach(item => {
                if (status === 'all' || item.dataset.status === status) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // Fermer modals en cliquant dehors
        window.onclick = function(event) {
            const modals = [
                'createModal', 'editModal', 'inviteUserModal', 'editUserModal',
                'addOriginModal', 'editOriginModal', 'addUniteModal', 'editUniteModal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // ========= EVENT LISTENERS =========
        
        document.addEventListener('DOMContentLoaded', function() {
            // D√©finir les dates par d√©faut
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            const dateDebutInput = document.getElementById('dateDebut');
            const dateFinInput = document.getElementById('dateFin');
            
            if (dateDebutInput) dateDebutInput.valueAsDate = today;
            if (dateFinInput) dateFinInput.valueAsDate = nextWeek;

            // Event listener pour la connexion
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                window.loginUser();
            });

            // Event listener pour cr√©ation d'affiche
            document.getElementById('createForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                // G√©rer les valeurs "autre" pour origine et unit√©
                let origine = formData.get('origine');
                let unite = formData.get('unite');
                
                if (origine === 'autre') {
                    origine = prompt('Entrez le nom de la nouvelle origine:');
                    if (!origine) return;
                    
                    try {
                        await window.saveOrigine({ nom: origine });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'origine');
                        return;
                    }
                }
                
                if (unite === 'autre') {
                    unite = prompt('Entrez le nom de la nouvelle unit√©:');
                    if (!unite) return;
                    
                    try {
                        await window.saveUnite({ nom: unite });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'unit√©');
                        return;
                    }
                }
                
                const affiche = {
                    libelle: formData.get('libelle'),
                    famille: formData.get('famille'),
                    dateDebut: formData.get('dateDebut'),
                    dateFin: formData.get('dateFin'),
                    prix: parseFloat(formData.get('prix')),
                    unite: unite,
                    origine: origine,
                    statut: 'a-creer'
                };
                
                try {
                    await window.saveAffiche(affiche);
                    window.showSuccessMessage('üéâ Affiche cr√©√©e avec succ√®s!');
                    closeModal();
                    this.reset();
                    
                    // Remettre les dates par d√©faut
                    const today = new Date();
                    const nextWeek = new Date();
                    nextWeek.setDate(today.getDate() + 7);
                    document.getElementById('dateDebut').valueAsDate = today;
                    document.getElementById('dateFin').valueAsDate = nextWeek;
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la cr√©ation: ' + error.message);
                }
            });

            // Event listener pour modification d'affiche
            document.getElementById('editForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const afficheId = formData.get('editAfficheId');
                
                let origine = formData.get('editOrigine');
                let unite = formData.get('editUnite');
                
                if (origine === 'autre') {
                    origine = prompt('Entrez le nom de la nouvelle origine:');
                    if (!origine) return;
                    
                    try {
                        await window.saveOrigine({ nom: origine });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'origine');
                        return;
                    }
                }
                
                if (unite === 'autre') {
                    unite = prompt('Entrez le nom de la nouvelle unit√©:');
                    if (!unite) return;
                    
                    try {
                        await window.saveUnite({ nom: unite });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'unit√©');
                        return;
                    }
                }
                
                const updatedData = {
                    libelle: formData.get('editLibelle'),
                    famille: formData.get('editFamille'),
                    dateDebut: formData.get('editDateDebut'),
                    dateFin: formData.get('editDateFin'),
                    prix: parseFloat(formData.get('editPrix')),
                    unite: unite,
                    origine: origine,
                    statut: formData.get('editStatut')
                };
                
                try {
                    await window.updateAffiche(afficheId, updatedData);
                    closeEditModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listener pour invitation d'utilisateur
            document.getElementById('inviteUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const userData = {
                    email: formData.get('inviteEmail'),
                    firstName: formData.get('inviteFirstName'),
                    lastName: formData.get('inviteLastName'),
                    role: formData.get('inviteRole'),
                    defaultEmail: document.getElementById('inviteDefaultEmail').checked,
                    defaultPush: document.getElementById('inviteDefaultPush').checked
                };
                
                try {
                    await window.inviteUser(userData);
                    closeInviteUserModal();
                    this.reset();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de l\'invitation: ' + error.message);
                }
            });

            // Event listener pour modification d'utilisateur
            document.getElementById('editUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const userId = formData.get('editUserId');
                
                const updatedData = {
                    firstName: formData.get('editUserFirstName'),
                    lastName: formData.get('editUserLastName'),
                    role: formData.get('editUserRole'),
                    notificationPreferences: {
                        creation: document.getElementById('editUserNotifCreation').checked,
                        diffusion: document.getElementById('editUserNotifDiffusion').checked,
                        expiration: document.getElementById('editUserNotifExpiration').checked,
                        archivage: document.getElementById('editUserNotifArchivage').checked,
                        resume: document.getElementById('editUserNotifResume').checked
                    },
                    notificationChannels: {
                        email: document.getElementById('editUserCanalEmail').checked,
                        push: document.getElementById('editUserCanalPush').checked
                    }
                };
                
                try {
                    await window.updateUser(userId, updatedData);
                    closeEditUserModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listener pour ajout d'origine
            document.getElementById('addOriginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const origine = {
                    nom: formData.get('origineName').trim()
                };
                
                if (window.origines.some(o => o.nom.toLowerCase() === origine.nom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette origine existe d√©j√†');
                    return;
                }
                
                try {
                    await window.saveOrigine(origine);
                    window.showSuccessMessage(`üéâ Origine "${origine.nom}" ajout√©e avec succ√®s!`);
                    closeAddOriginModal();
                    this.reset();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de l\'ajout: ' + error.message);
                }
            });

            // Event listener pour modification d'origine
            document.getElementById('editOriginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const origineId = formData.get('editOriginId');
                const nouveauNom = formData.get('editOrigineName').trim();
                
                if (window.origines.some(o => o.id !== origineId && o.nom.toLowerCase() === nouveauNom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette origine existe d√©j√†');
                    return;
                }
                
                const updatedData = {
                    nom: nouveauNom
                };
                
                try {
                    await window.updateOrigine(origineId, updatedData);
                    closeEditOriginModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listener pour ajout d'unit√©
            document.getElementById('addUniteForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const unite = {
                    nom: formData.get('uniteName').trim()
                };
                
                if (window.unites.some(u => u.nom.toLowerCase() === unite.nom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette unit√© existe d√©j√†');
                    return;
                }
                
                try {
                    await window.saveUnite(unite);
                    window.showSuccessMessage(`üéâ Unit√© "${unite.nom}" ajout√©e avec succ√®s!`);
                    closeAddUniteModal();
                    this.reset();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de l\'ajout: ' + error.message);
                }
            });

            // Event listener pour modification d'unit√©
            document.getElementById('editUniteForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const uniteId = formData.get('editUniteId');
                const nouveauNom = formData.get('editUniteName').trim();
                
                if (window.unites.some(u => u.id !== uniteId && u.nom.toLowerCase() === nouveauNom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette unit√© existe d√©j√†');
                    return;
                }
                
                const updatedData = {
                    nom: nouveauNom
                };
                
                try {
                    await window.updateUnite(uniteId, updatedData);
                    closeEditUniteModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listeners pour les pr√©f√©rences de notification
            document.querySelectorAll('#notifications-params input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    if (window.currentUserData) {
                        const prefType = this.id.replace('notif-', '').replace('canal-', '');
                        
                        try {
                            if (this.id.startsWith('notif-')) {
                                window.currentUserData.notificationPreferences[prefType] = this.checked;
                            } else if (this.id.startsWith('canal-')) {
                                window.currentUserData.notificationChannels[prefType] = this.checked;
                            }
                            
                            // Sauvegarder en base
                            await window.updateUser(window.currentUserData.id, {
                                notificationPreferences: window.currentUserData.notificationPreferences,
                                notificationChannels: window.currentUserData.notificationChannels
                            });
                            
                            window.showSuccessMessage('‚úÖ Pr√©f√©rences mises √† jour');
                        } catch (error) {
                            window.showErrorMessage('‚ùå Erreur lors de la sauvegarde');
                            this.checked = !this.checked; // Revenir √† l'√©tat pr√©c√©dent
                        }
                    }
                });
            });
        });

        // Exposer les fonctions n√©cessaires globalement
        window.showTab = showTab;
        window.showParamsTab = showParamsTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.editAffiche = editAffiche;
        window.closeEditModal = closeEditModal;
        window.confirmDeleteAffiche = confirmDeleteAffiche;
        window.openInviteUserModal = openInviteUserModal;
        window.closeInviteUserModal = closeInviteUserModal;
        window.editUser = editUser;
        window.closeEditUserModal = closeEditUserModal;
        window.confirmDeleteUser = confirmDeleteUser;
        window.openAddOriginModal = openAddOriginModal;
        window.closeAddOriginModal = closeAddOriginModal;
        window.editOrigine = editOrigine;
        window.closeEditOriginModal = closeEditOriginModal;
        window.confirmDeleteOrigine = confirmDeleteOrigine;
        window.openAddUniteModal = openAddUniteModal;
        window.closeAddUniteModal = closeAddUniteModal;
        window.editUnite = editUnite;
        window.closeEditUniteModal = closeEditUniteModal;
        window.confirmDeleteUnite = confirmDeleteUnite;
        window.changeWeek = changeWeek;
        window.updateWeekHeader = updateWeekHeader;
        window.updatePlanningTab = updatePlanningTab;
    </script>
</body>
</html>
