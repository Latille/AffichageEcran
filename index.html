<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestion Affichage Publicitaire</title>
    
    <!-- PWA Configuration -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestion Affichage">
    <meta name="theme-color" content="#667eea">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-logo {
            font-size: 20px;
        }

        .header h1 {
            font-size: 18px;
            margin: 0;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .tab-icon {
            font-size: 18px;
        }

        .tab-text {
            font-size: 12px;
        }

        .tab-content {
            display: none;
            padding: 20px;
            height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 12px;
            min-height: 60px;       /* hauteur minimum plus petite */
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 12px;
            opacity: 0.9;
        }

        .recent-items {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .recent-items h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 8px 12px;      /* moins de padding vertical */
            min-height: 30px;       /* hauteur minimum plus petite */
            background: linear-gradient(135deg, #fef7ff 0%, #fdf2f8 100%);
            color: #333;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .item:nth-child(even) {
            background: linear-gradient(135deg, #f8faff 0%, #f1f5f9 100%);
        }

        .item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            color: white;
        }

        .item-info {
            flex: 1;
        }

        .item-info h4 {
            font-size: 14px;
            margin-bottom: 3px;
            color: #333;
        }

        .item-info p {
            font-size: 12px;
            color: #666;
        }

        .item-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .item-actions-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn {
            background: #e3f2fd;
            color: #1976d2;
        }

        .edit-btn:hover {
            background: #1976d2;
            color: white;
            transform: scale(1.1);
        }

        .delete-btn {
            background: #ffebee;
            color: #d32f2f;
        }

        .delete-btn:hover {
            background: #d32f2f;
            color: white;
            transform: scale(1.1);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .status-a-creer {
            background: #fff3cd;
            color: #856404;
        }

        .status-programmee {
            background: #d4edda;
            color: #155724;
        }

        .status-en-diffusion {
            background: #cce5ff;
            color: #004085;
        }

        .status-archivee {
            background: #f8d7da;
            color: #721c24;
        }

        .category-fruits { background: #4CAF50; }
        .category-traiteur { background: #FF9800; }
        .category-boucherie { background: #F44336; }
        .category-cremerie { background: #2196F3; }
        .category-epicerie { background: #9C27B0; }
        .category-boulangerie { background: #FF5722; }
        .category-autre { background: #607D8B; }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
        }

        .search-bar::after {
            content: "üîç";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .filter-section h4 {
            margin-bottom: 12px;
            font-size: 14px;
            color: #333;
        }

        .filter-buttons {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .filter-btn, .filter-btn-affiches {
            padding: 6px 8px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: capitalize;
            white-space: nowrap;
        }

        .filter-btn.active, .filter-btn-affiches.active,
        .filter-btn:hover, .filter-btn-affiches:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .item.hidden {
            display: none;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 16px;
            border-radius: 12px;
            max-width: 90%;
            width: 350px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .form-row .form-group {
            margin-bottom: 12px;
        }

        .form-row .form-group label {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .form-row .form-group input,
        .form-row .form-group select {
            padding: 7px 8px;
            font-size: 13px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .alert-error {
            background: #ffebee;
            border: 1px solid #f8bbd9;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* Param√®tres sous-onglets */
        .params-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .params-tab {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            border-right: 1px solid #e9ecef;
        }

        .params-tab:last-child {
            border-right: none;
        }

        .params-tab.active {
            background: #667eea;
            color: white;
        }

        .params-tab-icon {
            font-size: 16px;
        }

        .params-content {
            display: none;
        }

        .params-content.active {
            display: block;
        }

        .param-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }

        .param-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .param-item:last-child {
            margin-bottom: 0;
        }

        .param-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .param-actions {
            display: flex;
            gap: 8px;
        }

        .add-param-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-param-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .empty-params {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px 20px;
        }

        /* Planning styles */
        .agenda-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .week-info {
            text-align: center;
        }

        .week-info h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .week-info p {
            margin: 2px 0 0 0;
            font-size: 12px;
            color: #666;
            font-weight: 400;
        }

        .planning-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .planning-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;      /* moins de padding vertical */
            min-height: 40px;       /* hauteur minimum plus petite */
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            border-left: 4px solid transparent;
        }

        .planning-item.status-a-creer {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
        }

        .planning-item.status-programmee {
            border-left-color: #fd7e14;
            background: linear-gradient(135deg, #fff8f1 0%, #fef3e2 100%);
        }

        .planning-item.status-en-diffusion {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%);
        }

        .planning-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            color: white;
        }

        .planning-item-info {
            flex: 1;
        }

        .planning-item-info h4 {
            font-size: 14px;
            margin-bottom: 3px;
            color: #333;
        }

        .planning-item-info p {
            font-size: 12px;
            color: #666;
        }

        .planning-item-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .planning-item-actions-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .planning-status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .planning-status-badge.status-a-creer {
            background: #dc3545;
            color: white;
        }

        .planning-status-badge.status-programmee {
            background: #fd7e14;
            color: white;
        }

        .planning-status-badge.status-en-diffusion {
            background: #28a745;
            color: white;
        }

        .nav-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        /* Notifications styles */
        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .settings-card h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info h5 {
            margin: 0 0 4px 0;
            font-size: 14px;
            color: #333;
        }

        .setting-info p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        #loginModal {
            z-index: 2000;
        }

        #loginModal .modal-content {
            width: 320px;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

       /* Responsive */
        @media screen and (max-width: 420px) {
            .container {
                max-width: 100%;
                box-shadow: none;
            }
            
            .modal-content {
                width: 95%;
                max-width: 350px;
            }
            
            /* SOLUTION 1: Forcer l'affichage c√¥te √† c√¥te sur mobile */
            .form-row {
                grid-template-columns: 1fr 1fr !important;
                gap: 6px !important;
            }
        }

    </style>
</head>
<body>
    <!-- Modal de connexion -->
    <div id="loginModal" class="modal" style="display:block;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Connexion</h3>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" name="loginEmail" required placeholder="test@exemple.com">
                </div>

                <div class="form-group">
                    <label for="loginPassword">Mot de passe</label>
                    <input type="password" id="loginPassword" name="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <div id="loginError" class="alert-error" style="display:none;"></div>

                <button type="submit" class="btn">üîì Se connecter</button>
                
                <p style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                    Cr√©ez un compte dans la console Firebase ou utilisez un compte de test
                </p>
            </form>
        </div>
    </div>

    <!-- Application principale -->
    <div id="appContainer" class="container" style="display:none;">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">üì∫</div>
                <h1>Gestion Affichage</h1>
            </div>
            <button onclick="logoutUser()" class="logout-btn">üö™ D√©connexion</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('dashboard')">
                <div class="tab-icon">üìä</div>
                <div class="tab-text">Dashboard</div>
            </div>
            <div class="tab" onclick="showTab('planning')">
                <div class="tab-icon">üìÖ</div>
                <div class="tab-text">Planning</div>
            </div>
            <div class="tab" onclick="showTab('affiches')">
                <div class="tab-icon">üìã</div>
                <div class="tab-text">Affiches</div>
            </div>
            <div class="tab" onclick="showTab('parametres')">
                <div class="tab-icon">‚öôÔ∏è</div>
                <div class="tab-text">Param√®tres</div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>0</h3>
                    <p>En diffusion</p>
                </div>
                <div class="stat-card">
                    <h3>0</h3>
                    <p>√Ä cr√©er</p>
                </div>
                <div class="stat-card">
                    <h3>0</h3>
                    <p>Programm√©es</p>
                </div>
                <div class="stat-card">
                    <h3>0</h3>
                    <p>Archiv√©es</p>
                </div>
            </div>

            <div class="recent-items">
                <h3>üì∫ Affiches en diffusion</h3>
                <div class="empty-state">
                    Aucune affiche en diffusion pour le moment
                </div>
            </div>
        </div>

        <!-- Planning -->
        <div id="planning" class="tab-content">
            <div class="agenda-header">
                <button class="nav-btn" onclick="changeWeek(-1)">‚Äπ</button>
                <div class="week-info">
                    <h3 id="currentWeek">8 - 14 Juillet 2025</h3>
                    <p id="weekNumber">Semaine 28</p>
                </div>
                <button class="nav-btn" onclick="changeWeek(1)">‚Ä∫</button>
            </div>
            
            <div id="planningAffiches" class="planning-container">
                <div class="empty-state">
                    Aucune affiche √† planifier pour le moment
                </div>
            </div>
        </div>

        <!-- Affiches -->
        <div id="affiches" class="tab-content">
            <div class="search-bar">
                <input type="text" placeholder="Rechercher une affiche...">
            </div>
            
            <div class="filter-section">
                <h4>üîç Filtrer par √©tat</h4>
                <div class="filter-buttons">
                    <button class="filter-btn-affiches active" data-filter="all">Tous</button>
                    <button class="filter-btn-affiches" data-filter="a-creer">√Ä cr√©er</button>
                    <button class="filter-btn-affiches" data-filter="programmee">Prog.</button>
                    <button class="filter-btn-affiches" data-filter="en-diffusion">Diff.</button>
                    <button class="filter-btn-affiches" data-filter="archivee">Archiv.</button>
                </div>
            </div>
            
            <div class="empty-state">
                Aucune affiche cr√©√©e pour le moment.<br>
                Cliquez sur le bouton + pour cr√©er votre premi√®re affiche !
            </div>
        </div>

        <!-- Param√®tres -->
        <div id="parametres" class="tab-content">
            <div class="params-tabs">
                <div class="params-tab active" onclick="showParamsTab('origines')">
                    <div class="params-tab-icon">üåç</div>
                    <div>Origines</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('unites')">
                    <div class="params-tab-icon">üè∑Ô∏è</div>
                    <div>Unit√©s</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('notifications')">
                    <div class="params-tab-icon">üîî</div>
                    <div>Notifs</div>
                </div>
                <div class="params-tab" onclick="showParamsTab('systeme')">
                    <div class="params-tab-icon">‚öôÔ∏è</div>
                    <div>Syst√®me</div>
                </div>
            </div>

            <!-- Gestion des Origines -->
            <div id="origines-params" class="params-content active">
                <button class="add-param-btn" onclick="openAddOriginModal()">
                    ‚ûï Ajouter une origine
                </button>
                
                <div id="originesList" class="param-list">
                    <div class="empty-params">
                        Aucune origine configur√©e.<br>
                        Cliquez sur "Ajouter une origine" pour commencer.
                    </div>
                </div>
            </div>

            <!-- Gestion des Unit√©s -->
            <div id="unites-params" class="params-content">
                <button class="add-param-btn" onclick="openAddUniteModal()">
                    ‚ûï Ajouter une unit√©
                </button>
                
                <div id="unitesList" class="param-list">
                    <div class="empty-params">
                        Aucune unit√© configur√©e.<br>
                        Cliquez sur "Ajouter une unit√©" pour commencer.
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div id="notifications-params" class="params-content">
                <div class="settings-card">
                    <h4>‚öôÔ∏è Param√®tres de notification</h4>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Notifications d'expiration</h5>
                            <p>Alerter 24h avant expiration</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Cr√©ations d'affiches</h5>
                            <p>Notifier √† chaque cr√©ation</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Mises en diffusion</h5>
                            <p>Notifier lors du d√©marrage</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>R√©sum√© quotidien</h5>
                            <p>Envoi √† 08h00 chaque jour</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Syst√®me -->
            <div id="systeme-params" class="params-content">
                <div class="settings-card">
                    <h4>üìß Serveur SMTP</h4>
                    <div class="form-group">
                        <label>Serveur</label>
                        <input type="text" value="smtp.gmail.com" placeholder="smtp.exemple.com">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" value="587" placeholder="587">
                        </div>
                        <div class="form-group">
                            <label>S√©curit√©</label>
                            <select>
                                <option value="tls">TLS</option>
                                <option value="ssl">SSL</option>
                                <option value="none">Aucune</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email exp√©diteur</label>
                        <input type="email" value="affichage@monmagasin.fr" placeholder="votre@email.com">
                    </div>
                    <button class="btn" style="margin-top: 15px;">üíæ Sauvegarder</button>
                </div>
            </div>
        </div>

        <button class="fab" onclick="openModal()">+</button>
    </div>

    <!-- Modal de cr√©ation d'affiche -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Nouvelle affiche</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <form id="createForm">
                <div class="form-group">
                    <label for="libelle">Libell√© *</label>
                    <input type="text" id="libelle" name="libelle" placeholder="Ex: Pommes Golden" required>
                </div>

                <div class="form-group">
                    <label for="famille">Famille *</label>
                    <select id="famille" name="famille" required>
                        <option value="">Choisir une famille</option>
                        <option value="fruits-legumes">üçé Fruits & l√©gumes</option>
                        <option value="traiteur">ü•ò Traiteur</option>
                        <option value="boucherie">ü•© Boucherie</option>
                        <option value="cremerie">üßÄ Cr√©merie</option>
                        <option value="epicerie">üõí Epicerie</option>
                        <option value="boulangerie">ü•ñ Boulangerie</option>
                        <option value="autre">üì¶ Autre</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dateDebut">D√©but *</label>
                        <input type="date" id="dateDebut" name="dateDebut" required>
                    </div>
                    <div class="form-group">
                        <label for="dateFin">Fin *</label>
                        <input type="date" id="dateFin" name="dateFin" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="prix">Prix *</label>
                        <input type="number" id="prix" name="prix" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="unite">Unit√© *</label>
                        <select id="unite" name="unite" required>
                            <option value="">Choisir une unit√©</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="origine">Origine *</label>
                    <select id="origine" name="origine" required>
                        <option value="">Choisir une origine</option>
                    </select>
                </div>

                <button type="submit" class="btn">‚úÖ Cr√©er l'affiche</button>
            </form>
        </div>
    </div>

    <!-- Modal d'√©dition d'affiche -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'affiche</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            
            <form id="editForm">
                <input type="hidden" id="editAfficheId" name="editAfficheId">
                
                <div class="form-group">
                    <label for="editLibelle">Libell√© *</label>
                    <input type="text" id="editLibelle" name="editLibelle" placeholder="Ex: Pommes Golden" required>
                </div>

                <div class="form-group">
                    <label for="editFamille">Famille *</label>
                    <select id="editFamille" name="editFamille" required>
                        <option value="">Choisir une famille</option>
                        <option value="fruits-legumes">üçé Fruits & l√©gumes</option>
                        <option value="traiteur">ü•ò Traiteur</option>
                        <option value="boucherie">ü•© Boucherie</option>
                        <option value="cremerie">üßÄ Cr√©merie</option>
                        <option value="epicerie">üõí Epicerie</option>
                        <option value="boulangerie">ü•ñ Boulangerie</option>
                        <option value="autre">üì¶ Autre</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editDateDebut">D√©but *</label>
                        <input type="date" id="editDateDebut" name="editDateDebut" required>
                    </div>
                    <div class="form-group">
                        <label for="editDateFin">Fin *</label>
                        <input type="date" id="editDateFin" name="editDateFin" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPrix">Prix *</label>
                        <input type="number" id="editPrix" name="editPrix" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="editUnite">Unit√© *</label>
                        <select id="editUnite" name="editUnite" required>
                            <option value="">Choisir une unit√©</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editOrigine">Origine *</label>
                    <select id="editOrigine" name="editOrigine" required>
                        <option value="">Choisir une origine</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editStatut">Statut *</label>
                    <select id="editStatut" name="editStatut" required>
                        <option value="a-creer">√Ä cr√©er</option>
                        <option value="programmee">Programm√©e</option>
                        <option value="en-diffusion">En diffusion</option>
                        <option value="archivee">Archiv√©e</option>
                    </select>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <!-- Modal d'ajout d'origine -->
    <div id="addOriginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üåç Nouvelle origine</h3>
                <span class="close" onclick="closeAddOriginModal()">&times;</span>
            </div>
            
            <form id="addOriginForm">
                <div class="form-group">
                    <label for="origineName">Nom de l'origine *</label>
                    <input type="text" id="origineName" name="origineName" placeholder="Ex: France, Espagne..." required>
                </div>

                <button type="submit" class="btn">‚úÖ Ajouter</button>
            </form>
        </div>
    </div>

    <!-- Modal d'√©dition d'origine -->
    <div id="editOriginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'origine</h3>
                <span class="close" onclick="closeEditOriginModal()">&times;</span>
            </div>
            
            <form id="editOriginForm">
                <input type="hidden" id="editOriginId" name="editOriginId">
                
                <div class="form-group">
                    <label for="editOrigineName">Nom de l'origine *</label>
                    <input type="text" id="editOrigineName" name="editOrigineName" placeholder="Ex: France, Espagne..." required>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <!-- Modal d'ajout d'unit√© -->
    <div id="addUniteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üè∑Ô∏è Nouvelle unit√©</h3>
                <span class="close" onclick="closeAddUniteModal()">&times;</span>
            </div>
            
            <form id="addUniteForm">
                <div class="form-group">
                    <label for="uniteName">Nom de l'unit√© *</label>
                    <input type="text" id="uniteName" name="uniteName" placeholder="Ex: Kg, Pi√®ce, Barquette..." required>
                </div>

                <button type="submit" class="btn">‚úÖ Ajouter</button>
            </form>
        </div>
    </div>

    <!-- Modal d'√©dition d'unit√© -->
    <div id="editUniteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'unit√©</h3>
                <span class="close" onclick="closeEditUniteModal()">&times;</span>
            </div>
            
            <form id="editUniteForm">
                <input type="hidden" id="editUniteId" name="editUniteId">
                
                <div class="form-group">
                    <label for="editUniteName">Nom de l'unit√© *</label>
                    <input type="text" id="editUniteName" name="editUniteName" placeholder="Ex: Kg, Pi√®ce, Barquette..." required>
                </div>

                <button type="submit" class="btn">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, serverTimestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAtZUiFPFrqU-PiMpIOrPIwrjJLv_NsKRU",
            authDomain: "gestion-affichage-publicitaire.firebaseapp.com",
            projectId: "gestion-affichage-publicitaire",
            storageBucket: "gestion-affichage-publicitaire.firebasestorage.app",
            messagingSenderId: "715445646165",
            appId: "1:715445646165:web:4da37e196e6a772f0735dc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.currentUser = null;
        window.origines = [];
        window.unites = [];

        // V√©rifier l'√©tat de connexion
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                loadAllData();
            } else {
                window.currentUser = null;
                document.getElementById('loginModal').style.display = 'block';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        // Connexion utilisateur
        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('loginError').style.display = 'none';
            } catch (error) {
                document.getElementById('loginError').textContent = 'Erreur de connexion : ' + error.message;
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // D√©connexion utilisateur
        async function logoutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
            }
        }

        // Charger toutes les donn√©es
        async function loadAllData() {
            await loadOrigines();
            await loadUnites();
            await loadAffiches();
            setTimeout(() => {
                setupSearch();
                setupFilters();
                updateSelectOptions();
            }, 100);
        }

        // ========= GESTION DES ORIGINES =========
        
        // Charger les origines
        async function loadOrigines() {
            try {
                const q = query(collection(db, 'origines'), orderBy('nom', 'asc'));
                const querySnapshot = await getDocs(q);
                const origines = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.utilisateurId === window.currentUser.uid) {
                        origines.push({ id: doc.id, ...data });
                    }
                });
                
                window.origines = origines;
                displayOrigines(origines);
                
                // Ajouter des origines par d√©faut si aucune n'existe
                if (origines.length === 0) {
                    await createDefaultOrigines();
                }
                
                console.log('Origines charg√©es:', origines.length);
            } catch (error) {
                console.error('Erreur chargement origines:', error);
                showErrorMessage('Erreur lors du chargement des origines');
            }
        }

        // Cr√©er des origines par d√©faut
        async function createDefaultOrigines() {
            const defaultOrigines = ['France', 'Espagne', 'Italie', 'Pays-Bas', 'Belgique', 'Maroc'];
            
            for (const origine of defaultOrigines) {
                try {
                    await addDoc(collection(db, 'origines'), {
                        nom: origine,
                        dateCreation: serverTimestamp(),
                        utilisateurId: window.currentUser.uid
                    });
                } catch (error) {
                    console.error('Erreur cr√©ation origine par d√©faut:', error);
                }
            }
            
            // Recharger apr√®s cr√©ation
            await loadOrigines();
        }

        // Afficher les origines
        function displayOrigines(origines) {
            const container = document.getElementById('originesList');
            
            if (origines.length === 0) {
                container.innerHTML = `
                    <div class="empty-params">
                        Aucune origine configur√©e.<br>
                        Cliquez sur "Ajouter une origine" pour commencer.
                    </div>
                `;
                return;
            }
            
            const originesHtml = origines.map(origine => `
                <div class="param-item">
                    <span class="param-name">${origine.nom}</span>
                    <div class="param-actions">
                        <button class="action-btn edit-btn" onclick="editOrigine('${origine.id}')">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="confirmDeleteOrigine('${origine.id}', '${origine.nom}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = originesHtml;
        }

        // Sauvegarder une origine
        async function saveOrigine(origine) {
            try {
                const docRef = await addDoc(collection(db, 'origines'), {
                    ...origine,
                    dateCreation: serverTimestamp(),
                    utilisateurId: window.currentUser.uid
                });
                console.log('Origine sauv√©e avec ID:', docRef.id);
                await loadOrigines();
                updateSelectOptions();
                return docRef.id;
            } catch (error) {
                console.error('Erreur sauvegarde origine:', error);
                throw error;
            }
        }

        // Mettre √† jour une origine
        async function updateOrigine(id, data) {
            try {
                const docRef = doc(db, 'origines', id);
                await updateDoc(docRef, {
                    ...data,
                    dateModification: serverTimestamp()
                });
                showSuccessMessage('‚úÖ Origine mise √† jour avec succ√®s');
                await loadOrigines();
                updateSelectOptions();
                return true;
            } catch (error) {
                console.error('Erreur mise √† jour origine:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        // Supprimer une origine
        async function deleteOrigine(id) {
            try {
                await deleteDoc(doc(db, 'origines', id));
                showSuccessMessage('üóëÔ∏è Origine supprim√©e avec succ√®s');
                await loadOrigines();
                updateSelectOptions();
            } catch (error) {
                console.error('Erreur suppression origine:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        // ========= GESTION DES UNITES =========
        
        // Charger les unit√©s
        async function loadUnites() {
            try {
                const q = query(collection(db, 'unites'), orderBy('nom', 'asc'));
                const querySnapshot = await getDocs(q);
                const unites = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.utilisateurId === window.currentUser.uid) {
                        unites.push({ id: doc.id, ...data });
                    }
                });
                
                window.unites = unites;
                displayUnites(unites);
                
                // Ajouter des unit√©s par d√©faut si aucune n'existe
                if (unites.length === 0) {
                    await createDefaultUnites();
                }
                
                console.log('Unit√©s charg√©es:', unites.length);
            } catch (error) {
                console.error('Erreur chargement unit√©s:', error);
                showErrorMessage('Erreur lors du chargement des unit√©s');
            }
        }

        // Cr√©er des unit√©s par d√©faut
        async function createDefaultUnites() {
            const defaultUnites = ['Kg', 'g', 'L', 'mL', 'Unit√©', 'Pi√®ce', 'Barquette', 'Sachet', 'Botte', 'Bouquet'];
            
            for (const unite of defaultUnites) {
                try {
                    await addDoc(collection(db, 'unites'), {
                        nom: unite,
                        dateCreation: serverTimestamp(),
                        utilisateurId: window.currentUser.uid
                    });
                } catch (error) {
                    console.error('Erreur cr√©ation unit√© par d√©faut:', error);
                }
            }
            
            // Recharger apr√®s cr√©ation
            await loadUnites();
        }

        // Afficher les unit√©s
        function displayUnites(unites) {
            const container = document.getElementById('unitesList');
            
            if (unites.length === 0) {
                container.innerHTML = `
                    <div class="empty-params">
                        Aucune unit√© configur√©e.<br>
                        Cliquez sur "Ajouter une unit√©" pour commencer.
                    </div>
                `;
                return;
            }
            
            const unitesHtml = unites.map(unite => `
                <div class="param-item">
                    <span class="param-name">${unite.nom}</span>
                    <div class="param-actions">
                        <button class="action-btn edit-btn" onclick="editUnite('${unite.id}')">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="confirmDeleteUnite('${unite.id}', '${unite.nom}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = unitesHtml;
        }

        // Sauvegarder une unit√©
        async function saveUnite(unite) {
            try {
                const docRef = await addDoc(collection(db, 'unites'), {
                    ...unite,
                    dateCreation: serverTimestamp(),
                    utilisateurId: window.currentUser.uid
                });
                console.log('Unit√© sauv√©e avec ID:', docRef.id);
                await loadUnites();
                updateSelectOptions();
                return docRef.id;
            } catch (error) {
                console.error('Erreur sauvegarde unit√©:', error);
                throw error;
            }
        }

        // Mettre √† jour une unit√©
        async function updateUnite(id, data) {
            try {
                const docRef = doc(db, 'unites', id);
                await updateDoc(docRef, {
                    ...data,
                    dateModification: serverTimestamp()
                });
                showSuccessMessage('‚úÖ Unit√© mise √† jour avec succ√®s');
                await loadUnites();
                updateSelectOptions();
                return true;
            } catch (error) {
                console.error('Erreur mise √† jour unit√©:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        // Supprimer une unit√©
        async function deleteUnite(id) {
            try {
                await deleteDoc(doc(db, 'unites', id));
                showSuccessMessage('üóëÔ∏è Unit√© supprim√©e avec succ√®s');
                await loadUnites();
                updateSelectOptions();
            } catch (error) {
                console.error('Erreur suppression unit√©:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        // ========= MISE √Ä JOUR DES SELECT =========
        
        // Mettre √† jour les options des selects
        function updateSelectOptions() {
            // Mettre √† jour les selects d'origines
            const origineSelects = ['origine', 'editOrigine'];
            origineSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Choisir une origine</option>';
                    
                    window.origines.forEach(origine => {
                        const option = document.createElement('option');
                        option.value = origine.nom;
                        option.textContent = origine.nom;
                        select.appendChild(option);
                    });
                    
                    // Option "Autre"
                    const autreOption = document.createElement('option');
                    autreOption.value = 'autre';
                    autreOption.textContent = '‚ûï Autre...';
                    select.appendChild(autreOption);
                    
                    // Restaurer la valeur s√©lectionn√©e
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            });
            
            // Mettre √† jour les selects d'unit√©s
            const uniteSelects = ['unite', 'editUnite'];
            uniteSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Choisir une unit√©</option>';
                    
                    window.unites.forEach(unite => {
                        const option = document.createElement('option');
                        option.value = unite.nom;
                        option.textContent = unite.nom;
                        select.appendChild(option);
                    });
                    
                    // Option "Autre"
                    const autreOption = document.createElement('option');
                    autreOption.value = 'autre';
                    autreOption.textContent = '‚ûï Autre...';
                    select.appendChild(autreOption);
                    
                    // Restaurer la valeur s√©lectionn√©e
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // ========= GESTION DES AFFICHES (inchang√©) =========
        
        // Charger les affiches
        async function loadAffiches() {
            try {
                const q = query(collection(db, 'affiches'), orderBy('dateCreation', 'desc'));
                const querySnapshot = await getDocs(q);
                const affiches = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.dateCreation && data.dateCreation.toDate) {
                        data.dateCreation = data.dateCreation.toDate();
                    }
                    affiches.push({ id: doc.id, ...data });
                });
                
                displayAffiches(affiches);
                console.log('Affiches charg√©es:', affiches.length);
            } catch (error) {
                console.error('Erreur chargement affiches:', error);
                showErrorMessage('Erreur lors du chargement des affiches');
            }
        }

        // Sauvegarder une affiche
        async function saveAffiche(affiche) {
            try {
                const docRef = await addDoc(collection(db, 'affiches'), {
                    ...affiche,
                    dateCreation: serverTimestamp(),
                    utilisateurId: window.currentUser.uid
                });
                console.log('Affiche sauv√©e avec ID:', docRef.id);
                await loadAffiches();
                return docRef.id;
            } catch (error) {
                console.error('Erreur sauvegarde affiche:', error);
                throw error;
            }
        }

        // Mettre √† jour une affiche
        async function updateAffiche(id, data) {
            try {
                const docRef = doc(db, 'affiches', id);
                await updateDoc(docRef, {
                    ...data,
                    dateModification: serverTimestamp()
                });
                showSuccessMessage('‚úÖ Affiche mise √† jour avec succ√®s');
                await loadAffiches();
                return true;
            } catch (error) {
                console.error('Erreur mise √† jour affiche:', error);
                showErrorMessage('‚ùå Erreur lors de la mise √† jour');
                return false;
            }
        }

        // Supprimer une affiche
        async function deleteAffiche(id) {
            try {
                await deleteDoc(doc(db, 'affiches', id));
                showSuccessMessage('üóëÔ∏è Affiche supprim√©e avec succ√®s');
                await loadAffiches();
            } catch (error) {
                console.error('Erreur suppression affiche:', error);
                showErrorMessage('‚ùå Erreur lors de la suppression');
            }
        }

        // Charger une affiche pour √©dition
        async function loadAfficheForEdit(id) {
            try {
                const docRef = doc(db, 'affiches', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const affiche = { id: docSnap.id, ...docSnap.data() };
                    window.currentEditingAffiche = affiche;
                    return affiche;
                } else {
                    showErrorMessage('‚ùå Affiche non trouv√©e');
                    return null;
                }
            } catch (error) {
                console.error('Erreur chargement affiche:', error);
                showErrorMessage('‚ùå Erreur lors du chargement');
                return null;
            }
        }

        // Charger une origine pour √©dition
        async function loadOrigineForEdit(id) {
            try {
                const docRef = doc(db, 'origines', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const origine = { id: docSnap.id, ...docSnap.data() };
                    window.currentEditingOrigine = origine;
                    return origine;
                } else {
                    showErrorMessage('‚ùå Origine non trouv√©e');
                    return null;
                }
            } catch (error) {
                console.error('Erreur chargement origine:', error);
                showErrorMessage('‚ùå Erreur lors du chargement');
                return null;
            }
        }

        // Charger une unit√© pour √©dition
        async function loadUniteForEdit(id) {
            try {
                const docRef = doc(db, 'unites', id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const unite = { id: docSnap.id, ...docSnap.data() };
                    window.currentEditingUnite = unite;
                    return unite;
                } else {
                    showErrorMessage('‚ùå Unit√© non trouv√©e');
                    return null;
                }
            } catch (error) {
                console.error('Erreur chargement unit√©:', error);
                showErrorMessage('‚ùå Erreur lors du chargement');
                return null;
            }
        }

        // Fonctions d'affichage
        function displayAffiches(affiches) {
            console.log('üéØ displayAffiches appel√©e avec:', affiches.length, 'affiches');
            
            window.lastLoadedAffiches = affiches;
            
            updateDashboardStats(affiches);
            updateDashboardAffiches(affiches);
            updateAffichesTab(affiches);
            updatePlanningTab(affiches);
        }

        // Mettre √† jour les statistiques du dashboard
        function updateDashboardStats(affiches) {
            const stats = {
                enDiffusion: affiches.filter(a => a.statut === 'en-diffusion').length,
                aCreer: affiches.filter(a => a.statut === 'a-creer').length,
                programmees: affiches.filter(a => a.statut === 'programmee').length,
                archivees: affiches.filter(a => a.statut === 'archivee').length
            };
            
            const statCards = document.querySelectorAll('.stat-card h3');
            if (statCards.length >= 4) {
                statCards[0].textContent = stats.enDiffusion;
                statCards[1].textContent = stats.aCreer;
                statCards[2].textContent = stats.programmees;
                statCards[3].textContent = stats.archivees;
            }
        }

        // Mettre √† jour les affiches en diffusion sur le dashboard
        function updateDashboardAffiches(affiches) {
            const affichesEnDiffusion = affiches.filter(a => a.statut === 'en-diffusion').slice(0, 5);
            const container = document.querySelector('.recent-items');
            
            if (container) {
                if (affichesEnDiffusion.length === 0) {
                    container.innerHTML = `
                        <h3>üì∫ Affiches en diffusion</h3>
                        <div class="empty-state">
                            Aucune affiche en diffusion pour le moment
                        </div>
                    `;
                    return;
                }

                const itemsHtml = affichesEnDiffusion.map(affiche => {
                    const iconClass = getFamilleIconClass(affiche.famille);
                    const icon = getFamilleIcon(affiche.famille);
                    const dateExpiration = formatDate(affiche.dateFin);
                    
                    return `
                        <div class="item">
                            <div class="item-icon ${iconClass}">${icon}</div>
                            <div class="item-info">
                                <h4>${affiche.libelle}</h4>
                                <p>${affiche.prix}‚Ç¨/${affiche.unite} ‚Ä¢ ${affiche.origine} ‚Ä¢ Expire le ${dateExpiration}</p>
                            </div>
                            <span class="status-badge status-en-diffusion">En diffusion</span>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <h3>üì∫ Affiches en diffusion</h3>
                    ${itemsHtml}
                `;
            }
        }

        // Mettre √† jour l'onglet Affiches
        function updateAffichesTab(affiches) {
            const container = document.querySelector('#affiches');
            if (!container) return;
            
            const searchBar = container.querySelector('.search-bar');
            const filterSection = container.querySelector('.filter-section');
            
            if (affiches.length === 0) {
                container.innerHTML = '';
                if (searchBar) container.appendChild(searchBar);
                if (filterSection) container.appendChild(filterSection);
                container.insertAdjacentHTML('beforeend', `
                    <div class="empty-state">
                        Aucune affiche cr√©√©e pour le moment.<br>
                        Cliquez sur le bouton + pour cr√©er votre premi√®re affiche !
                    </div>
                `);
                return;
            }
            
            const affichesHtml = affiches.map(affiche => {
                const iconClass = getFamilleIconClass(affiche.famille);
                const icon = getFamilleIcon(affiche.famille);
                const statusClass = getStatusClass(affiche.statut);
                const statusText = getStatusText(affiche.statut);
                const dateDebut = formatDate(affiche.dateDebut);
                const dateFin = formatDate(affiche.dateFin);
                
                return `
                    <div class="item" data-status="${affiche.statut}">
                        <div class="item-icon ${iconClass}">${icon}</div>
                        <div class="item-info">
                            <h4>${affiche.libelle}</h4>
                            <p>${affiche.prix}‚Ç¨/${affiche.unite} ‚Ä¢ ${affiche.origine}</p>
                            <p class="item-dates">${dateDebut} ‚Üí ${dateFin}</p>
                        </div>
                        <div class="item-actions">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <div class="item-actions-buttons">
                                <button class="action-btn edit-btn" onclick="editAffiche('${affiche.id}')">‚úèÔ∏è</button>
                                <button class="action-btn delete-btn" onclick="confirmDeleteAffiche('${affiche.id}', '${affiche.libelle}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = '';
            if (searchBar) container.appendChild(searchBar);
            if (filterSection) container.appendChild(filterSection);
            container.insertAdjacentHTML('beforeend', affichesHtml);
            
            setTimeout(() => {
                setupFilters();
                setupSearch();
            }, 50);
        }

        // Fonctions utilitaires (supprim√©es car d√©plac√©es plus haut)
        
        // Messages toast
        function showErrorMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ff4444;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Exposer les fonctions globalement
        window.loginUser = loginUser;
        window.logoutUser = logoutUser;
        window.saveAffiche = saveAffiche;
        window.updateAffiche = updateAffiche;
        window.deleteAffiche = deleteAffiche;
        window.loadAfficheForEdit = loadAfficheForEdit;
        window.saveOrigine = saveOrigine;
        window.updateOrigine = updateOrigine;
        window.deleteOrigine = deleteOrigine;
        window.loadOrigineForEdit = loadOrigineForEdit;
        window.saveUnite = saveUnite;
        window.updateUnite = updateUnite;
        window.deleteUnite = deleteUnite;
        window.loadUniteForEdit = loadUniteForEdit;
        window.showErrorMessage = showErrorMessage;
        window.showSuccessMessage = showSuccessMessage;
        window.getFamilleIconClass = getFamilleIconClass;
        window.getFamilleIcon = getFamilleIcon;
        window.getStatusClass = getStatusClass;
        window.getStatusText = getStatusText;
        window.formatDate = formatDate;
    </script>

    <script>
        // Variables globales pour le planning
        window.lastLoadedAffiches = [];
        let currentWeekStart = new Date(2025, 6, 8);

        // ========= FONCTIONS UTILITAIRES (d√©finies en premier) =========
        
        function getFamilleIconClass(famille) {
            const mapping = {
                'fruits-legumes': 'category-fruits',
                'traiteur': 'category-traiteur',
                'boucherie': 'category-boucherie',
                'cremerie': 'category-cremerie',
                'epicerie': 'category-epicerie',
                'boulangerie': 'category-boulangerie',
                'autre': 'category-autre'
            };
            return mapping[famille] || 'category-autre';
        }

        function getFamilleIcon(famille) {
            const mapping = {
                'fruits-legumes': 'üçé',
                'traiteur': 'ü•ò',
                'boucherie': 'ü•©',
                'cremerie': 'üßÄ',
                'epicerie': 'üõí',
                'boulangerie': 'ü•ñ',
                'autre': 'üì¶'
            };
            return mapping[famille] || 'üì¶';
        }

        function getStatusClass(statut) {
            return `status-${statut}`;
        }

        function getStatusText(statut) {
            const mapping = {
                'a-creer': '√Ä cr√©er',
                'programmee': 'Programm√©e',
                'en-diffusion': 'En diffusion',
                'archivee': 'Archiv√©e'
            };
            return mapping[statut] || 'Inconnu';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit'
            });
        }

        // ========= FONCTIONS DE L'INTERFACE =========
        
        function showTab(tabName) {
            console.log('üîÑ Changement vers onglet:', tabName);
            
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.tab').classList.add('active');
            
            if (tabName === 'planning') {
                console.log('üìÖ Initialisation onglet Planning...');
                setTimeout(updateWeekHeader, 50);
                
                if (window.lastLoadedAffiches && window.lastLoadedAffiches.length > 0) {
                    console.log('üîÑ Forcer mise √† jour planning avec donn√©es existantes:', window.lastLoadedAffiches.length, 'affiches');
                    updatePlanningTab(window.lastLoadedAffiches);
                }
            }
        }

        function showParamsTab(tabName) {
            const contents = document.querySelectorAll('.params-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.params-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + '-params').classList.add('active');
            event.target.closest('.params-tab').classList.add('active');
        }

        // ========= MODALS AFFICHES =========
        
        function openModal() {
            document.getElementById('createModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        async function editAffiche(id) {
            const affiche = await window.loadAfficheForEdit(id);
            if (!affiche) return;
            
            document.getElementById('editAfficheId').value = affiche.id;
            document.getElementById('editLibelle').value = affiche.libelle || '';
            document.getElementById('editFamille').value = affiche.famille || '';
            document.getElementById('editPrix').value = affiche.prix || '';
            document.getElementById('editUnite').value = affiche.unite || '';
            document.getElementById('editOrigine').value = affiche.origine || '';
            document.getElementById('editStatut').value = affiche.statut || 'a-creer';
            
            if (affiche.dateDebut) {
                const dateDebut = new Date(affiche.dateDebut);
                document.getElementById('editDateDebut').value = dateDebut.toISOString().split('T')[0];
            }
            if (affiche.dateFin) {
                const dateFin = new Date(affiche.dateFin);
                document.getElementById('editDateFin').value = dateFin.toISOString().split('T')[0];
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            window.currentEditingAffiche = null;
        }

        function confirmDeleteAffiche(id, libelle) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'affiche :\n"${libelle}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteAffiche(id);
            }
        }

        // ========= MODALS ORIGINES =========
        
        function openAddOriginModal() {
            document.getElementById('addOriginModal').style.display = 'block';
        }

        function closeAddOriginModal() {
            document.getElementById('addOriginModal').style.display = 'none';
        }

        async function editOrigine(id) {
            const origine = await window.loadOrigineForEdit(id);
            if (!origine) return;
            
            document.getElementById('editOriginId').value = origine.id;
            document.getElementById('editOrigineName').value = origine.nom || '';
            
            document.getElementById('editOriginModal').style.display = 'block';
        }

        function closeEditOriginModal() {
            document.getElementById('editOriginModal').style.display = 'none';
            window.currentEditingOrigine = null;
        }

        function confirmDeleteOrigine(id, nom) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'origine :\n"${nom}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteOrigine(id);
            }
        }

        // ========= MODALS UNITES =========
        
        function openAddUniteModal() {
            document.getElementById('addUniteModal').style.display = 'block';
        }

        function closeAddUniteModal() {
            document.getElementById('addUniteModal').style.display = 'none';
        }

        async function editUnite(id) {
            const unite = await window.loadUniteForEdit(id);
            if (!unite) return;
            
            document.getElementById('editUniteId').value = unite.id;
            document.getElementById('editUniteName').value = unite.nom || '';
            
            document.getElementById('editUniteModal').style.display = 'block';
        }

        function closeEditUniteModal() {
            document.getElementById('editUniteModal').style.display = 'none';
            window.currentEditingUnite = null;
        }

        function confirmDeleteUnite(id, nom) {
            if (confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'unit√© :\n"${nom}" ?\n\nCette action est irr√©versible.`)) {
                window.deleteUnite(id);
            }
        }

        // ========= PLANNING =========
        
        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            updateWeekHeader();
            
            if (window.lastLoadedAffiches && window.lastLoadedAffiches.length > 0) {
                console.log('üîÑ Mise √† jour planning apr√®s changement de semaine');
                updatePlanningTab(window.lastLoadedAffiches);
            }
        }

        function updateWeekHeader() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const months = [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ];
            
            const startDay = currentWeekStart.getDate();
            const endDay = weekEnd.getDate();
            const month = months[currentWeekStart.getMonth()];
            const year = currentWeekStart.getFullYear();
            
            const weekNumber = getWeekNumber(currentWeekStart);
            const weekRange = `${startDay} - ${endDay} ${month} ${year}`;
            
            const currentWeekElement = document.getElementById('currentWeek');
            const weekNumberElement = document.getElementById('weekNumber');
            
            if (currentWeekElement) {
                currentWeekElement.textContent = weekRange;
            }
            
            if (weekNumberElement) {
                weekNumberElement.textContent = `Semaine ${weekNumber}`;
            }
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function updatePlanningTab(affiches) {
            console.log('üìÖ updatePlanningTab appel√©e avec:', affiches);
            
            const container = document.querySelector('#planningAffiches');
            if (!container) {
                console.log('‚ùå Container #planningAffiches non trouv√©');
                return;
            }
            
            const affichesPlanning = affiches.filter(a => {
                if (a.statut === 'archivee') {
                    return false;
                }
                return isAfficheActiveInWeek(a, currentWeekStart);
            });
            
            console.log('üìÖ Planning - Affiches filtr√©es pour cette semaine:', affichesPlanning);
            
            if (affichesPlanning.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        Aucune affiche active pour cette semaine
                    </div>
                `;
                return;
            }
            
            const planningHtml = affichesPlanning.map(affiche => {
                const iconClass = getFamilleIconClass(affiche.famille);
                const icon = getFamilleIcon(affiche.famille);
                const statusClass = `status-${affiche.statut}`;
                const statusText = getStatusText(affiche.statut);
                const dateDebut = formatDate(affiche.dateDebut);
                const dateFin = formatDate(affiche.dateFin);
                
                return `
                    <div class="planning-item ${statusClass}">
                        <div class="planning-item-icon ${iconClass}">${icon}</div>
                        <div class="planning-item-info">
                            <h4>${affiche.libelle}</h4>
                            <p>${affiche.prix}‚Ç¨/${affiche.unite} ‚Ä¢ ${affiche.origine}</p>
                            <p class="item-dates">${dateDebut} ‚Üí ${dateFin}</p>
                        </div>
                        <div class="planning-item-actions">
                            <span class="planning-status-badge ${statusClass}">${statusText}</span>
                            <div class="planning-item-actions-buttons">
                                <button class="action-btn edit-btn" onclick="editAffiche('${affiche.id}')">‚úèÔ∏è</button>
                                <button class="action-btn delete-btn" onclick="confirmDeleteAffiche('${affiche.id}', '${affiche.libelle}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = planningHtml;
        }

        function isAfficheActiveInWeek(affiche, weekStart) {
            if (!affiche.dateDebut || !affiche.dateFin) {
                return false;
            }
            
            const afficheDebut = new Date(affiche.dateDebut);
            const afficheFin = new Date(affiche.dateFin);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            afficheDebut.setHours(0, 0, 0, 0);
            afficheFin.setHours(23, 59, 59, 999);
            weekStart.setHours(0, 0, 0, 0);
            weekEnd.setHours(23, 59, 59, 999);
            
            return afficheDebut <= weekEnd && afficheFin >= weekStart;
        }

        // ========= RECHERCHE ET FILTRES =========
        
        function setupSearch() {
            const affichesSearch = document.querySelector('#affiches .search-bar input');
            if (affichesSearch) {
                affichesSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const items = document.querySelectorAll('#affiches .item');
                    
                    items.forEach(item => {
                        const title = item.querySelector('h4').textContent.toLowerCase();
                        const description = item.querySelector('p').textContent.toLowerCase();
                        
                        if (title.includes(searchTerm) || description.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn-affiches').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filterValue = this.dataset.filter;
                    filterAffiches(filterValue);
                });
            });
        }

        function filterAffiches(status) {
            const items = document.querySelectorAll('#affiches .item');
            const filterBtns = document.querySelectorAll('.filter-btn-affiches');
            
            filterBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-btn-affiches[data-filter="${status}"]`).classList.add('active');
            
            items.forEach(item => {
                if (status === 'all' || item.dataset.status === status) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // Fermer modals en cliquant dehors
        window.onclick = function(event) {
            const modals = [
                'createModal', 'editModal', 'addOriginModal', 'editOriginModal',
                'addUniteModal', 'editUniteModal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // ========= EVENT LISTENERS =========
        
        document.addEventListener('DOMContentLoaded', function() {
            // D√©finir les dates par d√©faut
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            const dateDebutInput = document.getElementById('dateDebut');
            const dateFinInput = document.getElementById('dateFin');
            
            if (dateDebutInput) dateDebutInput.valueAsDate = today;
            if (dateFinInput) dateFinInput.valueAsDate = nextWeek;

            // Event listener pour la connexion
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                window.loginUser();
            });

            // Event listener pour cr√©ation d'affiche
            document.getElementById('createForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                // G√©rer les valeurs "autre" pour origine et unit√©
                let origine = formData.get('origine');
                let unite = formData.get('unite');
                
                if (origine === 'autre') {
                    origine = prompt('Entrez le nom de la nouvelle origine:');
                    if (!origine) return;
                    
                    // Sauvegarder la nouvelle origine
                    try {
                        await window.saveOrigine({ nom: origine });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'origine');
                        return;
                    }
                }
                
                if (unite === 'autre') {
                    unite = prompt('Entrez le nom de la nouvelle unit√©:');
                    if (!unite) return;
                    
                    // Sauvegarder la nouvelle unit√©
                    try {
                        await window.saveUnite({ nom: unite });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'unit√©');
                        return;
                    }
                }
                
                const affiche = {
                    libelle: formData.get('libelle'),
                    famille: formData.get('famille'),
                    dateDebut: formData.get('dateDebut'),
                    dateFin: formData.get('dateFin'),
                    prix: parseFloat(formData.get('prix')),
                    unite: unite,
                    origine: origine,
                    statut: 'a-creer'
                };
                
                try {
                    await window.saveAffiche(affiche);
                    window.showSuccessMessage('üéâ Affiche cr√©√©e avec succ√®s!');
                    closeModal();
                    this.reset();
                    
                    // Remettre les dates par d√©faut
                    const today = new Date();
                    const nextWeek = new Date();
                    nextWeek.setDate(today.getDate() + 7);
                    document.getElementById('dateDebut').valueAsDate = today;
                    document.getElementById('dateFin').valueAsDate = nextWeek;
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la cr√©ation: ' + error.message);
                }
            });

            // Event listener pour modification d'affiche
            document.getElementById('editForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const afficheId = formData.get('editAfficheId');
                
                // G√©rer les valeurs "autre" pour origine et unit√©
                let origine = formData.get('editOrigine');
                let unite = formData.get('editUnite');
                
                if (origine === 'autre') {
                    origine = prompt('Entrez le nom de la nouvelle origine:');
                    if (!origine) return;
                    
                    try {
                        await window.saveOrigine({ nom: origine });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'origine');
                        return;
                    }
                }
                
                if (unite === 'autre') {
                    unite = prompt('Entrez le nom de la nouvelle unit√©:');
                    if (!unite) return;
                    
                    try {
                        await window.saveUnite({ nom: unite });
                    } catch (error) {
                        window.showErrorMessage('‚ùå Erreur lors de l\'ajout de l\'unit√©');
                        return;
                    }
                }
                
                const updatedData = {
                    libelle: formData.get('editLibelle'),
                    famille: formData.get('editFamille'),
                    dateDebut: formData.get('editDateDebut'),
                    dateFin: formData.get('editDateFin'),
                    prix: parseFloat(formData.get('editPrix')),
                    unite: unite,
                    origine: origine,
                    statut: formData.get('editStatut')
                };
                
                try {
                    await window.updateAffiche(afficheId, updatedData);
                    closeEditModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listener pour ajout d'origine
            document.getElementById('addOriginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const origine = {
                    nom: formData.get('origineName').trim()
                };
                
                // V√©rifier les doublons
                if (window.origines.some(o => o.nom.toLowerCase() === origine.nom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette origine existe d√©j√†');
                    return;
                }
                
                try {
                    await window.saveOrigine(origine);
                    window.showSuccessMessage(`üéâ Origine "${origine.nom}" ajout√©e avec succ√®s!`);
                    closeAddOriginModal();
                    this.reset();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de l\'ajout: ' + error.message);
                }
            });

            // Event listener pour modification d'origine
            document.getElementById('editOriginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const origineId = formData.get('editOriginId');
                const nouveauNom = formData.get('editOrigineName').trim();
                
                // V√©rifier les doublons (exclure l'origine actuelle)
                if (window.origines.some(o => o.id !== origineId && o.nom.toLowerCase() === nouveauNom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette origine existe d√©j√†');
                    return;
                }
                
                const updatedData = {
                    nom: nouveauNom
                };
                
                try {
                    await window.updateOrigine(origineId, updatedData);
                    closeEditOriginModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });

            // Event listener pour ajout d'unit√©
            document.getElementById('addUniteForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const unite = {
                    nom: formData.get('uniteName').trim()
                };
                
                // V√©rifier les doublons
                if (window.unites.some(u => u.nom.toLowerCase() === unite.nom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette unit√© existe d√©j√†');
                    return;
                }
                
                try {
                    await window.saveUnite(unite);
                    window.showSuccessMessage(`üéâ Unit√© "${unite.nom}" ajout√©e avec succ√®s!`);
                    closeAddUniteModal();
                    this.reset();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de l\'ajout: ' + error.message);
                }
            });

            // Event listener pour modification d'unit√©
            document.getElementById('editUniteForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const uniteId = formData.get('editUniteId');
                const nouveauNom = formData.get('editUniteName').trim();
                
                // V√©rifier les doublons (exclure l'unit√© actuelle)
                if (window.unites.some(u => u.id !== uniteId && u.nom.toLowerCase() === nouveauNom.toLowerCase())) {
                    window.showErrorMessage('‚ùå Cette unit√© existe d√©j√†');
                    return;
                }
                
                const updatedData = {
                    nom: nouveauNom
                };
                
                try {
                    await window.updateUnite(uniteId, updatedData);
                    closeEditUniteModal();
                } catch (error) {
                    window.showErrorMessage('‚ùå Erreur lors de la modification: ' + error.message);
                }
            });
        });

        // Exposer les fonctions n√©cessaires globalement
        window.showTab = showTab;
        window.showParamsTab = showParamsTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.editAffiche = editAffiche;
        window.closeEditModal = closeEditModal;
        window.confirmDeleteAffiche = confirmDeleteAffiche;
        window.openAddOriginModal = openAddOriginModal;
        window.closeAddOriginModal = closeAddOriginModal;
        window.editOrigine = editOrigine;
        window.closeEditOriginModal = closeEditOriginModal;
        window.confirmDeleteOrigine = confirmDeleteOrigine;
        window.openAddUniteModal = openAddUniteModal;
        window.closeAddUniteModal = closeAddUniteModal;
        window.editUnite = editUnite;
        window.closeEditUniteModal = closeEditUniteModal;
        window.confirmDeleteUnite = confirmDeleteUnite;
        window.changeWeek = changeWeek;
        window.updateWeekHeader = updateWeekHeader;
        window.updatePlanningTab = updatePlanningTab;
        window.getFamilleIconClass = getFamilleIconClass;
        window.getFamilleIcon = getFamilleIcon;
        window.getStatusClass = getStatusClass;
        window.getStatusText = getStatusText;
        window.formatDate = formatDate;
    </script>
</body>
</html>
